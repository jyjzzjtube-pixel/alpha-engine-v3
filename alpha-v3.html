<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#06080c">
<title>ALPHA ENGINE v3</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--tx);font-family:'Outfit',sans-serif;font-size:14px;overflow-x:hidden;min-height:100dvh;transition:background .3s,color .3s}
:root{--bg:#06080c;--bg2:rgba(255,255,255,.025);--bg3:rgba(255,255,255,.04);--bd:rgba(255,255,255,.05);--tx:#e4e6e9;--tx2:rgba(255,255,255,.35);--tx3:rgba(255,255,255,.25);--gn:#00E676;--rd:#FF1744;--yl:#FFD600;--or:#FF6D00;--cl:#9333EA;--gm:#4285F4;--gpt:#10A37F;--px:#22C55E;--acc:linear-gradient(135deg,#00E676,#00BCD4)}
.light{--bg:#f4f5f7;--bg2:rgba(0,0,0,.025);--bg3:rgba(0,0,0,.05);--bd:rgba(0,0,0,.08);--tx:#1a1a2e;--tx2:rgba(0,0,0,.45);--tx3:rgba(0,0,0,.3)}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-thumb{background:rgba(128,128,128,.15);border-radius:2px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideUp{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
input::placeholder{color:var(--tx3)}input,button,select{font-family:inherit}

.hd{padding:12px 16px 8px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(0,230,118,.04),transparent);border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:100;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
.logo{font-size:17px;font-weight:900;letter-spacing:-.5px;background:var(--acc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.lv{font-size:9px;color:var(--tx3);display:flex;align-items:center;gap:4px}
.dt{width:5px;height:5px;border-radius:50%;background:var(--gn);animation:pulse 2s infinite;display:inline-block}
.bd0{padding:10px 12px 76px;max-width:430px;margin:0 auto}
.nv{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;display:flex;background:rgba(6,8,12,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--bd);z-index:200;padding:3px 0 max(6px,env(safe-area-inset-bottom))}
.light .nv{background:rgba(244,245,247,.97)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;cursor:pointer;gap:0;color:var(--tx3);font-size:7.5px;font-weight:600;border-top:2px solid transparent;transition:all .15s}
.ni.a{color:var(--gn);border-top-color:var(--gn)}
.ni .ic{font-size:16px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:9px}
.sc{background:var(--bg2);border:1px solid var(--bd);border-radius:11px;padding:10px}
.sc.sp{grid-column:1/-1}
.lb{font-size:9px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
.big{font-size:20px;font-weight:900;letter-spacing:-.5px}
.sm{font-size:10px;color:var(--tx2);margin-top:2px}
.g{color:var(--gn)}.r{color:var(--rd)}.y{color:var(--yl)}.o{color:var(--or)}
.cd{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:9px;animation:slideUp .25s ease}
.ct{font-size:9px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.rw{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--bd)}
.rw:last-child{border-bottom:none}
.rn{font-weight:700;font-size:12.5px}.rs{font-size:9.5px;color:var(--tx3)}
.bd2{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:800}
.bg{background:rgba(0,230,118,.12);color:#00E676;border:1px solid rgba(0,230,118,.2)}
.br{background:rgba(255,23,68,.12);color:#FF1744;border:1px solid rgba(255,23,68,.2)}
.by{background:rgba(255,214,0,.12);color:#FFD600;border:1px solid rgba(255,214,0,.2)}
.bx{background:rgba(128,128,128,.08);color:var(--tx3);border:1px solid rgba(128,128,128,.12)}
.pl{padding:4px 11px;border-radius:18px;font-size:10.5px;font-weight:700;cursor:pointer;background:var(--bg2);color:var(--tx3);border:1px solid var(--bd);display:inline-block}
.pl.a{background:rgba(0,230,118,.12);color:var(--gn);border-color:rgba(0,230,118,.2)}
.sb{padding:3px 8px;border-radius:4px;font-size:9.5px;font-weight:700;cursor:pointer;background:transparent;color:var(--tx3);border:none}
.sb.a{background:rgba(0,176,255,.12);color:#00B0FF}
.dc{border:1px solid rgba(0,230,118,.2)!important}
.ds{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:5px;margin-top:8px;text-align:center}
.ds .dl{font-size:8px;color:var(--tx3);margin-bottom:1px}.ds .dv{font-size:12px;font-weight:800}
.ab{display:flex;border-radius:5px;overflow:hidden;height:18px}
.as{display:flex;align-items:center;justify-content:center;font-size:7px;font-weight:700;overflow:hidden}
.vd{font-size:10px;padding:4px 7px;background:var(--bg2);border-radius:5px;font-weight:600}
.cb{height:280px;overflow-y:auto;padding:8px;background:rgba(0,0,0,.15);border-radius:9px;margin-bottom:8px}
.light .cb{background:rgba(0,0,0,.03)}
.ce{color:var(--tx3);text-align:center;padding:30px 8px;font-size:11px;line-height:2;opacity:.5}
.mg{padding:8px 10px;margin-bottom:6px;max-width:92%;white-space:pre-wrap;font-size:11.5px;line-height:1.55;border-radius:10px}
.mu{margin-left:auto;background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.1);border-radius:10px 10px 3px 10px}
.mc{background:rgba(147,51,234,.07);border:1px solid rgba(147,51,234,.12);border-radius:10px 10px 10px 3px}
.mg2{background:rgba(66,133,244,.07);border:1px solid rgba(66,133,244,.12);border-radius:10px 10px 10px 3px}
.mgpt{background:rgba(16,163,127,.07);border:1px solid rgba(16,163,127,.12);border-radius:10px 10px 10px 3px}
.mpx{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.12);border-radius:10px 10px 10px 3px}
.mv{background:rgba(255,214,0,.05);border:1px solid rgba(255,214,0,.15);border-radius:10px 10px 10px 3px}
.ms{background:var(--bg2);border:1px solid var(--bd);border-radius:10px 10px 10px 3px}
.tg{font-size:8px;font-weight:800;margin-bottom:2px}
.ai-in{flex:1;padding:10px 12px;border-radius:9px;border:1px solid var(--bd);background:rgba(0,0,0,.2);color:var(--tx);font-size:13px;outline:none}
.light .ai-in{background:rgba(0,0,0,.04)}
.ai-s{padding:10px 14px;border-radius:9px;border:none;background:var(--acc);color:#000;font-weight:800;font-size:14px;cursor:pointer;min-width:44px}
.qc{padding:5px 10px;border-radius:18px;font-size:10px;font-weight:600;background:var(--bg2);color:var(--tx2);border:1px solid var(--bd);cursor:pointer;white-space:nowrap;display:inline-block}
.mp{padding:5px 12px;border-radius:18px;font-size:10px;font-weight:700;cursor:pointer;display:inline-block;border:1px solid var(--bd)}
.si{width:100%;padding:9px 10px;border-radius:7px;border:1px solid var(--bd);background:rgba(0,0,0,.15);color:var(--tx);font-size:12px;outline:none;margin-bottom:6px;font-family:monospace}
.light .si{background:rgba(0,0,0,.03)}
.sv{padding:7px 14px;border-radius:7px;border:none;background:var(--acc);color:#000;font-weight:700;font-size:11px;cursor:pointer}
.std{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:5px}
.std-g{background:#00E676}.std-r{background:#FF1744}.std-o{background:#FF6D00}
.ld{display:inline-block;width:18px;height:18px;border:2px solid var(--bd);border-top-color:var(--gn);border-radius:50%;animation:spin .8s linear infinite}
.tgl{position:relative;width:40px;height:22px;display:inline-block;cursor:pointer;vertical-align:middle}
.tgl input{opacity:0;width:0;height:0}
.tgl .sl{position:absolute;inset:0;background:rgba(128,128,128,.25);border-radius:11px;transition:.25s}
.tgl .sl:before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.25s}
.tgl input:checked+.sl{background:var(--gn)}
.tgl input:checked+.sl:before{transform:translateX(18px)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:flex;align-items:flex-end;justify-content:center}
.modal-c{width:100%;max-width:430px;background:var(--bg);border-radius:14px 14px 0 0;padding:18px;max-height:65vh;overflow-y:auto}
.light .modal-c{background:#fff}
svg{display:block}
.candle-g{fill:#00E676;stroke:#00E676}.candle-r{fill:#FF1744;stroke:#FF1744}

/* API Card */
.api-card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:10px}
.api-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;flex-shrink:0}
.api-info{flex:1;min-width:0}
.api-name{font-size:12px;font-weight:800}
.api-desc{font-size:9px;color:var(--tx3);margin-top:1px}
.api-status{font-size:8px;font-weight:700;margin-top:2px;display:flex;align-items:center;gap:3px}

/* AI Response Card */
.ai-card{background:var(--bg2);border-radius:10px;padding:10px 12px;margin:6px 0;border:1px solid var(--bd)}
.ai-card .ai-target{font-size:14px;font-weight:900;margin-bottom:4px}
.ai-card .ai-action{font-size:13px;font-weight:800;margin-bottom:3px}
.ai-card .ai-price{font-size:11px;color:var(--tx2);margin-bottom:2px}
.ai-card .ai-reason{font-size:11px;color:var(--yl)}
.ai-card.buy-card{border-color:rgba(0,230,118,.25);background:rgba(0,230,118,.04)}
.ai-card.sell-card{border-color:rgba(255,23,68,.25);background:rgba(255,23,68,.04)}
.ai-card.wait-card{border-color:rgba(255,214,0,.25);background:rgba(255,214,0,.04)}
</style>
</head>
<body>
<div class="hd"><div class="logo">âš¡ ALPHA v3</div><div class="lv"><span class="dt"></span>LIVE <span id="clk"></span></div></div>
<div class="bd0" id="ct"></div>
<div class="nv" id="nv"></div>
<div id="modal"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const CFG={TAX_KR:.0023,FEE_KR:.00015,FEE_US:.0007,EXCHANGE:1380,SL:-3,TP:5};

// API definitions
const APIS={
  claude:{id:'claude',name:'Claude',desc:'Anthropic ë§¤ë§¤ ë¶„ì„',icon:'ğŸŸ£',color:'#9333EA',bg:'rgba(147,51,234,',model:'claude-sonnet-4-20250514'},
  gemini:{id:'gemini',name:'Gemini',desc:'Google ë§¤ë§¤ ë¶„ì„',icon:'ğŸ”µ',color:'#4285F4',bg:'rgba(66,133,244,',model:'gemini-2.0-flash'},
  gpt:{id:'gpt',name:'GPT',desc:'OpenAI êµì°¨ê²€ì¦',icon:'ğŸŸ¢',color:'#10A37F',bg:'rgba(16,163,127,',model:'gpt-4o-mini'},
  perplexity:{id:'perplexity',name:'Perplexity',desc:'ì‹¤ì‹œê°„ ë‰´ìŠ¤',icon:'ğŸ”',color:'#22C55E',bg:'rgba(34,197,94,',model:'sonar'},
  kis:{id:'kis',name:'í•œêµ­íˆ¬ìì¦ê¶Œ',desc:'ì‹¤ì‹œê°„ í•œêµ­ ì£¼ê°€',icon:'ğŸ‡°ğŸ‡·',color:'#FF6D00',bg:'rgba(255,109,0,',model:''},
  alphav:{id:'alphav',name:'Alpha Vantage',desc:'ë¯¸êµ­ ì£¼ê°€ ë°ì´í„°',icon:'ğŸ‡ºğŸ‡¸',color:'#00B0FF',bg:'rgba(0,176,255,',model:''},
};

const TABS=[{id:'home',ic:'ğŸ“Š',lb:'í™ˆ'},{id:'scan',ic:'ğŸ”',lb:'ìŠ¤ìº”'},{id:'port',ic:'ğŸ’¼',lb:'í¬í´'},{id:'bt',ic:'ğŸ“ˆ',lb:'ë°±í…Œ'},{id:'log',ic:'ğŸ“‹',lb:'ê¸°ë¡'},{id:'ai',ic:'âš¡',lb:'ëª…ë ¹'},{id:'set',ic:'âš™ï¸',lb:'ì„¤ì •'}];

// ============================================================
// ì‹ í˜¸ë¥¼ ì‰¬ìš´ ë§ë¡œ ë³€í™˜í•˜ëŠ” ë§¤í•‘
// ============================================================
const SIG_EASY={
  'ê°•ë ¥ë§¤ìˆ˜':'ğŸŸ¢ ì§€ê¸ˆ ì‚¬ì„¸ìš”!',
  'ë§¤ìˆ˜':'ğŸŸ¢ ì‚¬ë„ ì¢‹ì•„ìš”',
  'ìƒìŠ¹':'ğŸŸ¢ ì˜¤ë¥´ëŠ” ì¤‘',
  'ê´€ë§':'ğŸŸ¡ ê¸°ë‹¤ë¦¬ì„¸ìš”',
  'í•˜ë½':'ğŸ”´ ë–¨ì–´ì§€ëŠ” ì¤‘',
  'ë§¤ë„':'ğŸ”´ íŒŒì„¸ìš”',
  'ê°•ë ¥ë§¤ë„':'ğŸ”´ ì§€ê¸ˆ íŒŒì„¸ìš”!'
};
const SIG_COLOR={
  'ê°•ë ¥ë§¤ìˆ˜':'g','ë§¤ìˆ˜':'g','ìƒìŠ¹':'g',
  'ê´€ë§':'y',
  'í•˜ë½':'r','ë§¤ë„':'r','ê°•ë ¥ë§¤ë„':'r'
};

// ê¸°ìˆ ì  ê·¼ê±°ë¥¼ ì‰¬ìš´ ë§ë¡œ
const REASON_EASY={
  'RSIê³¼ë§¤ë„':'ë§ì´ ë–¨ì–´ì ¸ì„œ ì‹¸ìš”',
  'RSIì €ìœ„':'ì¢€ ì‹¸ì§„ í¸ì´ì—ìš”',
  'RSIê³¼ë§¤ìˆ˜':'ë„ˆë¬´ ì˜¬ë¼ì„œ ë¹„ì‹¸ìš”',
  'ê³¨ë“ í¬ë¡œìŠ¤':'ì˜¤ë¥´ëŠ” íë¦„ì´ì—ìš”',
  'ë°ë“œí¬ë¡œìŠ¤':'ë–¨ì–´ì§€ëŠ” íë¦„ì´ì—ìš”',
  'MACDâ†‘':'í˜ì´ ì˜¬ë¼ê°€ëŠ” ì¤‘',
  'MACDâ†“':'í˜ì´ ë¹ ì§€ëŠ” ì¤‘',
  'BBí•˜ë‹¨':'ë°”ë‹¥ ê·¼ì²˜ì—ìš”',
  'BBìƒë‹¨':'ê¼­ëŒ€ê¸° ê·¼ì²˜ì—ìš”',
  'ê±°ë˜ëŸ‰â†‘':'ì‚¬ëŒë“¤ì´ ë§ì´ ì‚¬ëŠ” ì¤‘',
  'ìŠ¤í† ìºâ†“':'ì‹¸ê²Œ ì‚´ ê¸°íšŒ',
  'ìŠ¤í† ìºâ†‘':'ë„ˆë¬´ ë§ì´ ì˜¬ëì–´ìš”'
};

// ============================================================
// STATE
// ============================================================
let S={
  tab:'home',fil:'all',sk:'chg',sd:'desc',sel:null,
  aiMsgs:[],aiMode:'multi',loading:false,
  keys:{claude:'',gemini:'',gpt:'',perplexity:'',kis:'',kis_secret:'',alphav:''},
  on:{claude:false,gemini:true,gpt:false,perplexity:false,kis:false,alphav:false},
  theme:'dark',
  portfolio:[
    {n:'ì‚¼ì„±ì „ì',c:'005930',m:'KR',qty:50,avg:72000,cc:'â‚©'},
    {n:'NVIDIA',c:'NVDA',m:'US',qty:10,avg:680,cc:'$'},
    {n:'ì—ì½”í”„ë¡œë¹„ì— ',c:'247540',m:'KR',qty:20,avg:185000,cc:'â‚©'},
    {n:'Apple',c:'AAPL',m:'US',qty:15,avg:195,cc:'$'},
    {n:'SKí•˜ì´ë‹‰ìŠ¤',c:'000660',m:'KR',qty:30,avg:168000,cc:'â‚©'},
  ],
  cash:15420000,tradeLog:[],alerts:[],showModal:null,btStrat:'golden',logFilter:'all'
};

try{const sv=JSON.parse(localStorage.getItem('alpha_v3'));if(sv){Object.keys(sv).forEach(k=>{if(S.hasOwnProperty(k))S[k]=sv[k];});}}catch(e){}
function save(){try{localStorage.setItem('alpha_v3',JSON.stringify(S));}catch(e){}}
if(S.theme==='light')document.body.classList.add('light');

// ============================================================
// STOCK DATA (fixed realistic 24ì¢…ëª©)
// ============================================================
const SD=[
  {c:'005930',n:'ì‚¼ì„±ì „ì',s:'ë°˜ë„ì²´',m:'KR',price:74800,prev:74200,vol:18500000,avgVol:15000000,rsi:55,ma5:74500,ma20:73200,ma60:72000,macd:.8,bb_u:76500,bb_l:71900,stoch:62},
  {c:'000660',n:'SKí•˜ì´ë‹‰ìŠ¤',s:'ë°˜ë„ì²´',m:'KR',price:182000,prev:178500,vol:8200000,avgVol:6500000,rsi:63,ma5:180000,ma20:175000,ma60:168000,macd:1.2,bb_u:188000,bb_l:172000,stoch:71},
  {c:'373220',n:'LGì—ë„ˆì§€ì†”ë£¨ì…˜',s:'2ì°¨ì „ì§€',m:'KR',price:368000,prev:372000,vol:1200000,avgVol:1500000,rsi:42,ma5:370000,ma20:375000,ma60:380000,macd:-.5,bb_u:385000,bb_l:360000,stoch:35},
  {c:'207940',n:'ì‚¼ì„±ë°”ì´ì˜¤',s:'ë°”ì´ì˜¤',m:'KR',price:892000,prev:885000,vol:320000,avgVol:280000,rsi:58,ma5:888000,ma20:880000,ma60:870000,macd:.3,bb_u:910000,bb_l:865000,stoch:55},
  {c:'005380',n:'í˜„ëŒ€ì°¨',s:'ìë™ì°¨',m:'KR',price:248000,prev:252000,vol:3100000,avgVol:2800000,rsi:38,ma5:251000,ma20:255000,ma60:258000,macd:-.7,bb_u:262000,bb_l:242000,stoch:28},
  {c:'006400',n:'ì‚¼ì„±SDI',s:'2ì°¨ì „ì§€',m:'KR',price:385000,prev:388000,vol:920000,avgVol:1100000,rsi:41,ma5:387000,ma20:392000,ma60:398000,macd:-.4,bb_u:400000,bb_l:378000,stoch:33},
  {c:'035420',n:'NAVER',s:'IT',m:'KR',price:218000,prev:215000,vol:2800000,avgVol:2200000,rsi:61,ma5:216000,ma20:212000,ma60:208000,macd:.6,bb_u:225000,bb_l:205000,stoch:65},
  {c:'035720',n:'ì¹´ì¹´ì˜¤',s:'IT',m:'KR',price:42500,prev:43200,vol:5600000,avgVol:4800000,rsi:35,ma5:43000,ma20:44500,ma60:46000,macd:-.9,bb_u:46000,bb_l:41000,stoch:22},
  {c:'051910',n:'LGí™”í•™',s:'í™”í•™',m:'KR',price:298000,prev:295000,vol:780000,avgVol:650000,rsi:52,ma5:296000,ma20:293000,ma60:290000,macd:.2,bb_u:305000,bb_l:285000,stoch:50},
  {c:'003670',n:'í¬ìŠ¤ì½”í“¨ì²˜ì— ',s:'2ì°¨ì „ì§€',m:'KR',price:215000,prev:218000,vol:1500000,avgVol:1800000,rsi:37,ma5:217000,ma20:222000,ma60:228000,macd:-.8,bb_u:228000,bb_l:210000,stoch:25},
  {c:'247540',n:'ì—ì½”í”„ë¡œë¹„ì— ',s:'2ì°¨ì „ì§€',m:'KR',price:172000,prev:175000,vol:2200000,avgVol:2500000,rsi:32,ma5:174000,ma20:180000,ma60:188000,macd:-1.1,bb_u:186000,bb_l:168000,stoch:18},
  {c:'068270',n:'ì…€íŠ¸ë¦¬ì˜¨',s:'ë°”ì´ì˜¤',m:'KR',price:178500,prev:176000,vol:2100000,avgVol:1900000,rsi:57,ma5:177000,ma20:174000,ma60:170000,macd:.5,bb_u:183000,bb_l:169000,stoch:60},
  {c:'012330',n:'í˜„ëŒ€ëª¨ë¹„ìŠ¤',s:'ìë™ì°¨ë¶€í’ˆ',m:'KR',price:228000,prev:230000,vol:520000,avgVol:480000,rsi:44,ma5:229000,ma20:232000,ma60:235000,macd:-.3,bb_u:236000,bb_l:224000,stoch:38},
  {c:'066570',n:'LGì „ì',s:'ê°€ì „',m:'KR',price:98500,prev:97000,vol:1800000,avgVol:1400000,rsi:59,ma5:97500,ma20:96000,ma60:94000,macd:.4,bb_u:101000,bb_l:93000,stoch:63},
  {c:'AAPL',n:'Apple',s:'Tech',m:'US',price:203,prev:200,vol:52e6,avgVol:48e6,rsi:62,ma5:201,ma20:198,ma60:192,macd:.7,bb_u:208,bb_l:193,stoch:67},
  {c:'NVDA',n:'NVIDIA',s:'AI/ë°˜ë„ì²´',m:'US',price:726,prev:718,vol:38e6,avgVol:42e6,rsi:68,ma5:720,ma20:705,ma60:680,macd:1.5,bb_u:750,bb_l:690,stoch:75},
  {c:'MSFT',n:'Microsoft',s:'Tech',m:'US',price:415,prev:412,vol:22e6,avgVol:20e6,rsi:58,ma5:413,ma20:408,ma60:400,macd:.4,bb_u:422,bb_l:398,stoch:58},
  {c:'GOOGL',n:'Alphabet',s:'Tech',m:'US',price:175,prev:173,vol:25e6,avgVol:23e6,rsi:56,ma5:174,ma20:171,ma60:166,macd:.3,bb_u:180,bb_l:165,stoch:55},
  {c:'AMZN',n:'Amazon',s:'E-comm',m:'US',price:198,prev:195,vol:35e6,avgVol:32e6,rsi:61,ma5:196,ma20:192,ma60:185,macd:.6,bb_u:205,bb_l:184,stoch:64},
  {c:'TSLA',n:'Tesla',s:'EV',m:'US',price:248,prev:255,vol:62e6,avgVol:58e6,rsi:39,ma5:252,ma20:260,ma60:268,macd:-1.2,bb_u:272,bb_l:240,stoch:26},
  {c:'META',n:'Meta',s:'Tech',m:'US',price:582,prev:578,vol:15e6,avgVol:14e6,rsi:60,ma5:580,ma20:572,ma60:560,macd:.5,bb_u:595,bb_l:562,stoch:62},
  {c:'AMD',n:'AMD',s:'ë°˜ë„ì²´',m:'US',price:168,prev:165,vol:42e6,avgVol:38e6,rsi:64,ma5:166,ma20:160,ma60:152,macd:.9,bb_u:175,bb_l:155,stoch:70},
  {c:'AVGO',n:'Broadcom',s:'ë°˜ë„ì²´',m:'US',price:1680,prev:1665,vol:32e5,avgVol:28e5,rsi:61,ma5:1670,ma20:1640,ma60:1600,macd:.6,bb_u:1720,bb_l:1620,stoch:63},
  {c:'TSM',n:'TSMC',s:'ë°˜ë„ì²´',m:'US',price:178,prev:175,vol:18e6,avgVol:16e6,rsi:63,ma5:176,ma20:172,ma60:165,macd:.7,bb_u:184,bb_l:166,stoch:66},
];

let stocks=[];
function processStocks(){
  stocks=SD.map(st=>{
    const chg=((st.price-st.prev)/st.prev*100).toFixed(2),vr=(st.vol/st.avgVol).toFixed(1),cur=st.m==='KR'?'â‚©':'$';
    let score=0,reasons=[];
    if(st.rsi<30){score+=2;reasons.push('RSIê³¼ë§¤ë„');}else if(st.rsi<40){score+=1;reasons.push('RSIì €ìœ„');}else if(st.rsi>70){score-=2;reasons.push('RSIê³¼ë§¤ìˆ˜');}
    if(st.price>st.ma5&&st.ma5>st.ma20){score+=1.5;reasons.push('ê³¨ë“ í¬ë¡œìŠ¤');}
    if(st.price<st.ma5&&st.ma5<st.ma20){score-=1.5;reasons.push('ë°ë“œí¬ë¡œìŠ¤');}
    if(st.macd>.5){score+=1;reasons.push('MACDâ†‘');}if(st.macd<-.5){score-=1;reasons.push('MACDâ†“');}
    if(st.price<=st.bb_l*1.01){score+=1.5;reasons.push('BBí•˜ë‹¨');}if(st.price>=st.bb_u*.99){score-=1;reasons.push('BBìƒë‹¨');}
    if(+vr>2&&+chg>0){score+=1;reasons.push('ê±°ë˜ëŸ‰â†‘');}
    if(st.stoch<20){score+=1;reasons.push('ìŠ¤í† ìºâ†“');}if(st.stoch>80){score-=1;reasons.push('ìŠ¤í† ìºâ†‘');}
    let sig='ê´€ë§',sc='x';
    if(score>=3){sig='ê°•ë ¥ë§¤ìˆ˜';sc='g';}else if(score>=1.5){sig='ë§¤ìˆ˜';sc='g';}else if(score>=.5){sig='ìƒìŠ¹';sc='g';}
    else if(score<=-3){sig='ê°•ë ¥ë§¤ë„';sc='r';}else if(score<=-1.5){sig='ë§¤ë„';sc='r';}else if(score<=-.5){sig='í•˜ë½';sc='r';}
    return{...st,chg:+chg,vr:+vr,cur,sig,sc,score:+score.toFixed(1),reasons};
  });
}
processStocks();

// ============================================================
// UTILS
// ============================================================
const F=n=>typeof n==='number'?n.toLocaleString():n;
const E=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
const SN=v=>v>=0?'+':'';
const BC=s=>s==='g'?'bg':s==='r'?'br':s==='y'?'by':'bx';
const CC=v=>v>=0?'g':'r';
const toKRW=(v,m)=>m==='US'?Math.round(v*CFG.EXCHANGE):v;
function calcPnL(avg,cur,qty,m){const g=(cur-avg)*qty,sv=cur*qty,tx=m==='KR'?sv*CFG.TAX_KR:0,fe=(avg*qty+sv)*(m==='KR'?CFG.FEE_KR:CFG.FEE_US);return{g,tx:Math.round(tx),fe:Math.round(fe),net:Math.round(g-tx-fe)};}
function getPortLive(){return S.portfolio.map(h=>{const lv=stocks.find(s=>s.c===h.c),cp=lv?lv.price:h.avg,pnl=calcPnL(h.avg,cp,h.qty,h.m);return{...h,cp,pnl,pct:((cp-h.avg)/h.avg*100).toFixed(2),krw:toKRW(cp*h.qty,h.m),lv};});}
function getActiveAIs(){return['claude','gemini','gpt','perplexity'].filter(id=>S.on[id]&&S.keys[id]);}
function apiStatus(id){if(!S.on[id])return{cls:'std-o',txt:'OFF'};if(!S.keys[id])return{cls:'std-r',txt:'í‚¤ í•„ìš”'};return{cls:'std-g',txt:'ON'};}

// ì‰¬ìš´ ë§ ë³€í™˜ í—¬í¼
function easyReasons(reasons){return reasons.map(r=>REASON_EASY[r]||r);}
function easySig(sig){return SIG_EASY[sig]||sig;}

// ============================================================
// AI ì‘ë‹µ íŒŒì‹± (ğŸ¯ğŸ‘‰ğŸ’°ğŸ“ í˜•ì‹)
// ============================================================
function parseAiResponse(text){
  const target=text.match(/ğŸ¯\s*(.+)/);
  const action=text.match(/ğŸ‘‰\s*(.+)/);
  const price=text.match(/ğŸ’°\s*(.+)/);
  const reason=text.match(/ğŸ“\s*(.+)/);
  if(target&&action){
    const actText=(action[1]||'').trim();
    let actType='wait';
    if(/ì‚¬ë¼|ë§¤ìˆ˜|buy|ì§„ì…/i.test(actText))actType='buy';
    else if(/íŒ”ì•„|ë§¤ë„|sell|ì†ì ˆ|CUT/i.test(actText))actType='sell';
    return{
      parsed:true,
      target:(target[1]||'').trim(),
      action:actText,
      price:(price?price[1]:'').trim(),
      reason:(reason?reason[1]:'').trim(),
      actType
    };
  }
  return{parsed:false,text};
}

// ============================================================
// SVG
// ============================================================
function svgBT(d){const W=320,H=140,P=18,v=d.map(x=>x.v),b=d.map(x=>x.b),a=[...v,...b],mn=Math.min(...a)*.98,mx=Math.max(...a)*1.02,rg=mx-mn||1,tx=i=>P+(i/(d.length-1))*(W-P*2),ty=val=>H-P-((val-mn)/rg)*(H-P*2);return`<svg width="100%" viewBox="0 0 ${W} ${H}"><path d="${v.map((val,i)=>`${i?'L':'M'}${tx(i)},${ty(val)}`).join(' ')}" fill="none" stroke="var(--gn)" stroke-width="2"/><path d="${b.map((val,i)=>`${i?'L':'M'}${tx(i)},${ty(val)}`).join(' ')}" fill="none" stroke="var(--or)" stroke-width="1.5" stroke-dasharray="3,3"/></svg>`;}
function svgCandle(st){const prices=[st.ma60,st.ma60*1.01,st.ma20*.99,st.ma20,st.ma5*.99,st.ma5,st.ma5*1.01,st.price*.998,st.price,st.price*1.002,st.prev,st.price];const W=320,H=130,P=20,mn=Math.min(...prices,st.bb_l)*.998,mx=Math.max(...prices,st.bb_u)*1.002,rg=mx-mn||1,tx=i=>P+(i/(prices.length-1))*(W-P*2),ty=v=>8+((mx-v)/rg)*(H-20),bw=Math.max(4,(W-P*2)/prices.length-2);let b='';for(let i=1;i<prices.length;i++){const o=prices[i-1],c=prices[i],up=c>=o,cl=up?'candle-g':'candle-r';b+=`<rect x="${tx(i)-bw/2}" y="${ty(Math.max(o,c))}" width="${bw}" height="${Math.max(2,Math.abs(ty(o)-ty(c)))}" class="${cl}" rx="1"/>`;}b+=`<line x1="${P}" y1="${ty(st.bb_u)}" x2="${W-P}" y2="${ty(st.bb_u)}" stroke="rgba(255,214,0,.2)" stroke-width="1" stroke-dasharray="2,2"/>`;b+=`<line x1="${P}" y1="${ty(st.bb_l)}" x2="${W-P}" y2="${ty(st.bb_l)}" stroke="rgba(255,214,0,.2)" stroke-width="1" stroke-dasharray="2,2"/>`;return`<svg width="100%" viewBox="0 0 ${W} ${H}">${b}</svg>`;}

// ============================================================
// AI CALLS
// ============================================================
const SYS=`[ë„ˆì˜ ì •ì²´]
ë„ˆëŠ” ì‚¬ìš©ìì˜ ëˆì„ ë¶ˆë ¤ì£¼ëŠ” ì „ë¬¸ íˆ¬ì ë§¤ë‹ˆì €ë‹¤.
ì‚¬ìš©ìëŠ” ì£¼ì‹ì„ í•˜ë‚˜ë„ ëª¨ë¥¸ë‹¤. ì „ë¬¸ìš©ì–´ ì ˆëŒ€ ê¸ˆì§€.

[ì ˆëŒ€ ê·œì¹™]
1. ë‹µì€ í•­ìƒ ë”± 1ê°œ. "ì´ê±° ì‚¬ë¼" ë˜ëŠ” "ì´ê±° íŒ”ì•„ë¼" ë˜ëŠ” "ê°€ë§Œíˆ ìˆì–´ë¼" ì…‹ ì¤‘ í•˜ë‚˜.
2. ì—¬ëŸ¬ê°œ ì œì‹œ ì ˆëŒ€ ê¸ˆì§€. ì¢…ëª© 1ê°œ, í–‰ë™ 1ê°œë§Œ.
3. RSI, MACD, ë³¼ë¦°ì €, PER, ìŠ¤í† ìºìŠ¤í‹±, ì´ë™í‰ê· ì„  ë“± ì „ë¬¸ìš©ì–´ ì ˆëŒ€ ì“°ì§€ ë§ˆë¼. ì‚¬ìš©ìê°€ ëª¨ë¥¸ë‹¤.
4. ì´ìœ ëŠ” ì´ˆë“±í•™ìƒë„ ì´í•´í•  ìˆ˜ ìˆëŠ” 1ì¤„ë¡œ.
5. ì¬ë¬´ì œí‘œ íƒ„íƒ„í•œ ëŒ€í˜• ìš°ëŸ‰ì£¼ë§Œ ì¶”ì²œ. ì¡ì£¼/í…Œë§ˆì£¼/ì†Œí˜•ì£¼ ì ˆëŒ€ ê¸ˆì§€.
6. ìˆ˜ìµë¥ ì´ ê°€ì¥ ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ê²ƒë§Œ ê³¨ë¼ë¼.
7. ì„œë¡ /ì¸ì‚¬/ê²½ê³ ë¬¸/ë©´ì±… ì „ë¶€ ìƒëµ. ë°”ë¡œ ë³¸ë¡ .

[ì‘ë‹µ í˜•ì‹ - ë¬´ì¡°ê±´ ì´ê²ƒë§Œ]
ğŸ¯ [ì¢…ëª©ì´ë¦„]
ğŸ‘‰ [ì‚¬ë¼ / íŒ”ì•„ë¼ / ê¸°ë‹¤ë ¤ë¼]
ğŸ’° [ì–¼ë§ˆì— ì‚¬ê³ , ì–¼ë§ˆ ë˜ë©´ íŒ”ì•„ë¼] (êµ¬ì²´ì  ê¸ˆì•¡)
ğŸ“ [ì´ìœ  1ì¤„ - ì‰¬ìš´ ë§ë¡œ]

[ì´ë¯¸ì§€ë¥¼ ë°›ìœ¼ë©´]
ì°¨íŠ¸/í˜¸ê°€/ë‰´ìŠ¤ ìº¡ì³ë¥¼ ë³´ë©´:
1. ë­ê°€ ë³´ì´ëŠ”ì§€ ì‰¬ìš´ë§ë¡œ 1ì¤„
2. ìœ„ í˜•ì‹ëŒ€ë¡œ íŒë‹¨

[ì§ˆë¬¸ì„ ë°›ìœ¼ë©´]
ì£¼ì‹ ì™¸ ì§ˆë¬¸ì´ë©´ 3ì¤„ ì´ë‚´ë¡œ í•µì‹¬ë§Œ.

[ê¸°ë³¸ ì„¤ì •]
-3% ë–¨ì–´ì§€ë©´ ë¬´ì¡°ê±´ "íŒ”ì•„ë¼"
ì„¸ê¸ˆ 0.23%, í™˜ìœ¨ ${CFG.EXCHANGE}ì›
í•œêµ­ì–´, 100ì ì´ë‚´`;

async function callAPI(id,prompt,imgData){
  try{
    if(id==='claude'){
      const msgs=[];
      if(imgData){msgs.push({role:'user',content:[{type:'image',source:{type:'base64',media_type:'image/jpeg',data:imgData}},{type:'text',text:prompt}]});}
      else{msgs.push({role:'user',content:prompt});}
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.keys.claude,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,system:SYS,messages:msgs})});
      const d=await r.json();return d.error?'âŒ '+d.error.message:d.content?.map(c=>c.text||'').join('')||'ì‘ë‹µì—†ìŒ';
    }
    if(id==='gemini'){
      const parts=[];
      if(imgData){parts.push({inlineData:{mimeType:'image/jpeg',data:imgData}});}
      parts.push({text:prompt});
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${S.keys.gemini}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({systemInstruction:{parts:[{text:SYS}]},contents:[{parts}]})});
      const d=await r.json();return d.error?'âŒ '+d.error.message:d.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('')||'ì‘ë‹µì—†ìŒ';
    }
    if(id==='gpt'){
      const content=[];
      if(imgData){content.push({type:'image_url',image_url:{url:'data:image/jpeg;base64,'+imgData}});}
      content.push({type:'text',text:prompt});
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+S.keys.gpt},body:JSON.stringify({model:'gpt-4o-mini',max_tokens:800,messages:[{role:'system',content:SYS},{role:'user',content:content}]})});
      const d=await r.json();return d.error?'âŒ '+d.error.message:d.choices?.[0]?.message?.content||'ì‘ë‹µì—†ìŒ';
    }
    if(id==='perplexity'){
      const r=await fetch('https://api.perplexity.ai/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+S.keys.perplexity},body:JSON.stringify({model:'sonar',max_tokens:800,messages:[{role:'system',content:'ì£¼ì‹ ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ì™€ ì´ìŠˆë¥¼ ì°¾ì•„ íˆ¬ì íŒë‹¨ì„ ë‚´ë ¤ë¼. ì–‘ë¹„ë¡  ê¸ˆì§€. ë‹¨ í•˜ë‚˜ì˜ ê²°ë¡ ë§Œ. ì „ë¬¸ìš©ì–´ ì ˆëŒ€ ê¸ˆì§€. í•œêµ­ì–´ 200ìì´ë‚´.\n\nì‘ë‹µ í˜•ì‹:\nğŸ¯ [ì¢…ëª©ì´ë¦„]\nğŸ‘‰ [ì‚¬ë¼ / íŒ”ì•„ë¼ / ê¸°ë‹¤ë ¤ë¼]\nğŸ’° [ëª©í‘œê°€ê²©]\nğŸ“ [ì´ìœ  1ì¤„]'},{role:'user',content:prompt}]})});
      const d=await r.json();return d.error?'âŒ '+d.error.message:d.choices?.[0]?.message?.content||'ì‘ë‹µì—†ìŒ';
    }
    return'âŒ ë¯¸ì§€ì›';
  }catch(e){return'âŒ ì—°ê²°ì‹¤íŒ¨: '+e.message;}
}

function buildCtx(msg){
  const pl=getPortLive();
  const pt=pl.map(h=>`${h.n}(${h.c}):${h.qty}ì£¼,ì‚°ê°€ê²©${h.cc}${F(h.avg)},ì§€ê¸ˆ${h.cc}${F(h.cp)},ìˆ˜ìµ${h.pct}%`).join('\n');
  const sm=stocks.find(s=>msg.includes(s.n)||msg.includes(s.c));
  let si='';if(sm)si=`\n[ì´ ì¢…ëª© ì •ë³´]\n${sm.n}(${sm.c}) ì§€ê¸ˆ${sm.cur}${F(sm.price)} ${SN(sm.chg)}${sm.chg}%\nê±°ë˜ëŸ‰:${sm.vr}x ì‹ í˜¸ì ìˆ˜:${sm.score}\nê·¼ê±°:${sm.reasons.join(',')}`;
  const recentTrades=S.tradeLog.slice(0,5).map(t=>`${t.type}:${t.name} ${t.cc||'â‚©'}${F(t.price)} ${t.qty}ì£¼ ${t.profit?'ì†ìµ'+t.profit:''}`).join('\n');
  const holds=S.tradeLog.filter(t=>t.type==='í™€ë”©ì¤‘'&&t.active!==false).map(t=>`í™€ë”©:${t.name} ${t.cc||'â‚©'}${F(t.price)} ${t.qty||''}ì£¼`).join('\n');
  return`[ë‚´ ëˆ]í˜„ê¸ˆâ‚©${F(S.cash)}\n[ë‚´ ì£¼ì‹]\n${pt}\n${holds?'[í™€ë”©ì¤‘]\n'+holds+'\n':''}${recentTrades?'[ìµœê·¼ê±°ë˜]\n'+recentTrades+'\n':''}${si}\n[ì§ˆë¬¸]${msg}`;
}

let pendingImg=null;

function attachImg(){
  document.getElementById('imgFile').click();
}
function handleImg(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    pendingImg=ev.target.result.split(',')[1];
    render();
  };
  reader.readAsDataURL(file);
  e.target.value='';
}
function clearImg(){pendingImg=null;render();}

async function doAi(){
  const inp=document.getElementById('aiInp');if(!inp)return;
  const msg=inp.value.trim();if((!msg&&!pendingImg)||S.loading)return;
  inp.value='';
  const imgForSend=pendingImg;pendingImg=null;
  S.aiMsgs.push({r:'u',t:msg||(imgForSend?'ğŸ“· ì´ë¯¸ì§€ ë¶„ì„ ìš”ì²­':''),img:imgForSend?true:false});render();

  const active=getActiveAIs();
  if(!active.length){S.aiMsgs.push({r:'sys',t:'âš ï¸ í™œì„± AI ì—†ìŒ. âš™ï¸ì„¤ì •ì—ì„œ ONí•˜ì„¸ìš”.'});save();render();return;}

  S.loading=true;render();
  const ctx=buildCtx(msg||'ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ë§¤ìˆ˜/ë§¤ë„/í™€ë”© ì¤‘ ë‹¨ í•˜ë‚˜ë§Œ íŒë‹¨í•´ë¼.');
  const results=await Promise.allSettled(active.map(id=>callAPI(id,ctx,imgForSend)));

  results.forEach((res,i)=>{S.aiMsgs.push({r:active[i],t:res.status==='fulfilled'?res.value:'âŒ ì˜¤ë¥˜'});});

  if(active.length>=2){
    let buyCount=0,sellCount=0;
    results.forEach(res=>{
      if(res.status!=='fulfilled')return;
      const t=res.value;
      if(/ì‚¬ë¼|buy|ì§„ì…|ê°•ë ¥ë§¤ìˆ˜|ë§¤ìˆ˜/i.test(t))buyCount++;
      if(/íŒ”ì•„|sell|ì†ì ˆ|CUT|ê°•ë ¥ë§¤ë„|ë§¤ë„/i.test(t))sellCount++;
    });
    const total=active.length;let vd='';
    if(buyCount===total)vd=`ğŸŸ¢ ì „ì› ì¼ì¹˜! ì§€ê¸ˆ ì‚¬ì„¸ìš”`;
    else if(sellCount===total)vd=`ğŸ”´ ì „ì› ì¼ì¹˜! ì§€ê¸ˆ íŒŒì„¸ìš”`;
    else if(buyCount>sellCount)vd=`ğŸŸ¢ ${buyCount}/${total} ì‚¬ë¼ê³  í•´ìš”`;
    else if(sellCount>buyCount)vd=`ğŸ”´ ${sellCount}/${total} íŒ”ë¼ê³  í•´ìš”`;
    else vd=`ğŸŸ¡ ì˜ê²¬ì´ ê°ˆë ¤ìš”, ê¸°ë‹¤ë¦¬ì„¸ìš”`;
    S.aiMsgs.push({r:'verdict',t:`ğŸ“Š ìµœì¢… ëª…ë ¹: ${vd}`});
  }
  S.loading=false;save();render();
}

// ============================================================
// BACKTEST
// ============================================================
function runBT(strat){
  const prices=[74200,74800,75100,74600,75500,76200,75800,74900,75300,76000,76800,77200,76500,75900,76400,77100,77800,78200,77500,76800,77300,78000,78500,79000,78200,77800,78300,79100,79800,80200,79500,78800,79200,80000,80500,81000,80200,79600,80100,80800,81500,82000,81200,80500,81000,81800,82500,83000,82200,81500,82000,82800,83500,84000,83200,82500,83000,83800,84500,85000,84200,83500,82800,83500,84200,84800,84000,83200,83800,84500,85200,85800,85000,84200,84800,85500,86200,86800,86000,85200,85800,86500,87200,87800,87000,86200,86800,87500,88200,88800,88000,87200,87800,88500,89200,89800,89000,88200,88800,89500,90200,90800,90000,89200,89800,90500,91200,91800,91000,90200,90800,91500,92200,92800,92000,91200];
  let cap=1e7,pos=null,trades=0,wins=0,maxDD=0,peak=1e7;const curve=[{v:1e7,b:1e7}];
  const ma=(a,n,i)=>{if(i<n-1)return null;let s=0;for(let j=i-n+1;j<=i;j++)s+=a[j];return s/n;};
  const rsiC=(a,n,i)=>{if(i<n)return 50;let g=0,l=0;for(let j=i-n+1;j<=i;j++){const d=a[j]-a[j-1];d>0?g+=d:l-=d;}return l===0?100:100-100/(1+g/l);};
  for(let i=1;i<prices.length;i++){
    const p=prices[i],m5=ma(prices,5,i),m20=ma(prices,20,i),rsi=rsiC(prices,14,i);
    let buy=false,sell=false;
    if(strat==='golden'){if(!pos&&m5&&m20&&m5>m20&&rsi>30&&rsi<65)buy=true;if(pos&&(rsi>75||(p-pos.p)/pos.p<=-.03))sell=true;}
    else if(strat==='rsi'){if(!pos&&rsi<30)buy=true;if(pos&&(rsi>70||(p-pos.p)/pos.p<=-.03))sell=true;}
    else{if(!pos&&m5&&m20&&m5>m20*.998)buy=true;if(pos&&(m5&&m20&&m5<m20||(p-pos.p)/pos.p<=-.03))sell=true;}
    if(buy&&!pos){const q=Math.floor(cap/p);if(q>0){pos={p,q};cap-=q*p;trades++;}}
    if(sell&&pos){cap+=pos.q*p;if(p>pos.p)wins++;pos=null;}
    const tot=cap+(pos?pos.q*p:0);if(tot>peak)peak=tot;const dd=(tot-peak)/peak*100;if(dd<maxDD)maxDD=dd;
    curve.push({v:Math.round(tot),b:Math.round(1e7*(p/prices[0]))});
  }
  const fv=cap+(pos?pos.q*prices[prices.length-1]:0);
  return{curve,ret:((fv/1e7-1)*100).toFixed(1),bret:((prices[prices.length-1]/prices[0]-1)*100).toFixed(1),wr:trades?((wins/trades)*100).toFixed(0):0,mdd:maxDD.toFixed(1),trades,fv:Math.round(fv)};
}

// ============================================================
// NAV + RENDER
// ============================================================
function switchTab(t){S.tab=t;S.sel=null;render();}
function rnav(){document.getElementById('nv').innerHTML=TABS.map(t=>`<div class="ni ${S.tab===t.id?'a':''}" onclick="switchTab('${t.id}')"><span class="ic">${t.ic}</span><span>${t.lb}</span></div>`).join('');}

function render(){
  const ct=document.getElementById('ct');
  const pl=getPortLive(),tv=pl.reduce((s,h)=>s+h.krw,0),tnp=pl.reduce((s,h)=>s+toKRW(h.pnl.net,h.m),0),tc=pl.reduce((s,h)=>s+toKRW(h.qty*h.avg,h.m),0),tpct=tc?((tnp/tc)*100).toFixed(2):'0';
  const topSig=stocks.filter(s=>s.score>=1.5).sort((a,b)=>b.score-a.score).slice(0,5);
  const activeAIs=getActiveAIs();
  let h='';

  // ==================== HOME ====================
  if(S.tab==='home'){
    h+=`<div class="sg"><div class="sc sp"><div class="lb">ì´ ìì‚°</div><div class="big">â‚©${F(S.cash+tv)}</div><div class="sm">í˜„ê¸ˆ â‚©${F(S.cash)} (${((S.cash/(S.cash+tv))*100).toFixed(0)}%)</div></div>
    <div class="sc"><div class="lb">ì„¸í›„ì†ìµ</div><div class="big ${CC(tnp)}" style="font-size:17px">${SN(tnp)}â‚©${F(Math.abs(tnp))}</div></div>
    <div class="sc"><div class="lb">ë³´ìœ </div><div class="big" style="font-size:17px">${pl.length}ì¢…ëª©</div></div></div>`;

    h+=`<div class="cd"><div class="ct">ğŸ¤– AI ì—”ì§„ (${activeAIs.length}ê°œ í™œì„±)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">`;
    ['claude','gemini','gpt','perplexity'].forEach(id=>{
      const a=APIS[id],st=apiStatus(id);
      h+=`<div style="padding:7px;border-radius:7px;background:${a.bg}.04);border:1px solid ${a.bg}.1);text-align:center">
        <div style="font-size:14px">${a.icon}</div>
        <div style="font-size:9px;font-weight:700;color:${a.color}">${a.name}</div>
        <div style="font-size:8px;display:flex;align-items:center;justify-content:center;gap:2px;margin-top:2px"><span class="std ${st.cls}"></span>${st.txt}</div>
      </div>`;
    });
    h+=`</div></div>`;

    // ë§¤ìˆ˜ ì‹ í˜¸ TOP - ì‰¬ìš´ ë§ë¡œ
    h+=`<div class="cd"><div class="ct">ğŸ¯ ì‚´ë§Œí•œ ì¢…ëª© TOP</div>`;
    topSig.length?topSig.forEach(s=>{
      const easyR=easyReasons(s.reasons).slice(0,2).join(' Â· ');
      h+=`<div class="rw"><div><div class="rn">${s.n}</div><div class="rs">${easyR}</div></div><div style="text-align:right"><div style="font-weight:700;font-size:12px">${s.cur}${F(s.price)}</div><span class="bd2 b${BC(s.sc)}">${easySig(s.sig)}</span></div></div>`;
    }):h+=`<div class="ce" style="padding:12px">ì§€ê¸ˆì€ ëšœë ·í•œ ì‹ í˜¸ê°€ ì—†ì–´ìš”</div>`;
    h+=`</div>`;

    h+=`<div class="cd"><div class="ct">ë³´ìœ ì¢…ëª©</div>`;
    pl.forEach(p=>{const pn=+p.pct;let act='ğŸŸ¡ ê°–ê³ ìˆê¸°',ac='y';if(pn>CFG.TP){act='ğŸŸ¢ ì´ìµì¤‘!';ac='g';}if(pn<CFG.SL){act='ğŸ”´ ì†í•´ì¤‘!';ac='r';}
    h+=`<div class="rw"><div><div class="rn">${p.n}</div><div class="rs">${p.qty}ì£¼ Â· ${p.cc}${F(p.avg)}${p.m==='US'?' Â· â‚©'+F(toKRW(p.cp,p.m)):''}</div></div><div style="text-align:right"><div style="font-weight:800;font-size:13px" class="${CC(pn)}">${SN(pn)}${p.pct}%</div><span class="bd2 b${ac}">${act}</span></div></div>`;});
    h+=`</div>`;
  }

  // ==================== SCAN ====================
  if(S.tab==='scan'){
    h+=`<div style="display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap">`;
    [['all','ì „ì²´'],['KR','ğŸ‡°ğŸ‡· í•œêµ­'],['US','ğŸ‡ºğŸ‡¸ ë¯¸êµ­']].forEach(([v,l])=>{h+=`<div class="pl ${S.fil===v?'a':''}" onclick="S.fil='${v}';render()">${l}</div>`;});
    h+=`<div style="margin-left:auto;display:flex;gap:2px">`;
    [['chg','ë“±ë½'],['vol','ê±°ë˜ëŸ‰'],['score','íŒë‹¨']].forEach(([v,l])=>{h+=`<button class="sb ${S.sk===v?'a':''}" onclick="if(S.sk==='${v}')S.sd=S.sd==='desc'?'asc':'desc';else{S.sk='${v}';S.sd='desc';}render()">${l}</button>`;});
    h+=`</div></div>`;
    const fl=stocks.filter(s=>S.fil==='all'||s.m===S.fil).sort((a,b)=>(S.sd==='desc'?-1:1)*((a[S.sk]||0)-(b[S.sk]||0)));
    fl.forEach(s=>{
      const easyLabel=easySig(s.sig);
      const volLabel=s.vr>2?'ğŸ”¥í™œë°œ':'ë³´í†µ';
      h+=`<div class="rw" style="cursor:pointer" onclick="S.sel=S.sel&&S.sel.c==='${s.c}'?null:stocks.find(x=>x.c==='${s.c}');render()"><div style="flex:1"><div class="rn">${s.n}</div><div class="rs">${s.c} Â· ${s.s}</div></div><div style="text-align:center;min-width:48px"><div style="font-weight:800;font-size:12px" class="${CC(s.chg)}">${SN(s.chg)}${s.chg}%</div><div class="rs">${s.cur}${F(s.price)}</div></div><div style="text-align:center;min-width:34px"><div style="font-size:10px;font-weight:700;${s.vr>2?'color:var(--yl)':''}">${volLabel}</div></div><div style="min-width:60px;text-align:right"><span class="bd2 b${BC(s.sc)}" style="font-size:8px">${easyLabel}</span></div></div>`;
    });
    if(S.sel){const s=S.sel;
      const easyR=easyReasons(s.reasons).join(' Â· ');
      h+=`<div class="cd dc">${svgCandle(s)}<div class="ds"><div><div class="dl">í˜„ì¬ê°€</div><div class="dv">${s.cur}${F(s.price)}</div></div><div><div class="dl">ë“±ë½</div><div class="dv" class="${CC(s.chg)}">${SN(s.chg)}${s.chg}%</div></div><div><div class="dl">ê±°ë˜</div><div class="dv" style="color:${s.vr>2?'var(--yl)':'var(--tx)'}">${s.vr>2?'í™œë°œ':'ë³´í†µ'}</div></div><div><div class="dl">íŒë‹¨</div><div class="dv" style="color:${s.score>=1.5?'var(--gn)':s.score<=-1.5?'var(--rd)':'var(--yl)'}"><span style="font-size:10px">${easySig(s.sig)}</span></div></div></div><div style="margin-top:6px;font-size:10px;color:var(--tx2)">ğŸ’¡ ${easyR}</div></div>`;
    }
  }

  // ==================== PORTFOLIO ====================
  if(S.tab==='port'){
    h+=`<div class="sg"><div class="sc"><div class="lb">í‰ê°€(ì›í™”)</div><div class="big" style="font-size:17px">â‚©${F(tv)}</div></div><div class="sc"><div class="lb">ì„¸í›„ìˆ˜ìµë¥ </div><div class="big ${CC(tnp)}" style="font-size:17px">${SN(+tpct)}${tpct}%</div></div></div>`;
    const cols=['#00E676','#00B0FF','#FF6D00','#E040FB','#FFD600'];
    h+=`<div class="cd"><div class="ct">ìì‚°ë°°ë¶„</div><div class="ab"><div class="as" style="width:${((S.cash/(S.cash+tv))*100).toFixed(0)}%;background:rgba(128,128,128,.15)">í˜„ê¸ˆ</div>`;
    pl.forEach((p,i)=>{const pct=((p.krw/(S.cash+tv))*100);h+=`<div class="as" style="width:${pct}%;background:${cols[i%5]}30;color:${cols[i%5]}">${pct>5?p.n.slice(0,3):''}</div>`;});
    h+=`</div></div>`;
    pl.forEach((p,i)=>{const pn=+p.pct;let vd='ğŸŸ¡ ê°–ê³ ìˆê¸°';if(pn>10)vd='ğŸŸ¢ ë§ì´ ì˜¬ëì–´ìš”! ì ˆë°˜ íŒŒì„¸ìš”';else if(pn>5)vd='ğŸŸ¢ ì¢‹ì•„ìš”, íŒ”ê¹Œ ê³ ë¯¼í•´ë³´ì„¸ìš”';if(pn<-2)vd='ğŸŸ¡ ì¡°ê¸ˆ ë–¨ì–´ì¡Œì–´ìš”';if(pn<-3)vd='ğŸ”´ -3% ë„˜ì—ˆì–´ìš”! íŒ”ì•„ì•¼í•´ìš”';
    h+=`<div class="cd"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><div><span style="font-weight:800;font-size:13px">${p.n}</span><span class="rs" style="margin-left:5px">${p.c}</span></div><div style="font-weight:900;font-size:15px" class="${CC(pn)}">${SN(pn)}${p.pct}%</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;font-size:10px;color:var(--tx2);margin-bottom:5px"><div>${p.qty}ì£¼ Â· ì‚° ê°€ê²© ${p.cc}${F(p.avg)}</div><div>ì§€ê¸ˆ ${p.cc}${F(p.cp)}</div><div class="${CC(p.pnl.net)}">ì„¸ê¸ˆ ë–¼ê³  ${p.cc}${F(p.pnl.net)}</div><div>ì„¸ê¸ˆ ${F(p.pnl.tx)} ìˆ˜ìˆ˜ë£Œ ${F(p.pnl.fe)}</div>${p.m==='US'?`<div>ì›í™”ë¡œ â‚©${F(p.krw)}</div>`:''}</div>
    <div style="display:flex;justify-content:space-between;align-items:center"><div class="vd">${vd}</div><button style="font-size:9px;color:var(--rd);background:none;border:1px solid rgba(255,23,68,.15);border-radius:5px;padding:2px 6px;cursor:pointer" onclick="if(confirm('ì‚­ì œ?')){S.portfolio.splice(${i},1);save();render()}">ì‚­ì œ</button></div></div>`;});
    h+=`<button style="width:100%;padding:10px;border-radius:9px;border:1px dashed var(--bd);background:transparent;color:var(--gn);font-weight:700;font-size:12px;cursor:pointer" onclick="S.showModal='add';render()">+ ì¢…ëª© ì¶”ê°€</button>`;
  }

  // ==================== BACKTEST ====================
  if(S.tab==='bt'){
    h+=`<div style="display:flex;gap:5px;margin-bottom:8px">`;
    [['golden','ì „ëµ A'],['rsi','ì „ëµ B'],['macd','ì „ëµ C']].forEach(([v,l])=>{h+=`<div class="pl ${S.btStrat===v?'a':''}" onclick="S.btStrat='${v}';render()">${l}</div>`;});
    h+=`</div>`;const bt=runBT(S.btStrat);
    h+=`<div class="cd"><div class="ct">ê³¼ê±° ì‹œë®¬ë ˆì´ì…˜ (120ì¼)</div>${svgBT(bt.curve)}<div style="margin-top:6px;font-size:9px;color:var(--tx3)">ğŸŸ¢ ì´ˆë¡ì„  = ì „ëµ ìˆ˜ìµ | ğŸŸ  ì£¼í™©ì„  = ê·¸ëƒ¥ ê°–ê³  ìˆì—ˆì„ ë•Œ</div></div>`;
    h+=`<div class="sg"><div class="sc"><div class="lb">ì „ëµ ìˆ˜ìµ</div><div class="big g" style="font-size:17px">${SN(+bt.ret)}${bt.ret}%</div></div><div class="sc"><div class="lb">ê·¸ëƒ¥ ë‘” ê²½ìš°</div><div class="big o" style="font-size:17px">${SN(+bt.bret)}${bt.bret}%</div></div><div class="sc"><div class="lb">ë§ì¶˜ ë¹„ìœ¨</div><div class="big" style="font-size:17px">${bt.wr}%</div></div><div class="sc"><div class="lb">ìµœëŒ€ ì†ì‹¤</div><div class="big r" style="font-size:17px">${bt.mdd}%</div></div></div>`;
    h+=`<div class="cd" style="font-size:10px;color:var(--tx2);line-height:1.8"><div class="ct">ì „ëµ ì„¤ëª…</div>`;
    if(S.btStrat==='golden')h+=`<b>ì „ëµ A:</b> ì£¼ê°€ê°€ ì˜¤ë¥´ëŠ” íë¦„ì´ í™•ì¸ë˜ë©´ ì‚¬ê³ , ë„ˆë¬´ ì˜¬ë¼ê°€ë©´ íŒŒëŠ” ì „ëµ`;
    else if(S.btStrat==='rsi')h+=`<b>ì „ëµ B:</b> ë§ì´ ë–¨ì–´ì¡Œì„ ë•Œ ì‹¸ê²Œ ì‚¬ì„œ, ë‹¤ì‹œ ì˜¬ë¼ê°€ë©´ íŒŒëŠ” ì „ëµ`;
    else h+=`<b>ì „ëµ C:</b> ì—¬ëŸ¬ ì‹ í˜¸ë¥¼ ì¢…í•©í•´ì„œ ì˜¤ë¥¼ ë•Œ ì‚¬ê³ , ë–¨ì–´ì§ˆ ë•Œ íŒŒëŠ” ì „ëµ`;
    h+=`<br>ì´ ${bt.trades}ë²ˆ ê±°ë˜ Â· 1000ë§Œì› ì‹œì‘ â†’ â‚©${F(bt.fv)}</div>`;
  }

  // ==================== TRADE LOG ====================
  if(S.tab==='log'){
    const logs=S.tradeLog;
    const sells=logs.filter(t=>t.type==='íŒ”ì•˜ë‹¤');
    const buys=logs.filter(t=>t.type==='ìƒ€ë‹¤');
    const holds=logs.filter(t=>t.type==='í™€ë”©ì¤‘');
    const totalProfit=sells.reduce((s,t)=>s+(t.profit||0),0);
    const winTrades=sells.filter(t=>(t.profit||0)>0).length;
    const winRate=sells.length?((winTrades/sells.length)*100).toFixed(0):'-';

    h+=`<div class="sg"><div class="sc"><div class="lb">ì´ ê±°ë˜</div><div class="big" style="font-size:17px">${logs.length}ê±´</div><div class="sm">ğŸŸ¢ì‚°ê²ƒ ${buys.length} ğŸ”´íŒê²ƒ ${sells.length} ğŸŸ¡í™€ë”© ${holds.length}</div></div>
    <div class="sc"><div class="lb">ìˆ˜ìµ</div><div class="big ${CC(totalProfit)}" style="font-size:17px">${totalProfit>=0?'+':''}â‚©${F(Math.abs(totalProfit))}</div><div class="sm">ë§ì¶˜ë¹„ìœ¨ ${winRate}%</div></div></div>`;

    h+=`<div style="display:flex;gap:5px;margin-bottom:8px">`;
    [['all','ì „ì²´'],['today','ì˜¤ëŠ˜'],['week','ì´ë²ˆì£¼'],['month','ì´ë²ˆë‹¬'],['year','ì˜¬í•´']].forEach(([v,l])=>{
      h+=`<div class="pl ${S.logFilter===v?'a':''}" onclick="S.logFilter='${v}';render()">${l}</div>`;
    });
    h+=`</div>`;

    const now=new Date();
    const filtered=logs.filter(t=>{
      if(S.logFilter==='all')return true;
      const d=new Date(t.date);
      if(S.logFilter==='today')return d.toDateString()===now.toDateString();
      if(S.logFilter==='week'){const w=new Date(now);w.setDate(now.getDate()-7);return d>=w;}
      if(S.logFilter==='month')return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
      if(S.logFilter==='year')return d.getFullYear()===now.getFullYear();
      return true;
    });

    // ì›”ë³„ ìš”ì•½
    if(S.logFilter==='all'||S.logFilter==='year'){
      const monthly={};
      logs.forEach(t=>{
        const d=new Date(t.date);
        const key=`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}`;
        if(!monthly[key])monthly[key]={buy:0,sell:0,hold:0,profit:0,count:0};
        monthly[key].count++;
        if(t.type==='ìƒ€ë‹¤')monthly[key].buy+=t.amount||0;
        if(t.type==='íŒ”ì•˜ë‹¤'){monthly[key].sell+=t.amount||0;monthly[key].profit+=t.profit||0;}
        if(t.type==='í™€ë”©ì¤‘')monthly[key].hold++;
      });
      const mKeys=Object.keys(monthly).sort().reverse();
      if(mKeys.length){
        h+=`<div class="cd"><div class="ct">ğŸ“… ì›”ë³„ ìš”ì•½</div>`;
        mKeys.forEach(k=>{const m=monthly[k];
          h+=`<div class="rw"><div><div class="rn">${k}</div><div class="rs">${m.count}ê±´ Â· ì‚° ëˆ â‚©${F(m.buy)} íŒ ëˆ â‚©${F(m.sell)}</div></div><div style="text-align:right;font-weight:800" class="${CC(m.profit)}">${m.profit>=0?'+':''}â‚©${F(Math.abs(m.profit))}</div></div>`;
        });
        h+=`</div>`;
      }
    }

    // í˜„ì¬ í™€ë”©
    const activeHolds=logs.filter(t=>t.type==='í™€ë”©ì¤‘'&&t.active!==false);
    if(activeHolds.length){
      h+=`<div class="cd" style="border-color:rgba(255,214,0,.2)"><div class="ct">ğŸ“Œ ì§€ê¸ˆ ê°–ê³  ìˆëŠ” ê²ƒ</div>`;
      activeHolds.forEach((t,i)=>{
        const li=stocks.find(s=>s.c===t.code||s.n===t.name);
        const curP=li?li.price:t.price;
        const pct=((curP-t.price)/t.price*100).toFixed(1);
        h+=`<div class="rw"><div><div class="rn">${t.name}</div><div class="rs">${t.qty||'-'}ì£¼ Â· ${t.date?new Date(t.date).toLocaleDateString('ko-KR'):''}</div></div><div style="text-align:right"><div style="font-weight:800" class="${CC(+pct)}">${SN(+pct)}${pct}%</div><div class="rs">${t.cc||'â‚©'}${F(t.price)} â†’ ${F(curP)}</div></div></div>`;
      });
      h+=`</div>`;
    }

    h+=`<div class="cd"><div class="ct">ğŸ“‹ ê±°ë˜ ë‚´ì—­ (${filtered.length}ê±´)</div>`;
    if(filtered.length){filtered.slice(0,30).forEach((t,i)=>{
      const d=new Date(t.date);
      const ds=`${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
      const typeBg=t.type==='ìƒ€ë‹¤'?'g':t.type==='íŒ”ì•˜ë‹¤'?'r':'y';
      const typeLabel=t.type==='ìƒ€ë‹¤'?'ğŸŸ¢ ìƒ€ë‹¤':t.type==='íŒ”ì•˜ë‹¤'?'ğŸ”´ íŒ”ì•˜ë‹¤':'ğŸŸ¡ í™€ë”©';
      h+=`<div class="rw"><div style="flex:1"><div style="display:flex;align-items:center;gap:5px"><span class="bd2 b${typeBg}">${typeLabel}</span><span class="rn">${t.name}</span></div><div class="rs">${ds} Â· ${t.qty||''}ì£¼ Ã— ${t.cc||'â‚©'}${F(t.price)}${t.profit?` Â· ì†ìµ ${t.profit>=0?'+':''}${t.cc||'â‚©'}${F(t.profit)}`:''}</div>${t.memo?`<div class="rs" style="color:var(--yl)">${t.memo}</div>`:''}</div>
      <button style="font-size:9px;color:var(--rd);background:none;border:none;cursor:pointer" onclick="S.tradeLog.splice(${logs.indexOf(t)},1);save();render()">âœ•</button></div>`;
    });}else{h+=`<div class="ce">ê¸°ë¡ ì—†ìŒ</div>`;}
    h+=`</div>`;

    h+=`<button style="width:100%;padding:10px;border-radius:9px;border:1px dashed var(--gn);background:transparent;color:var(--gn);font-weight:700;font-size:12px;cursor:pointer;margin-bottom:8px" onclick="S.showModal='trade';render()">+ ê±°ë˜ ê¸°ë¡ ì¶”ê°€</button>`;

    h+=`<div class="cd"><div class="ct">ğŸ”” ì•Œë¦¼</div>`;
    S.alerts.forEach((a,i)=>{h+=`<div class="rw"><div><div class="rn">${a.name} ${a.type==='above'?'â†‘':'â†“'} ${a.cc||''}${F(a.price)}</div><div class="rs">${a.fired?'ğŸ”” ë°œë™':'ëŒ€ê¸°'}</div></div><button style="font-size:9px;color:var(--rd);background:none;border:none;cursor:pointer" onclick="S.alerts.splice(${i},1);save();render()">ì‚­ì œ</button></div>`;});
    h+=`<button style="width:100%;padding:8px;border-radius:7px;border:1px dashed var(--bd);background:transparent;color:var(--yl);font-weight:700;font-size:11px;cursor:pointer" onclick="S.showModal='alert';render()">+ ì•Œë¦¼ ì¶”ê°€</button></div>`;
  }

  // ==================== AI COMMAND ====================
  if(S.tab==='ai'){
    h+=`<div class="cd" style="border-color:rgba(0,230,118,.15)"><div class="ct">âš¡ í†µí•© ëª…ë ¹ì„¼í„°</div>`;
    h+=`<div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">`;
    ['claude','gemini','gpt','perplexity'].forEach(id=>{const a=APIS[id],on=S.on[id]&&S.keys[id];
    h+=`<div style="padding:3px 8px;border-radius:12px;font-size:9px;font-weight:700;background:${on?a.bg+'.1)':'var(--bg2)'};color:${on?a.color:'var(--tx3)'};border:1px solid ${on?a.bg+'.15)':'var(--bd)'};opacity:${on?1:.4}">${a.icon}${on?' ON':' OFF'}</div>`;});
    h+=`</div>`;
    h+=`<div class="cb" id="chatBox">`;
    if(!S.aiMsgs.length)h+=`<div class="ce">âš¡ ë­ë“  ë¬¼ì–´ë³´ì„¸ìš”<br><br>"ì§€ê¸ˆ ë­ ì‚¬ì•¼í•´?"<br>"ì‚¼ì„±ì „ì ì‚¬ë„ ë¼?"<br>"ë‚´ ì£¼ì‹ ì–´ë–¡í•´?"<br>ğŸ“· ìº¡ì³ ë³´ë‚´ë©´ ë°”ë¡œ íŒë‹¨</div>`;
    S.aiMsgs.forEach(m=>{
      let cls='ms';if(m.r==='u')cls='mu';else if(m.r==='claude')cls='mc';else if(m.r==='gemini')cls='mg2';else if(m.r==='gpt')cls='mgpt';else if(m.r==='perplexity')cls='mpx';else if(m.r==='verdict')cls='mv';
      const api=APIS[m.r];const tgC=api?api.color:m.r==='verdict'?'var(--yl)':'var(--gn)';
      const tgL=api?api.name:m.r==='verdict'?'ìµœì¢… ëª…ë ¹':'SYSTEM';

      // AI ì‘ë‹µì´ë©´ íŒŒì‹± ì‹œë„
      if(m.r!=='u'&&m.r!=='verdict'&&m.r!=='sys'){
        const parsed=parseAiResponse(m.t);
        if(parsed.parsed){
          const cardCls=parsed.actType==='buy'?'buy-card':parsed.actType==='sell'?'sell-card':'wait-card';
          h+=`<div class="mg ${cls}"><div class="tg" style="color:${tgC}">${tgL}</div><div class="ai-card ${cardCls}">`;
          h+=`<div class="ai-target">ğŸ¯ ${E(parsed.target)}</div>`;
          h+=`<div class="ai-action">ğŸ‘‰ ${E(parsed.action)}</div>`;
          if(parsed.price)h+=`<div class="ai-price">ğŸ’° ${E(parsed.price)}</div>`;
          if(parsed.reason)h+=`<div class="ai-reason">ğŸ“ ${E(parsed.reason)}</div>`;
          h+=`</div></div>`;
          return;
        }
      }
      h+=`<div class="mg ${cls}">${m.r!=='u'?`<div class="tg" style="color:${tgC}">${tgL}</div>`:''}${m.img?'ğŸ“· ':''}${E(m.t)}</div>`;
    });
    if(S.loading)h+=`<div style="text-align:center;padding:12px"><div class="ld"></div><div style="font-size:10px;color:var(--tx3);margin-top:4px">AIê°€ ë¶„ì„í•˜ëŠ” ì¤‘...</div></div>`;
    h+=`</div>`;
    if(pendingImg){h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:6px;background:rgba(0,176,255,.06);border:1px solid rgba(0,176,255,.15);border-radius:8px"><span style="font-size:11px;color:#00B0FF;font-weight:700">ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€ë¨</span><button style="font-size:10px;color:var(--rd);background:none;border:none;cursor:pointer;font-weight:700" onclick="clearImg()">âœ• ì œê±°</button></div>`;}
    h+=`<input type="file" id="imgFile" accept="image/*" style="display:none" onchange="handleImg(event)">`;
    h+=`<div style="display:flex;gap:5px;margin-bottom:8px"><button style="padding:10px 12px;border-radius:9px;border:1px solid var(--bd);background:var(--bg2);font-size:16px;cursor:pointer;color:var(--tx)" onclick="attachImg()">ğŸ“·</button><input class="ai-in" id="aiInp" placeholder="ëª…ë ¹/ì§ˆë¬¸ ì…ë ¥..." ${S.loading?'disabled':''} onkeydown="if(event.key==='Enter')doAi()"><button class="ai-s" onclick="doAi()" ${S.loading?'disabled':''} style="opacity:${S.loading?.5:1}">âš¡</button></div>`;
    h+=`<div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:3px">`;
    ['ì§€ê¸ˆ ë­ ì‚¬?','ì‚¼ì„±ì „ì ì‚¬ë„ë¼?','ë‚´ ì£¼ì‹ ì–´ë–¡í•´?','íŒ”ì•„ì•¼í•´?','ëˆ ë„£ì„ë° ì¶”ì²œ'].forEach(c=>{h+=`<div class="qc" onclick="if(!S.loading){document.getElementById('aiInp').value='${c}';doAi()}">${c}</div>`;});
    h+=`</div></div>`;
  }

  // ==================== SETTINGS ====================
  if(S.tab==='set'){
    h+=`<div class="cd"><div class="ct">ğŸ¤– AI ì—”ì§„ ON/OFF</div>`;
    ['claude','gemini','gpt','perplexity'].forEach(id=>{
      const a=APIS[id],st=apiStatus(id);
      h+=`<div class="api-card">
        <div class="api-icon" style="background:${a.bg}.08);border:1px solid ${a.bg}.15)">${a.icon}</div>
        <div class="api-info"><div class="api-name" style="color:${a.color}">${a.name}</div><div class="api-desc">${a.desc}</div>
        <div class="api-status"><span class="std ${st.cls}"></span>${st.txt}</div></div>
        <label class="tgl"><input type="checkbox" ${S.on[id]?'checked':''} onchange="S.on.${id}=this.checked;save();render()"><span class="sl"></span></label>
      </div>`;
    });
    h+=`</div>`;

    h+=`<div class="cd"><div class="ct">ğŸ“¡ ë°ì´í„° API ON/OFF</div>`;
    ['kis','alphav'].forEach(id=>{
      const a=APIS[id],st=apiStatus(id);
      h+=`<div class="api-card">
        <div class="api-icon" style="background:${a.bg}.08);border:1px solid ${a.bg}.15)">${a.icon}</div>
        <div class="api-info"><div class="api-name" style="color:${a.color}">${a.name}</div><div class="api-desc">${a.desc}</div>
        <div class="api-status"><span class="std ${st.cls}"></span>${st.txt}</div></div>
        <label class="tgl"><input type="checkbox" ${S.on[id]?'checked':''} onchange="S.on.${id}=this.checked;save();render()"><span class="sl"></span></label>
      </div>`;
    });
    h+=`</div>`;

    h+=`<div class="cd"><div class="ct">ğŸ”‘ API í‚¤ ì…ë ¥</div>`;
    [['claude','Claude','sk-ant-...','console.anthropic.com'],['gemini','Gemini','AIza...','aistudio.google.com'],['gpt','OpenAI GPT','sk-...','platform.openai.com'],['perplexity','Perplexity','pplx-...','perplexity.ai/settings/api'],['kis','í•œíˆ¬ ì•±í‚¤','appkey...','apiportal.koreainvestment.com'],['alphav','Alpha Vantage','key...','alphavantage.co/support']].forEach(([id,name,ph,url])=>{
      const a=APIS[id];
      h+=`<div style="margin-bottom:10px"><div style="display:flex;align-items:center;margin-bottom:4px"><span class="std ${apiStatus(id).cls}"></span><span style="font-size:11px;font-weight:700;color:${a.color}">${name}</span></div>
      <input class="si" type="password" placeholder="${ph}" value="${S.keys[id]||''}" oninput="S.keys.${id}=this.value;save();render()">
      <div style="font-size:9px;color:var(--tx3)">${url}</div></div>`;
    });
    h+=`</div>`;

    h+=`<div class="cd"><div class="ct">âš™ï¸ ì„¤ì •</div>
    <div class="rw"><div class="rn">í…Œë§ˆ</div><label class="tgl"><input type="checkbox" ${S.theme==='light'?'checked':''} onchange="S.theme=this.checked?'light':'dark';document.body.classList.toggle('light',this.checked);save()"><span class="sl"></span></label></div>
    <div class="rw"><div class="rn">í™˜ìœ¨</div><div style="font-weight:700">â‚©${F(CFG.EXCHANGE)}</div></div>
    <div class="rw"><div class="rn">ì´ë§Œí¼ ë–¨ì–´ì§€ë©´ íŒŒì„¸ìš”</div><div style="font-weight:700;color:var(--rd)">${CFG.SL}%</div></div>
    <div class="rw"><div class="rn">ì´ë§Œí¼ ì˜¤ë¥´ë©´ íŒ”ê¹Œ ê³ ë¯¼</div><div style="font-weight:700;color:var(--gn)">+${CFG.TP}%</div></div></div>`;

    h+=`<div class="cd"><div class="ct">ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µì›</div>
    <button style="width:100%;padding:10px;border-radius:7px;border:1px solid rgba(0,230,118,.2);background:rgba(0,230,118,.06);color:var(--gn);font-weight:700;font-size:11px;cursor:pointer;margin-bottom:6px" onclick="exportData()">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON ë‹¤ìš´ë¡œë“œ)</button>
    <div style="position:relative;width:100%;margin-bottom:6px"><button style="width:100%;padding:10px;border-radius:7px;border:1px solid rgba(0,176,255,.2);background:rgba(0,176,255,.06);color:#00B0FF;font-weight:700;font-size:11px;cursor:pointer" onclick="document.getElementById('importFile').click()">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON ì—…ë¡œë“œ)</button><input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)"></div>
    <div style="font-size:9px;color:var(--tx3);margin-bottom:10px;line-height:1.6">ë°±ì—… í•­ëª©: APIí‚¤, í¬íŠ¸í´ë¦¬ì˜¤, ë§¤ë§¤ê¸°ë¡, ì•Œë¦¼, AIëŒ€í™”, í…Œë§ˆ</div></div>`;

    h+=`<div class="cd"><div class="ct">ë°ì´í„° ê´€ë¦¬</div>
    <button style="width:100%;padding:8px;border-radius:7px;border:1px solid rgba(255,23,68,.15);background:transparent;color:var(--rd);font-weight:700;font-size:11px;cursor:pointer;margin-bottom:6px" onclick="if(confirm('AI ê¸°ë¡ ì‚­ì œ?')){S.aiMsgs=[];save();render()}">AI ëŒ€í™” ì‚­ì œ</button>
    <button style="width:100%;padding:8px;border-radius:7px;border:1px solid rgba(255,23,68,.15);background:transparent;color:var(--rd);font-weight:700;font-size:11px;cursor:pointer" onclick="if(confirm('ì „ì²´ ì´ˆê¸°í™”?')){localStorage.removeItem('alpha_v3');location.reload()}">ì „ì²´ ì´ˆê¸°í™”</button></div>`;
  }

  ct.innerHTML=h;rnav();
  if(S.tab==='ai'){const box=document.getElementById('chatBox');if(box)box.scrollTop=box.scrollHeight;}
  document.getElementById('clk').textContent=new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

  // MODAL
  let modal='';
  if(S.showModal==='add'){
    modal=`<div class="modal" onclick="if(event.target===this){S.showModal=null;render()}"><div class="modal-c">
    <div style="font-size:15px;font-weight:800;margin-bottom:14px">ì¢…ëª© ì¶”ê°€</div>
    <input class="si" id="ms_n" placeholder="ì¢…ëª©ì´ë¦„ (ì˜ˆ: ì‚¼ì„±ì „ì)"><input class="si" id="ms_c" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)">
    <div style="display:flex;gap:6px"><input class="si" id="ms_q" type="number" placeholder="ëª‡ ì£¼?" style="flex:1"><input class="si" id="ms_a" type="number" placeholder="ì‚° ê°€ê²©" style="flex:1"></div>
    <select class="si" id="ms_m"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select>
    <button class="sv" style="width:100%" onclick="const n=document.getElementById('ms_n').value,c=document.getElementById('ms_c').value,q=+document.getElementById('ms_q').value,a=+document.getElementById('ms_a').value,m=document.getElementById('ms_m').value;if(n&&c&&q&&a){S.portfolio.push({n,c,m,qty:q,avg:a,cc:m==='KR'?'â‚©':'$'});S.showModal=null;save();render()}">ì¶”ê°€</button></div></div>`;
  }
  if(S.showModal==='alert'){
    modal=`<div class="modal" onclick="if(event.target===this){S.showModal=null;render()}"><div class="modal-c">
    <div style="font-size:15px;font-weight:800;margin-bottom:14px">ì•Œë¦¼ ì¶”ê°€</div>
    <input class="si" id="al_c" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)"><input class="si" id="al_p" type="number" placeholder="ì•Œë¦¼ ë°›ì„ ê°€ê²©">
    <select class="si" id="al_t"><option value="above">ì´ ê°€ê²© ë„˜ìœ¼ë©´ ì•Œë¦¼</option><option value="below">ì´ ê°€ê²© ë°‘ìœ¼ë¡œ ê°€ë©´ ì•Œë¦¼</option></select>
    <button class="sv" style="width:100%" onclick="const c=document.getElementById('al_c').value,p=+document.getElementById('al_p').value,t=document.getElementById('al_t').value,st=stocks.find(s=>s.c===c);if(c&&p){S.alerts.push({code:c,name:st?st.n:c,price:p,type:t,cc:st?st.cur:'â‚©',fired:false,msg:''});S.showModal=null;save();render()}">ì¶”ê°€</button></div></div>`;
  }
  if(S.showModal==='trade'){
    modal=`<div class="modal" onclick="if(event.target===this){S.showModal=null;render()}"><div class="modal-c">
    <div style="font-size:15px;font-weight:800;margin-bottom:14px">ê±°ë˜ ê¸°ë¡ ì¶”ê°€</div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <div class="pl" id="tt_buy" style="flex:1;text-align:center;background:rgba(0,230,118,.1);color:var(--gn);border-color:rgba(0,230,118,.2)" onclick="document.querySelectorAll('#tt_buy,#tt_sell,#tt_hold').forEach(e=>{e.style.background='var(--bg2)';e.style.color='var(--tx3)';e.style.borderColor='var(--bd)'});this.style.background='rgba(0,230,118,.1)';this.style.color='var(--gn)';this.style.borderColor='rgba(0,230,118,.2)';document.getElementById('tt_val').value='ìƒ€ë‹¤'">ğŸŸ¢ ìƒ€ë‹¤</div>
      <div class="pl" id="tt_sell" style="flex:1;text-align:center" onclick="document.querySelectorAll('#tt_buy,#tt_sell,#tt_hold').forEach(e=>{e.style.background='var(--bg2)';e.style.color='var(--tx3)';e.style.borderColor='var(--bd)'});this.style.background='rgba(255,23,68,.1)';this.style.color='var(--rd)';this.style.borderColor='rgba(255,23,68,.2)';document.getElementById('tt_val').value='íŒ”ì•˜ë‹¤'">ğŸ”´ íŒ”ì•˜ë‹¤</div>
      <div class="pl" id="tt_hold" style="flex:1;text-align:center" onclick="document.querySelectorAll('#tt_buy,#tt_sell,#tt_hold').forEach(e=>{e.style.background='var(--bg2)';e.style.color='var(--tx3)';e.style.borderColor='var(--bd)'});this.style.background='rgba(255,214,0,.1)';this.style.color='var(--yl)';this.style.borderColor='rgba(255,214,0,.2)';document.getElementById('tt_val').value='í™€ë”©ì¤‘'">ğŸŸ¡ í™€ë”©ì¤‘</div>
    </div>
    <input type="hidden" id="tt_val" value="ìƒ€ë‹¤">
    <input class="si" id="tt_name" placeholder="ì¢…ëª©ì´ë¦„ (ì˜ˆ: ì‚¼ì„±ì „ì)">
    <input class="si" id="tt_code" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)">
    <div style="display:flex;gap:6px"><input class="si" id="tt_qty" type="number" placeholder="ëª‡ ì£¼?" style="flex:1"><input class="si" id="tt_price" type="number" placeholder="ê°€ê²©" style="flex:1"></div>
    <input class="si" id="tt_profit" type="number" placeholder="ì†ìµ (íŒ”ì•˜ì„ë•Œë§Œ, ì˜ˆ: 150000)">
    <input class="si" id="tt_memo" placeholder="ë©”ëª¨ (ì„ íƒ)">
    <input class="si" id="tt_date" type="date" value="${new Date().toISOString().split('T')[0]}">
    <select class="si" id="tt_market"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select>
    <button class="sv" style="width:100%" onclick="const type=document.getElementById('tt_val').value,name=document.getElementById('tt_name').value,code=document.getElementById('tt_code').value,qty=+document.getElementById('tt_qty').value,price=+document.getElementById('tt_price').value,profit=+document.getElementById('tt_profit').value||0,memo=document.getElementById('tt_memo').value,date=document.getElementById('tt_date').value+'T09:00:00',market=document.getElementById('tt_market').value;if(name&&price){S.tradeLog.unshift({type,name,code,qty,price,amount:qty*price,profit,memo,cc:market==='KR'?'â‚©':'$',market,date,active:type==='í™€ë”©ì¤‘'});S.showModal=null;save();render()}">ê¸°ë¡ ì¶”ê°€</button></div></div>`;
  }
  document.getElementById('modal').innerHTML=modal;
}

render();
setInterval(()=>{const c=document.getElementById('clk');if(c)c.textContent=new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);

function exportData(){
  const data=JSON.parse(localStorage.getItem('alpha_v3')||'{}');
  data._exportDate=new Date().toISOString();
  data._version='alpha_v3';
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const d=new Date();
  a.href=url;a.download=`alpha_backup_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`;
  a.click();URL.revokeObjectURL(url);
}

function importData(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(!data.portfolio&&!data.keys){alert('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼');return;}
      if(!confirm(`ë°±ì—… ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‚ ì§œ: ${data._exportDate?new Date(data._exportDate).toLocaleString('ko-KR'):'ì•Œ ìˆ˜ ì—†ìŒ'}\ní¬íŠ¸í´ë¦¬ì˜¤: ${data.portfolio?data.portfolio.length+'ì¢…ëª©':'ì—†ìŒ'}\në§¤ë§¤ê¸°ë¡: ${data.tradeLog?data.tradeLog.length+'ê±´':'ì—†ìŒ'}\nAIëŒ€í™”: ${data.aiMsgs?data.aiMsgs.length+'ê±´':'ì—†ìŒ'}\n\nâš ï¸ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`))return;
      delete data._exportDate;delete data._version;
      Object.keys(data).forEach(k=>{if(S.hasOwnProperty(k))S[k]=data[k];});
      save();
      if(S.theme==='light')document.body.classList.add('light');else document.body.classList.remove('light');
      render();
      alert('âœ… ë³µì› ì™„ë£Œ!');
    }catch(err){alert('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: '+err.message);}
  };
  reader.readAsText(file);
  event.target.value='';
}
</script>
</body>
</html>
