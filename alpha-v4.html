<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ALPHA ENGINE v4.0 - ì£¼ì‹ íˆ¬ì ë„ìš°ë¯¸</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #12121a;
  --bg3: #1a1a2e;
  --bg4: #252540;
  --text: #e8e8f0;
  --text2: #a0a0b8;
  --text3: #6a6a80;
  --accent: #6c5ce7;
  --accent2: #a29bfe;
  --green: #00d67e;
  --red: #ff4757;
  --yellow: #ffa502;
  --blue: #3742fa;
  --cyan: #00d2d3;
  --border: rgba(255,255,255,0.06);
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --radius: 14px;
  --radius-sm: 8px;
}
[data-theme="light"] {
  --bg: #f5f5fa;
  --bg2: #ffffff;
  --bg3: #eeeef5;
  --bg4: #dddde8;
  --text: #1a1a2e;
  --text2: #555570;
  --text3: #8888a0;
  --border: rgba(0,0,0,0.08);
  --shadow: 0 4px 24px rgba(0,0,0,0.1);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 4px; }

/* Header */
.header {
  padding: 16px 20px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-title {
  font-size: 18px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.header-ver {
  font-size: 10px;
  color: var(--text3);
  font-weight: 400;
}
.header-actions { display: flex; gap: 8px; align-items: center; }
.theme-toggle {
  width: 36px; height: 36px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* Tabs */
.tab-bar {
  display: flex;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
  position: sticky;
  top: 60px;
  z-index: 99;
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.tab-bar::-webkit-scrollbar { display: none; }
.tab-btn {
  flex: 1;
  min-width: 54px;
  padding: 10px 4px 8px;
  text-align: center;
  font-size: 10px;
  font-weight: 500;
  color: var(--text3);
  background: none;
  border: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}
.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.tab-btn .tab-icon { font-size: 18px; display: block; margin-bottom: 2px; }

/* Tab Content */
.tab-content { display: none; padding: 16px; padding-bottom: 80px; }
.tab-content.active { display: block; }

/* Cards */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
}
.card-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-title .icon { font-size: 18px; }

/* Buttons */
.btn {
  padding: 10px 18px;
  border-radius: var(--radius-sm);
  border: none;
  font-family: 'Outfit', sans-serif;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), #8b7cf7);
  color: white;
}
.btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-sm { padding: 6px 12px; font-size: 11px; }
.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-green { background: var(--green); color: #000; }
.btn-red { background: var(--red); color: #fff; }
.btn-yellow { background: var(--yellow); color: #000; }

/* Input */
.input-group { margin-bottom: 10px; }
.input-group label {
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 4px;
  display: block;
}
.input-field {
  width: 100%;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  outline: none;
}
.input-field:focus { border-color: var(--accent); }
select.input-field { appearance: none; }
textarea.input-field { resize: vertical; min-height: 60px; }

/* Toggle Switch */
.toggle-wrap {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
}
.toggle-label { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
.toggle {
  width: 44px; height: 24px;
  background: var(--bg4);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
  flex-shrink: 0;
}
.toggle.on { background: var(--green); }
.toggle::after {
  content: '';
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 3px; left: 3px;
  transition: transform 0.3s;
}
.toggle.on::after { transform: translateX(20px); }

/* API Card */
.api-card {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 8px;
}
.api-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.api-name { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.api-key-input {
  width: 100%;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 11px;
  outline: none;
}

/* Chat */
.chat-container {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.chat-msg {
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
  max-width: 90%;
  word-break: break-word;
}
.chat-user {
  background: var(--accent);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.chat-ai {
  background: var(--bg3);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.chat-input-wrap {
  display: flex;
  gap: 8px;
  align-items: flex-end;
}
.chat-input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  outline: none;
  max-height: 80px;
  resize: none;
}
.chat-send {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  border: none;
  font-size: 16px;
  cursor: pointer;
  flex-shrink: 0;
}
.chat-img-btn {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--bg4);
  color: var(--text2);
  border: none;
  font-size: 16px;
  cursor: pointer;
  flex-shrink: 0;
}

/* Cross Verification */
.verdict-box {
  padding: 16px;
  border-radius: var(--radius);
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  margin-top: 12px;
}
.verdict-buy { background: rgba(0,214,126,0.15); color: var(--green); border: 1px solid var(--green); }
.verdict-sell { background: rgba(255,71,87,0.15); color: var(--red); border: 1px solid var(--red); }
.verdict-hold { background: rgba(255,165,2,0.15); color: var(--yellow); border: 1px solid var(--yellow); }

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}
.stat-card {
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 12px;
  text-align: center;
}
.stat-value {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 2px;
}
.stat-label {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
}

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}
.data-table th {
  padding: 8px 6px;
  text-align: left;
  font-weight: 600;
  color: var(--text3);
  border-bottom: 1px solid var(--border);
  font-size: 10px;
}
.data-table td {
  padding: 8px 6px;
  border-bottom: 1px solid var(--border);
}
.data-table tr:last-child td { border-bottom: none; }

/* Stock List */
.stock-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.stock-item:last-child { border-bottom: none; }
.stock-name { font-size: 13px; font-weight: 600; }
.stock-code { font-size: 10px; color: var(--text3); }
.stock-price { font-size: 14px; font-weight: 700; text-align: right; }
.stock-change { font-size: 11px; }
.pos { color: var(--green); }
.neg { color: var(--red); }

/* Chart placeholder */
.chart-area {
  width: 100%;
  height: 200px;
  background: var(--bg3);
  border-radius: var(--radius-sm);
  margin-bottom: 12px;
  position: relative;
  overflow: hidden;
}
.chart-canvas { width: 100%; height: 100%; }

/* Portfolio item */
.port-item {
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 8px;
}
.port-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.port-detail { font-size: 11px; color: var(--text2); margin-top: 6px; }

/* Record Item */
.record-item {
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 8px;
  border-left: 3px solid var(--text3);
}
.record-item.buy { border-left-color: var(--green); }
.record-item.sell { border-left-color: var(--red); }
.record-item.hold { border-left-color: var(--yellow); }

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  justify-content: center;
  align-items: flex-end;
}
.modal-overlay.show { display: flex; }
.modal-content {
  background: var(--bg2);
  width: 100%;
  max-width: 430px;
  max-height: 85vh;
  border-radius: 20px 20px 0 0;
  padding: 24px 20px;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal-title { font-size: 16px; font-weight: 700; }
.modal-close {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--bg3);
  border: none;
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
}

/* Backtest */
.strat-card {
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--border);
}
.strat-name { font-size: 13px; font-weight: 700; margin-bottom: 6px; }
.strat-desc { font-size: 11px; color: var(--text2); margin-bottom: 10px; }
.strat-stats {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 6px;
}
.strat-stat {
  text-align: center;
  padding: 6px;
  background: var(--bg);
  border-radius: 6px;
}
.strat-stat-val { font-size: 14px; font-weight: 700; }
.strat-stat-lbl { font-size: 9px; color: var(--text3); }

/* Filter buttons */
.filter-bar {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.filter-btn {
  padding: 5px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text2);
  font-size: 11px;
  font-family: 'Outfit', sans-serif;
  cursor: pointer;
}
.filter-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* Score bar */
.score-bar-wrap { margin: 8px 0; }
.score-bar {
  height: 6px;
  background: var(--bg4);
  border-radius: 3px;
  overflow: hidden;
}
.score-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s;
}

/* Candle chart styles */
.candle-green { fill: var(--green); stroke: var(--green); }
.candle-red { fill: var(--red); stroke: var(--red); }

/* Responsive */
@media (max-width: 430px) {
  body { max-width: 100vw; }
}

/* Monthly summary */
.month-summary {
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 10px;
  margin-bottom: 6px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 6px;
  font-size: 10px;
}
.month-label { font-weight: 700; font-size: 12px; }
.month-val { color: var(--text2); }

/* Export/Import buttons */
.data-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}
</style>
</head>
<body>
<!-- Header -->
<div class="header">
  <div>
    <div class="header-title">ALPHA ENGINE <span class="header-ver">v4.0</span></div>
  </div>
  <div class="header-actions">
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
  </div>
</div>

<!-- Tab Bar -->
<div class="tab-bar" id="tabBar">
  <button class="tab-btn active" data-tab="home"><span class="tab-icon">ğŸ“Š</span>í™ˆ</button>
  <button class="tab-btn" data-tab="scan"><span class="tab-icon">ğŸ”</span>ìŠ¤ìº”</button>
  <button class="tab-btn" data-tab="portfolio"><span class="tab-icon">ğŸ’¼</span>í¬í´</button>
  <button class="tab-btn" data-tab="backtest"><span class="tab-icon">ğŸ“ˆ</span>ë°±í…Œ</button>
  <button class="tab-btn" data-tab="records"><span class="tab-icon">ğŸ“‹</span>ê¸°ë¡</button>
  <button class="tab-btn" data-tab="command"><span class="tab-icon">âš¡</span>ëª…ë ¹</button>
  <button class="tab-btn" data-tab="settings"><span class="tab-icon">âš™ï¸</span>ì„¤ì •</button>
</div>

<!-- ===== HOME TAB ===== -->
<div class="tab-content active" id="tab-home">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalAsset">0</div>
      <div class="stat-label">ì´ ìì‚°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalProfit">0%</div>
      <div class="stat-label">ì´ ìˆ˜ìµë¥ </div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="winRate">-%</div>
      <div class="stat-label">ìŠ¹ë¥ </div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="holdCount">0</div>
      <div class="stat-label">ë³´ìœ  ì¢…ëª©</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ“ˆ</span> ì‹œì¥ ìš”ì•½</div>
    <div class="stock-item">
      <div><div class="stock-name">ì½”ìŠ¤í”¼</div></div>
      <div><div class="stock-price">2,687.44</div><div class="stock-change pos">+1.22%</div></div>
    </div>
    <div class="stock-item">
      <div><div class="stock-name">ì½”ìŠ¤ë‹¥</div></div>
      <div><div class="stock-price">842.31</div><div class="stock-change neg">-0.45%</div></div>
    </div>
    <div class="stock-item">
      <div><div class="stock-name">S&P 500</div></div>
      <div><div class="stock-price">5,234.18</div><div class="stock-change pos">+0.87%</div></div>
    </div>
    <div class="stock-item">
      <div><div class="stock-name">ë‚˜ìŠ¤ë‹¥</div></div>
      <div><div class="stock-price">16,428.82</div><div class="stock-change pos">+1.15%</div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ”¥</span> ë³´ìœ  ì¢…ëª© í˜„í™©</div>
    <div id="homeHoldings"><p style="font-size:12px;color:var(--text3)">í¬íŠ¸í´ë¦¬ì˜¤ì— ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</p></div>
  </div>
</div>

<!-- ===== SCAN TAB ===== -->
<div class="tab-content" id="tab-scan">
  <div class="card">
    <div class="card-title"><span class="icon">ğŸ”</span> ì¢…ëª© ë¶„ì„</div>
    <div class="input-group">
      <label>ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥</label>
      <input type="text" class="input-field" id="scanInput" placeholder="ì‚¼ì„±ì „ì, AAPL ë“±">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" onclick="runScan()" style="flex:1">ë¶„ì„í•˜ê¸°</button>
    </div>
  </div>

  <div class="card" id="scanResult" style="display:none">
    <div class="card-title"><span class="icon">ğŸ“Š</span> ë¶„ì„ ê²°ê³¼</div>
    <div id="scanChartArea" class="chart-area">
      <canvas id="scanCanvas" class="chart-canvas"></canvas>
    </div>
    <div id="scanSignal" style="text-align:center;padding:12px;font-size:15px;font-weight:700;border-radius:8px;margin-bottom:8px"></div>
    <div id="scanDetails" style="font-size:12px;color:var(--text2)"></div>
  </div>
</div>

<!-- ===== PORTFOLIO TAB ===== -->
<div class="tab-content" id="tab-portfolio">
  <div class="card">
    <div class="card-title" style="justify-content:space-between">
      <span><span class="icon">ğŸ’¼</span> í¬íŠ¸í´ë¦¬ì˜¤</span>
      <button class="btn btn-sm btn-primary" onclick="openPortModal()">+ ì¢…ëª© ì¶”ê°€</button>
    </div>
    <div id="portfolioList"></div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ¥§</span> ìì‚° ë°°ë¶„</div>
    <div class="chart-area" style="height:200px">
      <canvas id="pieCanvas" class="chart-canvas"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ’°</span> ì„¸í›„ ì†ìµ ìš”ì•½</div>
    <div id="portSummary"></div>
  </div>
</div>

<!-- ===== BACKTEST TAB ===== -->
<div class="tab-content" id="tab-backtest">
  <div class="card">
    <div class="card-title"><span class="icon">ğŸ“ˆ</span> ì „ëµ ë°±í…ŒìŠ¤íŠ¸</div>
    <div class="input-group">
      <label>ì¢…ëª© ì„ íƒ</label>
      <select class="input-field" id="btStock"></select>
    </div>
    <button class="btn btn-primary" onclick="runBacktest()" style="width:100%">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
  </div>

  <div id="btResults" style="display:none">
    <div class="strat-card" id="strat1"></div>
    <div class="strat-card" id="strat2"></div>
    <div class="strat-card" id="strat3"></div>
  </div>
</div>

<!-- ===== RECORDS TAB ===== -->
<div class="tab-content" id="tab-records">
  <div class="card">
    <div class="card-title" style="justify-content:space-between">
      <span><span class="icon">ğŸ“‹</span> ë§¤ë§¤ ê¸°ë¡</span>
      <button class="btn btn-sm btn-primary" onclick="openRecordModal()">+ ê¸°ë¡ ì¶”ê°€</button>
    </div>

    <div class="filter-bar" id="recordFilter">
      <button class="filter-btn active" data-filter="all">ì „ì²´</button>
      <button class="filter-btn" data-filter="today">ì˜¤ëŠ˜</button>
      <button class="filter-btn" data-filter="week">ì´ë²ˆì£¼</button>
      <button class="filter-btn" data-filter="month">ì´ë²ˆë‹¬</button>
      <button class="filter-btn" data-filter="year">ì˜¬í•´</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="recTotal">0ê±´</div>
        <div class="stat-label">ì´ ê±°ë˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="recWinRate">-%</div>
        <div class="stat-label">ìŠ¹ë¥ </div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="recProfit">0</div>
        <div class="stat-label">ì‹¤í˜„ ì†ìµ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="recHolds">0</div>
        <div class="stat-label">í™€ë”© ì¤‘</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ“…</span> ì›”ë³„ ìš”ì•½</div>
    <div id="monthlySummary"></div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ“Œ</span> í˜„ì¬ í™€ë”© í˜„í™©</div>
    <div id="holdingStatus"></div>
  </div>

  <div id="recordsList"></div>
</div>

<!-- ===== COMMAND TAB ===== -->
<div class="tab-content" id="tab-command">
  <div class="card">
    <div class="card-title"><span class="icon">âš¡</span> í†µí•© ëª…ë ¹ì„¼í„°</div>
    <p style="font-size:11px;color:var(--text2);margin-bottom:12px">
      ê¶ê¸ˆí•œ ì¢…ëª©ì„ ë¬¼ì–´ë³´ì„¸ìš”. AIê°€ "ì‚¬ë¼ / íŒ”ì•„ë¼ / ê¸°ë‹¤ë ¤ë¼" ë”± í•˜ë‚˜ë§Œ ì•Œë ¤ì¤ë‹ˆë‹¤.
    </p>
    <div class="chat-container" id="chatContainer"></div>
    <div class="chat-input-wrap">
      <input type="file" id="chatImageInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
      <button class="chat-img-btn" onclick="document.getElementById('chatImageInput').click()" title="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ“·</button>
      <textarea class="chat-input" id="chatInput" placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì‚¼ì„±ì „ì)" rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button class="chat-send" onclick="sendChat()">â¤</button>
    </div>
    <div id="imagePreview" style="display:none;margin-top:8px;position:relative">
      <img id="previewImg" style="max-height:100px;border-radius:8px;border:1px solid var(--border)">
      <button onclick="clearImagePreview()" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer">âœ•</button>
    </div>
  </div>

  <div class="card" id="crossVerifyBox" style="display:none">
    <div class="card-title"><span class="icon">ğŸ”€</span> êµì°¨ê²€ì¦ ê²°ê³¼</div>
    <div id="crossResults"></div>
    <div id="finalVerdict"></div>
  </div>
</div>

<!-- ===== SETTINGS TAB ===== -->
<div class="tab-content" id="tab-settings">
  <div class="card">
    <div class="card-title"><span class="icon">ğŸ”‘</span> API ì„¤ì •</div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸŸ£ Claude (ë§¤ë§¤ ë¶„ì„)</span>
        <div class="toggle" id="toggleClaude" onclick="toggleAPI('claude')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyClaude" placeholder="Claude API í‚¤ ì…ë ¥" onchange="saveAPIKey('claude')">
    </div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸ”µ Gemini (ë§¤ë§¤ ë¶„ì„)</span>
        <div class="toggle" id="toggleGemini" onclick="toggleAPI('gemini')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyGemini" placeholder="Gemini API í‚¤ ì…ë ¥" onchange="saveAPIKey('gemini')">
    </div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸŸ¢ GPT (3ì¤‘ êµì°¨ê²€ì¦)</span>
        <div class="toggle" id="toggleGPT" onclick="toggleAPI('gpt')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyGPT" placeholder="GPT API í‚¤ ì…ë ¥" onchange="saveAPIKey('gpt')">
    </div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸ” Perplexity (ì‹¤ì‹œê°„ ë‰´ìŠ¤)</span>
        <div class="toggle" id="togglePerplexity" onclick="toggleAPI('perplexity')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyPerplexity" placeholder="Perplexity API í‚¤ ì…ë ¥" onchange="saveAPIKey('perplexity')">
    </div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸ‡°ğŸ‡· í•œêµ­íˆ¬ìì¦ê¶Œ (í•œêµ­ ì£¼ê°€)</span>
        <div class="toggle" id="toggleKIS" onclick="toggleAPI('kis')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyKIS" placeholder="ì•±í‚¤ ì…ë ¥ (ì„œë²„ êµ¬ì¶• ì‹œ ì—°ë™)" onchange="saveAPIKey('kis')">
    </div>

    <div class="api-card">
      <div class="api-header">
        <span class="api-name">ğŸ‡ºğŸ‡¸ Alpha Vantage (ë¯¸êµ­ ì£¼ê°€)</span>
        <div class="toggle" id="toggleAlpha" onclick="toggleAPI('alpha')"></div>
      </div>
      <input type="password" class="api-key-input" id="keyAlpha" placeholder="Alpha Vantage API í‚¤ ì…ë ¥" onchange="saveAPIKey('alpha')">
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ’±</span> ì„¸ê¸ˆÂ·ìˆ˜ìˆ˜ë£ŒÂ·í™˜ìœ¨</div>
    <div style="font-size:12px;color:var(--text2);line-height:1.8">
      <div>ğŸ‡°ğŸ‡· í•œêµ­ ì„¸ê¸ˆ: 0.23% / ìˆ˜ìˆ˜ë£Œ: 0.015%</div>
      <div>ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ìˆ˜ìˆ˜ë£Œ: 0.07%</div>
      <div>ğŸ’± í™˜ìœ¨: 1,380ì›/$ (ê³ ì •)</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title"><span class="icon">ğŸ’¾</span> ë°ì´í„° ê´€ë¦¬</div>
    <div class="data-actions">
      <button class="btn btn-outline" onclick="exportData()" style="flex:1">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-outline" onclick="document.getElementById('importFile').click()" style="flex:1">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>
    <button class="btn btn-red btn-sm" onclick="if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')){localStorage.clear();location.reload()}" style="width:100%">ğŸ—‘ ë°ì´í„° ì´ˆê¸°í™”</button>
  </div>
</div>

<!-- ===== MODALS ===== -->
<!-- Portfolio Add Modal -->
<div class="modal-overlay" id="portModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ì¢…ëª© ì¶”ê°€</div>
      <button class="modal-close" onclick="closePortModal()">âœ•</button>
    </div>
    <div class="input-group">
      <label>ì‹œì¥</label>
      <select class="input-field" id="pmMarket">
        <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
        <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
      </select>
    </div>
    <div class="input-group">
      <label>ì¢…ëª©ëª…</label>
      <input type="text" class="input-field" id="pmName" placeholder="ì‚¼ì„±ì „ì">
    </div>
    <div class="input-group">
      <label>ì¢…ëª©ì½”ë“œ</label>
      <input type="text" class="input-field" id="pmCode" placeholder="005930">
    </div>
    <div class="input-group">
      <label>ìˆ˜ëŸ‰</label>
      <input type="number" class="input-field" id="pmQty" placeholder="10">
    </div>
    <div class="input-group">
      <label>ë§¤ìˆ˜ í‰ê· ê°€</label>
      <input type="number" class="input-field" id="pmPrice" placeholder="72000">
    </div>
    <button class="btn btn-primary" onclick="addPortfolio()" style="width:100%">ì¶”ê°€</button>
  </div>
</div>

<!-- Record Add Modal -->
<div class="modal-overlay" id="recordModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ë§¤ë§¤ ê¸°ë¡ ì¶”ê°€</div>
      <button class="modal-close" onclick="closeRecordModal()">âœ•</button>
    </div>
    <div class="input-group">
      <label>ìœ í˜•</label>
      <select class="input-field" id="rmType">
        <option value="buy">ğŸŸ¢ ìƒ€ë‹¤</option>
        <option value="sell">ğŸ”´ íŒ”ì•˜ë‹¤</option>
        <option value="hold">ğŸŸ¡ í™€ë”©ì¤‘</option>
      </select>
    </div>
    <div class="input-group">
      <label>ì‹œì¥</label>
      <select class="input-field" id="rmMarket">
        <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
        <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
      </select>
    </div>
    <div class="input-group">
      <label>ì¢…ëª©ëª…</label>
      <input type="text" class="input-field" id="rmName" placeholder="ì‚¼ì„±ì „ì">
    </div>
    <div class="input-group">
      <label>ì¢…ëª©ì½”ë“œ</label>
      <input type="text" class="input-field" id="rmCode" placeholder="005930">
    </div>
    <div class="input-group">
      <label>ìˆ˜ëŸ‰</label>
      <input type="number" class="input-field" id="rmQty" placeholder="10">
    </div>
    <div class="input-group">
      <label>ê°€ê²©</label>
      <input type="number" class="input-field" id="rmPrice" placeholder="72000">
    </div>
    <div class="input-group">
      <label>ì†ìµ (ì› ë˜ëŠ” $)</label>
      <input type="number" class="input-field" id="rmPnl" placeholder="5000">
    </div>
    <div class="input-group">
      <label>ë‚ ì§œ</label>
      <input type="date" class="input-field" id="rmDate">
    </div>
    <div class="input-group">
      <label>ë©”ëª¨</label>
      <textarea class="input-field" id="rmMemo" placeholder="ë©”ëª¨ ì…ë ¥"></textarea>
    </div>
    <button class="btn btn-primary" onclick="addRecord()" style="width:100%">ê¸°ë¡ ì¶”ê°€</button>
  </div>
</div>

<script>
// ==================== DEMO DATA ====================
const DEMO_STOCKS = {
  KR: [
    {name:'ì‚¼ì„±ì „ì',code:'005930',price:72400,change:1.8},
    {name:'SKí•˜ì´ë‹‰ìŠ¤',code:'000660',price:178500,change:2.3},
    {name:'LGì—ë„ˆì§€ì†”ë£¨ì…˜',code:'373220',price:385000,change:-0.7},
    {name:'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤',code:'207940',price:812000,change:0.5},
    {name:'í˜„ëŒ€ìë™ì°¨',code:'005380',price:245000,change:1.1},
    {name:'ê¸°ì•„',code:'000270',price:118500,change:0.9},
    {name:'ì…€íŠ¸ë¦¬ì˜¨',code:'068270',price:198500,change:-1.2},
    {name:'KBê¸ˆìœµ',code:'105560',price:78400,change:0.6},
    {name:'ì‹ í•œì§€ì£¼',code:'055550',price:51200,change:0.3},
    {name:'í¬ìŠ¤ì½”í™€ë”©ìŠ¤',code:'005490',price:312000,change:-0.4},
    {name:'NAVER',code:'035420',price:215000,change:1.5},
    {name:'ì¹´ì¹´ì˜¤',code:'035720',price:47850,change:-0.8},
    {name:'LGí™”í•™',code:'051910',price:298000,change:0.2},
    {name:'ì‚¼ì„±SDI',code:'006400',price:365000,change:1.0}
  ],
  US: [
    {name:'Apple',code:'AAPL',price:198.45,change:0.8},
    {name:'Microsoft',code:'MSFT',price:425.22,change:1.2},
    {name:'NVIDIA',code:'NVDA',price:875.35,change:3.5},
    {name:'Google',code:'GOOGL',price:155.72,change:0.5},
    {name:'Amazon',code:'AMZN',price:185.30,change:1.8},
    {name:'Meta',code:'META',price:505.75,change:2.1},
    {name:'Tesla',code:'TSLA',price:248.42,change:-1.5},
    {name:'Berkshire',code:'BRK.B',price:415.80,change:0.3},
    {name:'JPMorgan',code:'JPM',price:198.55,change:0.7},
    {name:'Johnson&Johnson',code:'JNJ',price:158.20,change:-0.2}
  ]
};

const ALL_STOCKS = [...DEMO_STOCKS.KR.map(s=>({...s,market:'KR'})), ...DEMO_STOCKS.US.map(s=>({...s,market:'US'}))];

const EXCHANGE_RATE = 1380;
const TAX_KR = 0.0023;
const FEE_KR = 0.00015;
const FEE_US = 0.0007;

// ==================== STATE ====================
let state = {
  theme: 'dark',
  apis: { claude:false, gemini:false, gpt:false, perplexity:false, kis:false, alpha:false },
  apiKeys: { claude:'', gemini:'', gpt:'', perplexity:'', kis:'', alpha:'' },
  portfolio: [],
  records: [],
  chatHistory: [],
  pendingImage: null
};

// ==================== INIT ====================
function init() {
  loadState();
  applyTheme();
  setupTabs();
  setupFilters();
  populateBtSelect();
  renderAll();
  restoreAPIUI();
}

function loadState() {
  try {
    const saved = localStorage.getItem('alphaEngine4');
    if (saved) {
      const parsed = JSON.parse(saved);
      state = { ...state, ...parsed };
    }
    // ê¸°ë³¸ API í‚¤ ìë™ ì£¼ì… (ë¯¸ì„¤ì • ì‹œ)
    const keyDefaults = {
      gemini: 'AIzaSyCg4xE3lYbZVxWmP9vpcccmpLVxIr3Czms',
      perplexity: ['pplx-','DODV8cq9BuQG','i5slSkKkVQf9','fthREzsYH4cl','RYaBkeoOdKjw'].join(''),
      alpha: '8CEA89VHHEZIOWQY'
    };
    const apiDefaults = { gemini:true, perplexity:true };
    let injected = [];
    for (const [k,v] of Object.entries(keyDefaults)) {
      if (!state.apiKeys[k]) { state.apiKeys[k] = v; injected.push(k); }
    }
    for (const [k,v] of Object.entries(apiDefaults)) {
      if (!state.apis[k]) state.apis[k] = v;
    }
    if (injected.length) { console.log('[Alpha Engine] ê¸°ë³¸ API í‚¤ ìë™ ì„¤ì •: ' + injected.join(', ')); saveState(); }
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('alphaEngine4', JSON.stringify(state));
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', state.theme);
  document.getElementById('themeBtn').textContent = state.theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  applyTheme();
  saveState();
}

// ==================== TABS ====================
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'home') renderHome();
      if (btn.dataset.tab === 'records') renderRecords();
      if (btn.dataset.tab === 'portfolio') renderPortfolio();
      if (btn.dataset.tab === 'command') renderChat();
    });
  });
}

// ==================== FILTER ====================
function setupFilters() {
  document.querySelectorAll('#recordFilter .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#recordFilter .filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderRecords();
    });
  });
}

// ==================== RENDER ALL ====================
function renderAll() {
  renderHome();
  renderPortfolio();
  renderRecords();
  renderChat();
}

// ==================== HOME ====================
function renderHome() {
  const port = state.portfolio;
  let totalInvest = 0, totalCurrent = 0;
  port.forEach(p => {
    const demo = findStock(p.name, p.code);
    const curPrice = demo ? demo.price : p.avgPrice;
    const invest = p.qty * p.avgPrice;
    const current = p.qty * curPrice;
    if (p.market === 'US') {
      totalInvest += invest * EXCHANGE_RATE;
      totalCurrent += current * EXCHANGE_RATE;
    } else {
      totalInvest += invest;
      totalCurrent += current;
    }
  });
  const profit = totalInvest > 0 ? ((totalCurrent - totalInvest) / totalInvest * 100) : 0;

  document.getElementById('totalAsset').textContent = formatKRW(totalCurrent);
  document.getElementById('totalProfit').textContent = profit.toFixed(1) + '%';
  document.getElementById('totalProfit').style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('holdCount').textContent = port.length;

  // Win rate
  const sellRecords = state.records.filter(r => r.type === 'sell');
  const wins = sellRecords.filter(r => (r.pnl || 0) > 0).length;
  document.getElementById('winRate').textContent = sellRecords.length > 0 ? (wins/sellRecords.length*100).toFixed(0) + '%' : '-%';

  // Holdings on home
  const el = document.getElementById('homeHoldings');
  if (port.length === 0) {
    el.innerHTML = '<p style="font-size:12px;color:var(--text3)">í¬íŠ¸í´ë¦¬ì˜¤ì— ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</p>';
    return;
  }
  el.innerHTML = port.map(p => {
    const demo = findStock(p.name, p.code);
    const curPrice = demo ? demo.price : p.avgPrice;
    const pnlPct = ((curPrice - p.avgPrice) / p.avgPrice * 100);
    const flag = p.market === 'US' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡°ğŸ‡·';
    const verdict = getAutoVerdict(pnlPct);
    return `<div class="stock-item">
      <div>
        <div class="stock-name">${flag} ${p.name}</div>
        <div class="stock-code">${p.qty}ì£¼ Â· í‰ê·  ${formatNum(p.avgPrice)}</div>
      </div>
      <div style="text-align:right">
        <div class="stock-price">${formatNum(curPrice)}</div>
        <div class="stock-change ${pnlPct>=0?'pos':'neg'}">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}% ${verdict}</div>
      </div>
    </div>`;
  }).join('');
}

function getAutoVerdict(pct) {
  if (pct >= 5) return 'âš ï¸ìµì ˆê²€í† ';
  if (pct <= -3) return 'ğŸš¨ì¦‰ì‹œì†ì ˆ';
  return '';
}

// ==================== SCAN ====================
function runScan() {
  const input = document.getElementById('scanInput').value.trim();
  if (!input) return;
  const stock = ALL_STOCKS.find(s =>
    s.name.toLowerCase().includes(input.toLowerCase()) ||
    s.code.toLowerCase() === input.toLowerCase()
  );
  if (!stock) {
    alert('ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ëª¨ ì¢…ëª© 24ê°œ ì¤‘ì—ì„œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.');
    return;
  }

  document.getElementById('scanResult').style.display = 'block';

  // Generate 120 days of price data
  const prices = generatePriceData(stock.price, 120);
  drawCandleChart('scanCanvas', prices);

  // Technical scoring (internal only)
  const score = computeTechScore(prices);
  const signal = getSignalText(score);

  document.getElementById('scanSignal').textContent = signal.text;
  document.getElementById('scanSignal').style.background = signal.bg;
  document.getElementById('scanSignal').style.color = signal.color;

  document.getElementById('scanDetails').innerHTML = `
    <div style="margin-top:8px">
      <div><b>${stock.name}</b> (${stock.code}) Â· ${stock.market === 'US' ? 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­' : 'ğŸ‡°ğŸ‡· í•œêµ­'}</div>
      <div>í˜„ì¬ê°€: ${formatNum(stock.price)} ${stock.market === 'US' ? '$' : 'ì›'}</div>
      <div>ë“±ë½: <span class="${stock.change>=0?'pos':'neg'}">${stock.change>=0?'+':''}${stock.change}%</span></div>
      <div style="margin-top:8px">
        <div class="score-bar-wrap">
          <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3)">
            <span>íŒ”ì•„ì•¼í•´ìš”</span><span>ê¸°ë‹¤ë ¤ìš”</span><span>ì‚¬ë„ë¼ìš”</span>
          </div>
          <div class="score-bar">
            <div class="score-fill" style="width:${score}%;background:${score>60?'var(--green)':score>40?'var(--yellow)':'var(--red)'}"></div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ==================== PORTFOLIO ====================
function renderPortfolio() {
  const el = document.getElementById('portfolioList');
  if (state.portfolio.length === 0) {
    el.innerHTML = '<p style="font-size:12px;color:var(--text3)">ì¢…ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
    document.getElementById('portSummary').innerHTML = '';
    drawPieChart();
    return;
  }

  let html = '';
  let summaryHtml = '';
  state.portfolio.forEach((p, i) => {
    const demo = findStock(p.name, p.code);
    const curPrice = demo ? demo.price : p.avgPrice;
    const invest = p.qty * p.avgPrice;
    const current = p.qty * curPrice;
    const pnl = current - invest;
    const pnlPct = (pnl / invest * 100);

    // Tax & fee calculation
    let fee, tax, netPnl;
    if (p.market === 'US') {
      fee = current * FEE_US;
      tax = 0;
      netPnl = pnl - fee;
    } else {
      fee = current * FEE_KR;
      tax = current * TAX_KR;
      netPnl = pnl - fee - tax;
    }

    const flag = p.market === 'US' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡°ğŸ‡·';
    const currency = p.market === 'US' ? '$' : 'ì›';
    const verdict = getAutoVerdict(pnlPct);

    html += `<div class="port-item">
      <div class="port-row">
        <div>
          <div style="font-size:14px;font-weight:700">${flag} ${p.name}</div>
          <div style="font-size:11px;color:var(--text3)">${p.code} Â· ${p.qty}ì£¼</div>
        </div>
        <div style="text-align:right">
          <div class="stock-change ${pnlPct>=0?'pos':'neg'}" style="font-size:14px;font-weight:700">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%</div>
          <div style="font-size:11px;color:var(--text3)">${verdict}</div>
        </div>
      </div>
      <div class="port-detail">
        í‰ê· ê°€ ${formatNum(p.avgPrice)}${currency} â†’ í˜„ì¬ê°€ ${formatNum(curPrice)}${currency}
        ${p.market==='US' ? ' (ì›í™”: '+formatKRW(current*EXCHANGE_RATE)+')' : ''}
      </div>
      <div style="margin-top:6px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--text3)">ì„¸í›„ì†ìµ: <span class="${netPnl>=0?'pos':'neg'}">${netPnl>=0?'+':''}${formatNum(Math.round(netPnl))}${currency}</span></span>
        <button class="btn btn-sm btn-red" onclick="removePortfolio(${i})" style="padding:4px 8px;font-size:10px">ì‚­ì œ</button>
      </div>
    </div>`;

    summaryHtml += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
      <span>${flag} ${p.name}</span>
      <div style="text-align:right">
        <div>ìˆ˜ìˆ˜ë£Œ: ${formatNum(Math.round(fee))}${currency}</div>
        ${p.market==='KR'?'<div>ì„¸ê¸ˆ: '+formatNum(Math.round(tax))+'ì›</div>':''}
        <div class="${netPnl>=0?'pos':'neg'}">ì„¸í›„: ${netPnl>=0?'+':''}${formatNum(Math.round(netPnl))}${currency}</div>
      </div>
    </div>`;
  });

  el.innerHTML = html;
  document.getElementById('portSummary').innerHTML = summaryHtml || '<p style="font-size:12px;color:var(--text3)">í¬íŠ¸í´ë¦¬ì˜¤ ì¢…ëª©ì˜ ì„¸í›„ ì†ìµì´ í‘œì‹œë©ë‹ˆë‹¤</p>';
  drawPieChart();
}

function openPortModal() { document.getElementById('portModal').classList.add('show'); }
function closePortModal() { document.getElementById('portModal').classList.remove('show'); }

function addPortfolio() {
  const name = document.getElementById('pmName').value.trim();
  const code = document.getElementById('pmCode').value.trim();
  const qty = parseInt(document.getElementById('pmQty').value);
  const price = parseFloat(document.getElementById('pmPrice').value);
  const market = document.getElementById('pmMarket').value;
  if (!name || !code || !qty || !price) { alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
  state.portfolio.push({ name, code, qty, avgPrice: price, market });
  saveState();
  closePortModal();
  renderPortfolio();
  renderHome();
  // Clear form
  ['pmName','pmCode','pmQty','pmPrice'].forEach(id => document.getElementById(id).value = '');
}

function removePortfolio(idx) {
  if (!confirm(state.portfolio[idx].name + ' ì¢…ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  state.portfolio.splice(idx, 1);
  saveState();
  renderPortfolio();
  renderHome();
}

function drawPieChart() {
  const canvas = document.getElementById('pieCanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.parentElement.clientWidth;
  const h = 200;
  canvas.width = w * 2;
  canvas.height = h * 2;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.scale(2, 2);
  ctx.clearRect(0, 0, w, h);

  if (state.portfolio.length === 0) {
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text3');
    ctx.font = '12px Outfit';
    ctx.textAlign = 'center';
    ctx.fillText('ì¢…ëª©ì„ ì¶”ê°€í•˜ë©´ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤', w/2, h/2);
    return;
  }

  const colors = ['#6c5ce7','#00d67e','#ff4757','#ffa502','#3742fa','#00d2d3','#a29bfe','#ff6b81','#7bed9f','#70a1ff'];
  const values = state.portfolio.map(p => {
    const demo = findStock(p.name, p.code);
    const curPrice = demo ? demo.price : p.avgPrice;
    let val = p.qty * curPrice;
    if (p.market === 'US') val *= EXCHANGE_RATE;
    return val;
  });
  const total = values.reduce((a,b) => a+b, 0);

  const cx = w * 0.35, cy = h / 2, r = Math.min(cx, cy) - 10;
  let startAngle = -Math.PI / 2;

  values.forEach((val, i) => {
    const slice = (val / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, startAngle, startAngle + slice);
    ctx.fillStyle = colors[i % colors.length];
    ctx.fill();
    startAngle += slice;
  });

  // Legend
  let ly = 20;
  state.portfolio.forEach((p, i) => {
    ctx.fillStyle = colors[i % colors.length];
    ctx.fillRect(w * 0.7, ly, 10, 10);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
    ctx.font = '11px Outfit';
    ctx.textAlign = 'left';
    ctx.fillText(`${p.name} ${(values[i]/total*100).toFixed(0)}%`, w * 0.7 + 14, ly + 9);
    ly += 18;
  });
}

// ==================== RECORDS ====================
function renderRecords() {
  const filter = document.querySelector('#recordFilter .filter-btn.active')?.dataset.filter || 'all';
  const now = new Date();
  let filtered = state.records;

  if (filter === 'today') {
    filtered = filtered.filter(r => r.date === toDateStr(now));
  } else if (filter === 'week') {
    const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 7);
    filtered = filtered.filter(r => new Date(r.date) >= weekAgo);
  } else if (filter === 'month') {
    filtered = filtered.filter(r => r.date && r.date.substring(0,7) === toDateStr(now).substring(0,7));
  } else if (filter === 'year') {
    filtered = filtered.filter(r => r.date && r.date.substring(0,4) === String(now.getFullYear()));
  }

  // Stats
  const sells = filtered.filter(r => r.type === 'sell');
  const wins = sells.filter(r => (r.pnl||0) > 0).length;
  const totalPnl = sells.reduce((s, r) => s + (r.pnl||0), 0);
  const holds = filtered.filter(r => r.type === 'hold');

  document.getElementById('recTotal').textContent = filtered.length + 'ê±´';
  document.getElementById('recWinRate').textContent = sells.length > 0 ? (wins/sells.length*100).toFixed(0)+'%' : '-%';
  document.getElementById('recProfit').textContent = formatNum(totalPnl);
  document.getElementById('recProfit').style.color = totalPnl >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('recHolds').textContent = holds.length;

  // Monthly summary
  const months = {};
  state.records.forEach(r => {
    const m = r.date ? r.date.substring(0,7) : 'unknown';
    if (!months[m]) months[m] = { count:0, buyTotal:0, sellTotal:0, pnl:0 };
    months[m].count++;
    if (r.type === 'buy') months[m].buyTotal += (r.qty||0) * (r.price||0);
    if (r.type === 'sell') {
      months[m].sellTotal += (r.qty||0) * (r.price||0);
      months[m].pnl += (r.pnl||0);
    }
  });
  const monthKeys = Object.keys(months).sort().reverse();
  document.getElementById('monthlySummary').innerHTML = monthKeys.length === 0
    ? '<p style="font-size:12px;color:var(--text3)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>'
    : monthKeys.map(m => `<div class="month-summary">
        <div><div class="month-label">${m}</div></div>
        <div><div class="month-val">${months[m].count}ê±´</div></div>
        <div><div class="month-val">ë§¤ìˆ˜ ${formatNum(months[m].buyTotal)}</div></div>
        <div><div class="month-val ${months[m].pnl>=0?'pos':'neg'}">ì†ìµ ${formatNum(months[m].pnl)}</div></div>
      </div>`).join('');

  // Holding status
  document.getElementById('holdingStatus').innerHTML = holds.length === 0
    ? '<p style="font-size:12px;color:var(--text3)">í™€ë”© ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'
    : holds.map(r => {
      const demo = findStock(r.name, r.code);
      const curPrice = demo ? demo.price : r.price;
      const pnlPct = ((curPrice - r.price) / r.price * 100);
      return `<div class="stock-item">
        <div><div class="stock-name">${r.market==='US'?'ğŸ‡ºğŸ‡¸':'ğŸ‡°ğŸ‡·'} ${r.name}</div><div class="stock-code">${r.qty}ì£¼ Â· ${formatNum(r.price)}</div></div>
        <div style="text-align:right"><div class="stock-price">${formatNum(curPrice)}</div><div class="stock-change ${pnlPct>=0?'pos':'neg'}">${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%</div></div>
      </div>`;
    }).join('');

  // Records list
  document.getElementById('recordsList').innerHTML = filtered.length === 0
    ? '<div class="card"><p style="font-size:12px;color:var(--text3)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'
    : filtered.map((r, i) => {
      const typeLabel = r.type === 'buy' ? 'ğŸŸ¢ ìƒ€ë‹¤' : r.type === 'sell' ? 'ğŸ”´ íŒ”ì•˜ë‹¤' : 'ğŸŸ¡ í™€ë”©ì¤‘';
      const flag = r.market === 'US' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡°ğŸ‡·';
      return `<div class="record-item ${r.type}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-weight:700;font-size:13px">${typeLabel} ${flag} ${r.name}</span>
          <button onclick="deleteRecord(${state.records.indexOf(r)})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px">âœ•</button>
        </div>
        <div style="font-size:11px;color:var(--text2)">
          ${r.code} Â· ${r.qty}ì£¼ Â· ${formatNum(r.price)} Â· ${r.date}
          ${r.type==='sell'?'<br>ì†ìµ: <span class=\"'+(r.pnl>=0?'pos':'neg')+'\">'+formatNum(r.pnl)+'</span>':''}
          ${r.memo?'<br>ë©”ëª¨: '+r.memo:''}
        </div>
      </div>`;
    }).join('');
}

function openRecordModal() {
  document.getElementById('rmDate').value = toDateStr(new Date());
  document.getElementById('recordModal').classList.add('show');
}
function closeRecordModal() { document.getElementById('recordModal').classList.remove('show'); }

function addRecord() {
  const type = document.getElementById('rmType').value;
  const market = document.getElementById('rmMarket').value;
  const name = document.getElementById('rmName').value.trim();
  const code = document.getElementById('rmCode').value.trim();
  const qty = parseInt(document.getElementById('rmQty').value) || 0;
  const price = parseFloat(document.getElementById('rmPrice').value) || 0;
  const pnl = parseFloat(document.getElementById('rmPnl').value) || 0;
  const date = document.getElementById('rmDate').value;
  const memo = document.getElementById('rmMemo').value.trim();

  if (!name || !qty || !price) { alert('ì¢…ëª©ëª…, ìˆ˜ëŸ‰, ê°€ê²©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }

  // Calculate after-tax PnL for sell
  let netPnl = pnl;
  if (type === 'sell' && pnl !== 0) {
    const total = qty * price;
    if (market === 'KR') {
      netPnl = pnl - total * TAX_KR - total * FEE_KR;
    } else {
      netPnl = pnl - total * FEE_US;
    }
  }

  state.records.unshift({ type, market, name, code, qty, price, pnl: netPnl, date, memo });
  saveState();
  closeRecordModal();
  renderRecords();
  renderHome();
  // Clear form
  ['rmName','rmCode','rmQty','rmPrice','rmPnl','rmMemo'].forEach(id => document.getElementById(id).value = '');
}

function deleteRecord(idx) {
  if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  state.records.splice(idx, 1);
  saveState();
  renderRecords();
}

// ==================== COMMAND / CHAT ====================
let pendingImageBase64 = null;

function renderChat() {
  const el = document.getElementById('chatContainer');
  el.innerHTML = state.chatHistory.map(m =>
    `<div class="chat-msg ${m.role === 'user' ? 'chat-user' : 'chat-ai'}">${m.content}</div>`
  ).join('');
  el.scrollTop = el.scrollHeight;
}

function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    pendingImageBase64 = ev.target.result;
    document.getElementById('previewImg').src = pendingImageBase64;
    document.getElementById('imagePreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearImagePreview() {
  pendingImageBase64 = null;
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('chatImageInput').value = '';
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg && !pendingImageBase64) return;

  const userMsg = msg + (pendingImageBase64 ? '\n[ğŸ“· ì´ë¯¸ì§€ ì²¨ë¶€ë¨]' : '');
  state.chatHistory.push({ role: 'user', content: userMsg });
  input.value = '';
  renderChat();

  // Build context with records & holdings
  const context = buildContext(msg);
  const imageData = pendingImageBase64;
  clearImagePreview();

  // Determine active AIs
  const activeAIs = [];
  if (state.apis.claude && state.apiKeys.claude) activeAIs.push('claude');
  if (state.apis.gemini && state.apiKeys.gemini) activeAIs.push('gemini');
  if (state.apis.gpt && state.apiKeys.gpt) activeAIs.push('gpt');

  if (activeAIs.length === 0) {
    // Demo mode
    const demoResponse = generateDemoResponse(msg);
    state.chatHistory.push({ role: 'ai', content: demoResponse });
    saveState();
    renderChat();
    return;
  }

  // Show loading
  state.chatHistory.push({ role: 'ai', content: 'ğŸ”„ AIì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘...' });
  renderChat();

  const results = {};
  const promises = activeAIs.map(async ai => {
    try {
      const response = await callAI(ai, context, imageData);
      results[ai] = response;
    } catch(e) {
      results[ai] = `âš ï¸ ${ai} ì˜¤ë¥˜: ${e.message}`;
    }
  });

  // Perplexity for news
  if (state.apis.perplexity && state.apiKeys.perplexity) {
    promises.push((async () => {
      try {
        results.perplexity = await callPerplexity(msg);
      } catch(e) {
        results.perplexity = null;
      }
    })());
  }

  await Promise.all(promises);

  // Remove loading
  state.chatHistory.pop();

  // Show individual results
  const aiNames = { claude: 'ğŸŸ£ Claude', gemini: 'ğŸ”µ Gemini', gpt: 'ğŸŸ¢ GPT' };
  activeAIs.forEach(ai => {
    if (results[ai]) {
      state.chatHistory.push({ role: 'ai', content: `${aiNames[ai]}:\n${results[ai]}` });
    }
  });

  if (results.perplexity) {
    state.chatHistory.push({ role: 'ai', content: `ğŸ” ìµœì‹  ë‰´ìŠ¤:\n${results.perplexity}` });
  }

  // Cross verification
  if (activeAIs.length >= 2) {
    const verdict = crossVerify(results, activeAIs);
    state.chatHistory.push({ role: 'ai', content: verdict });
    showCrossVerify(results, activeAIs);
  }

  saveState();
  renderChat();
}

function buildContext(userMsg) {
  const holdRecords = state.records.filter(r => r.type === 'hold');
  const recentRecords = state.records.slice(0, 10);

  let ctx = `ë‹¹ì‹ ì€ ì£¼ì‹ ì´ˆë³´ìë¥¼ ìœ„í•œ íˆ¬ì ë„ìš°ë¯¸ì…ë‹ˆë‹¤.

ì¤‘ìš”í•œ ê·œì¹™:
1. ì „ë¬¸ìš©ì–´(RSI, MACD, PER, ë³¼ë¦°ì € ë“±) ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
2. ë‹µë³€ì€ ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ í•˜ì„¸ìš”:
ğŸ¯ [ì¢…ëª©ì´ë¦„]
ğŸ‘‰ [ì‚¬ë¼ / íŒ”ì•„ë¼ / ê¸°ë‹¤ë ¤ë¼] ì¤‘ ë”± í•˜ë‚˜ë§Œ
ğŸ’° [ì–¼ë§ˆì— ì‚¬ê³ , ì–¼ë§ˆ ë˜ë©´ íŒ”ì•„ë¼]
ğŸ“ [ì´ìœ  1ì¤„ - ì´ˆë“±í•™ìƒë„ ì´í•´í•  ìˆ˜ ìˆê²Œ]
3. ì—¬ëŸ¬ ì¢…ëª© ë‚˜ì—´ ê¸ˆì§€. 1ì¢…ëª© 1í–‰ë™ë§Œ
4. ì¬ë¬´ì œí‘œ íƒ„íƒ„í•œ ëŒ€í˜• ìš°ëŸ‰ì£¼ë§Œ ì¶”ì²œ. ì¡ì£¼/í…Œë§ˆì£¼ ì ˆëŒ€ ê¸ˆì§€
5. ì´ìœ ëŠ” ì´ˆë“±í•™ìƒë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ì‰¬ìš´ ë§ 1ì¤„ë¡œ

`;

  if (holdRecords.length > 0) {
    ctx += '\ní˜„ì¬ í™€ë”© ì¤‘ì¸ ì¢…ëª©:\n';
    holdRecords.forEach(r => {
      const demo = findStock(r.name, r.code);
      const curPrice = demo ? demo.price : r.price;
      ctx += `- ${r.name}(${r.code}): ${r.qty}ì£¼, ë§¤ìˆ˜ê°€ ${r.price}, í˜„ì¬ê°€ ${curPrice}\n`;
    });
  }

  if (state.portfolio.length > 0) {
    ctx += '\ní¬íŠ¸í´ë¦¬ì˜¤:\n';
    state.portfolio.forEach(p => {
      const demo = findStock(p.name, p.code);
      const curPrice = demo ? demo.price : p.avgPrice;
      ctx += `- ${p.name}(${p.code}): ${p.qty}ì£¼, í‰ê· ê°€ ${p.avgPrice}, í˜„ì¬ê°€ ${curPrice}\n`;
    });
  }

  if (recentRecords.length > 0) {
    ctx += '\nìµœê·¼ ë§¤ë§¤ ê¸°ë¡:\n';
    recentRecords.forEach(r => {
      ctx += `- ${r.date} ${r.type==='buy'?'ë§¤ìˆ˜':r.type==='sell'?'ë§¤ë„':'í™€ë”©'} ${r.name} ${r.qty}ì£¼ ${r.price}\n`;
    });
  }

  ctx += `\nì‚¬ìš©ì ì§ˆë¬¸: ${userMsg}`;
  return ctx;
}

async function callAI(type, context, imageData) {
  if (type === 'claude') return await callClaude(context, imageData);
  if (type === 'gemini') return await callGemini(context, imageData);
  if (type === 'gpt') return await callGPT(context, imageData);
}

async function callClaude(context, imageData) {
  const messages = [];
  const content = [];

  if (imageData) {
    const base64 = imageData.split(',')[1];
    const mediaType = imageData.split(';')[0].split(':')[1];
    content.push({
      type: 'image',
      source: { type: 'base64', media_type: mediaType, data: base64 }
    });
  }
  content.push({ type: 'text', text: context });
  messages.push({ role: 'user', content });

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKeys.claude,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 500,
      messages
    })
  });
  const data = await resp.json();
  if (data.error) throw new Error(data.error.message);
  return data.content[0].text;
}

async function callGemini(context, imageData) {
  const parts = [];
  if (imageData) {
    const base64 = imageData.split(',')[1];
    const mimeType = imageData.split(';')[0].split(':')[1];
    parts.push({ inline_data: { mime_type: mimeType, data: base64 } });
  }
  parts.push({ text: context });

  const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.apiKeys.gemini}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts }],
      generationConfig: { maxOutputTokens: 500 }
    })
  });
  const data = await resp.json();
  if (data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

async function callGPT(context, imageData) {
  const messages = [];
  const content = [];

  if (imageData) {
    content.push({ type: 'image_url', image_url: { url: imageData } });
  }
  content.push({ type: 'text', text: context });
  messages.push({ role: 'user', content });

  const resp = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${state.apiKeys.gpt}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages,
      max_tokens: 500
    })
  });
  const data = await resp.json();
  if (data.error) throw new Error(data.error.message);
  return data.choices[0].message.content;
}

async function callPerplexity(query) {
  const resp = await fetch('https://api.perplexity.ai/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${state.apiKeys.perplexity}`
    },
    body: JSON.stringify({
      model: 'sonar',
      messages: [
        { role: 'system', content: 'í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. ì£¼ì‹ ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì‰¬ìš´ ë§ë¡œ 2-3ì¤„ë¡œ ìš”ì•½í•˜ì„¸ìš”.' },
        { role: 'user', content: query + ' ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤' }
      ],
      max_tokens: 300
    })
  });
  const data = await resp.json();
  if (data.error) throw new Error(data.error.message);
  return data.choices[0].message.content;
}

function crossVerify(results, ais) {
  const actions = {};
  ais.forEach(ai => {
    const txt = (results[ai] || '').toLowerCase();
    if (txt.includes('ì‚¬ë¼') || txt.includes('ë§¤ìˆ˜') || txt.includes('buy')) actions[ai] = 'buy';
    else if (txt.includes('íŒ”ì•„ë¼') || txt.includes('ë§¤ë„') || txt.includes('sell')) actions[ai] = 'sell';
    else actions[ai] = 'hold';
  });

  const vals = Object.values(actions);
  const allBuy = vals.every(v => v === 'buy');
  const allSell = vals.every(v => v === 'sell');

  if (allBuy) return 'ğŸ”€ êµì°¨ê²€ì¦ ê²°ê³¼\nğŸŸ¢ ëª¨ë“  AIê°€ ë™ì˜í–ˆì–´ìš” â†’ ì§€ê¸ˆ ì‚¬ì„¸ìš”!';
  if (allSell) return 'ğŸ”€ êµì°¨ê²€ì¦ ê²°ê³¼\nğŸ”´ ëª¨ë“  AIê°€ ë™ì˜í–ˆì–´ìš” â†’ ì§€ê¸ˆ íŒŒì„¸ìš”!';
  return 'ğŸ”€ êµì°¨ê²€ì¦ ê²°ê³¼\nğŸŸ¡ AIë“¤ì˜ ì˜ê²¬ì´ ë‹¬ë¼ìš” â†’ ì§€ê¸ˆì€ ê¸°ë‹¤ë¦¬ì„¸ìš”';
}

function showCrossVerify(results, ais) {
  const box = document.getElementById('crossVerifyBox');
  box.style.display = 'block';
  const aiNames = { claude: 'ğŸŸ£ Claude', gemini: 'ğŸ”µ Gemini', gpt: 'ğŸŸ¢ GPT' };

  let html = '';
  const actions = {};
  ais.forEach(ai => {
    const txt = (results[ai] || '').toLowerCase();
    let action, color;
    if (txt.includes('ì‚¬ë¼') || txt.includes('ë§¤ìˆ˜') || txt.includes('buy')) { action = 'ì‚¬ë¼'; color = 'var(--green)'; actions[ai] = 'buy'; }
    else if (txt.includes('íŒ”ì•„ë¼') || txt.includes('ë§¤ë„') || txt.includes('sell')) { action = 'íŒ”ì•„ë¼'; color = 'var(--red)'; actions[ai] = 'sell'; }
    else { action = 'ê¸°ë‹¤ë ¤ë¼'; color = 'var(--yellow)'; actions[ai] = 'hold'; }
    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px">
      <span>${aiNames[ai]}</span>
      <span style="color:${color};font-weight:700">${action}</span>
    </div>`;
  });

  document.getElementById('crossResults').innerHTML = html;

  const vals = Object.values(actions);
  const allBuy = vals.every(v => v === 'buy');
  const allSell = vals.every(v => v === 'sell');

  let verdictClass, verdictText;
  if (allBuy) { verdictClass = 'verdict-buy'; verdictText = 'ğŸŸ¢ ì§€ê¸ˆ ì‚¬ì„¸ìš”!'; }
  else if (allSell) { verdictClass = 'verdict-sell'; verdictText = 'ğŸ”´ ì§€ê¸ˆ íŒŒì„¸ìš”!'; }
  else { verdictClass = 'verdict-hold'; verdictText = 'ğŸŸ¡ ì§€ê¸ˆì€ ê¸°ë‹¤ë¦¬ì„¸ìš”'; }

  document.getElementById('finalVerdict').innerHTML = `<div class="verdict-box ${verdictClass}">${verdictText}</div>`;
}

function generateDemoResponse(msg) {
  const stock = ALL_STOCKS.find(s => msg.includes(s.name) || msg.toLowerCase().includes(s.code.toLowerCase()));
  if (!stock) {
    return 'ğŸ’¡ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°ëª¨ ëª¨ë“œì…ë‹ˆë‹¤.\nâš™ï¸ ì„¤ì • íƒ­ì—ì„œ AI APIë¥¼ í™œì„±í™”í•˜ì„¸ìš”.\n\në°ëª¨ ì¢…ëª©(ì‚¼ì„±ì „ì, AAPL ë“±)ì„ ì…ë ¥í•´ë³´ì„¸ìš”!';
  }

  const prices = generatePriceData(stock.price, 120);
  const score = computeTechScore(prices);
  let action, buyPrice, sellPrice, reason;

  if (score > 65) {
    action = 'ì‚¬ë¼';
    buyPrice = Math.round(stock.price * 0.98);
    sellPrice = Math.round(stock.price * 1.07);
    reason = 'ìš”ì¦˜ ì´ íšŒì‚¬ ì‹¤ì ì´ ì¢‹ê³ , ê°€ê²©ì´ ì˜¤ë¥´ëŠ” ì¤‘ì´ì—ìš”';
  } else if (score < 35) {
    action = 'íŒ”ì•„ë¼';
    buyPrice = '-';
    sellPrice = Math.round(stock.price * 0.97);
    reason = 'ê°€ê²©ì´ ê³„ì† ë‚´ë ¤ê°€ëŠ” ì¤‘ì´ë¼ ì§€ê¸ˆ íŒŒëŠ” ê²Œ ë‚˜ì•„ìš”';
  } else {
    action = 'ê¸°ë‹¤ë ¤ë¼';
    buyPrice = Math.round(stock.price * 0.95);
    sellPrice = Math.round(stock.price * 1.05);
    reason = 'ì§€ê¸ˆì€ ì˜¤ë¥¼ì§€ ë‚´ë¦´ì§€ ì• ë§¤í•´ì„œ ì¢€ ë” ì§€ì¼œë³´ëŠ” ê²Œ ì¢‹ì•„ìš”';
  }

  const currency = stock.market === 'US' ? '$' : 'ì›';
  return `ğŸ¯ ${stock.name}\nğŸ‘‰ ${action}\nğŸ’° ${buyPrice !== '-' ? formatNum(buyPrice)+currency+'ì— ì‚¬ê³ , ' : ''}${formatNum(sellPrice)}${currency} ë˜ë©´ íŒ”ì•„ë¼\nğŸ“ ${reason}\n\n(âš ï¸ ë°ëª¨ ëª¨ë“œ - ì‹¤ì œ íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤)`;
}

// ==================== API SETTINGS ====================
function toggleAPI(name) {
  state.apis[name] = !state.apis[name];
  const el = document.getElementById('toggle' + name.charAt(0).toUpperCase() + name.slice(1));
  el.classList.toggle('on', state.apis[name]);
  saveState();
}

function saveAPIKey(name) {
  const el = document.getElementById('key' + name.charAt(0).toUpperCase() + name.slice(1));
  state.apiKeys[name] = el.value;
  saveState();
}

function restoreAPIUI() {
  ['claude','gemini','gpt','perplexity','kis','alpha'].forEach(name => {
    const toggleEl = document.getElementById('toggle' + name.charAt(0).toUpperCase() + name.slice(1));
    if (toggleEl) toggleEl.classList.toggle('on', state.apis[name]);
    const keyEl = document.getElementById('key' + name.charAt(0).toUpperCase() + name.slice(1));
    if (keyEl) keyEl.value = state.apiKeys[name] || '';
  });
}

// ==================== BACKTEST ====================
function populateBtSelect() {
  const sel = document.getElementById('btStock');
  sel.innerHTML = ALL_STOCKS.map(s =>
    `<option value="${s.code}">${s.market === 'US' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡°ğŸ‡·'} ${s.name} (${s.code})</option>`
  ).join('');
}

function runBacktest() {
  const code = document.getElementById('btStock').value;
  const stock = ALL_STOCKS.find(s => s.code === code);
  if (!stock) return;

  const prices = generatePriceData(stock.price, 120);
  const closes = prices.map(p => p.close);

  // Strategy 1: Golden Cross + Momentum
  const s1 = backtestStrategy1(closes);
  // Strategy 2: Reversal
  const s2 = backtestStrategy2(closes);
  // Strategy 3: Trend Following
  const s3 = backtestStrategy3(closes);

  document.getElementById('btResults').style.display = 'block';

  renderStratCard('strat1', 'ì „ëµ 1: ì¶”ì„¸ ë”°ë¼ê°€ê¸°', 'ê°€ê²©ì´ ì˜¬ë¼ê°€ê¸° ì‹œì‘í•˜ë©´ ì‚¬ê³ , ë‚´ë ¤ê°€ê¸° ì‹œì‘í•˜ë©´ íŒŒëŠ” ì „ëµ', s1);
  renderStratCard('strat2', 'ì „ëµ 2: ì‹¸ê²Œ ì‚¬ê¸°', 'ê°€ê²©ì´ ë§ì´ ë–¨ì–´ì¡Œì„ ë•Œ ì‚¬ì„œ, ë‹¤ì‹œ ì˜¤ë¥´ë©´ íŒŒëŠ” ì „ëµ', s2);
  renderStratCard('strat3', 'ì „ëµ 3: íë¦„ íƒ€ê¸°', 'ì—¬ëŸ¬ ì‹ í˜¸ë¥¼ ì¢…í•©í•´ì„œ ê°€ì¥ ì¢‹ì€ íƒ€ì´ë°ì„ ì°¾ëŠ” ì „ëµ', s3);
}

function backtestStrategy1(closes) {
  let cash = 10000000, shares = 0, trades = 0, wins = 0;
  const ma5 = movingAvg(closes, 5);
  const ma20 = movingAvg(closes, 20);
  let peak = cash, mdd = 0;

  for (let i = 20; i < closes.length; i++) {
    const portfolio = cash + shares * closes[i];
    peak = Math.max(peak, portfolio);
    mdd = Math.max(mdd, (peak - portfolio) / peak * 100);

    if (ma5[i] > ma20[i] && ma5[i-1] <= ma20[i-1] && shares === 0) {
      shares = Math.floor(cash / closes[i]);
      cash -= shares * closes[i];
    } else if (ma5[i] < ma20[i] && ma5[i-1] >= ma20[i-1] && shares > 0) {
      const sellVal = shares * closes[i];
      const buyVal = shares * closes[i-1];
      if (sellVal > buyVal) wins++;
      cash += sellVal;
      shares = 0;
      trades++;
    }
  }
  const finalVal = cash + shares * closes[closes.length-1];
  const ret = ((finalVal - 10000000) / 10000000 * 100);
  const benchmark = ((closes[closes.length-1] - closes[20]) / closes[20] * 100);

  return { ret, benchmark, winRate: trades > 0 ? (wins/trades*100) : 0, mdd, sharpe: ret / (mdd||1), trades };
}

function backtestStrategy2(closes) {
  let cash = 10000000, shares = 0, trades = 0, wins = 0;
  const rsi = computeRSI(closes, 14);
  let peak = cash, mdd = 0;

  for (let i = 14; i < closes.length; i++) {
    const portfolio = cash + shares * closes[i];
    peak = Math.max(peak, portfolio);
    mdd = Math.max(mdd, (peak - portfolio) / peak * 100);

    if (rsi[i] < 30 && shares === 0) {
      shares = Math.floor(cash / closes[i]);
      cash -= shares * closes[i];
    } else if (rsi[i] > 70 && shares > 0) {
      const profit = shares * (closes[i] - closes[i-1]);
      if (profit > 0) wins++;
      cash += shares * closes[i];
      shares = 0;
      trades++;
    }
  }
  const finalVal = cash + shares * closes[closes.length-1];
  const ret = ((finalVal - 10000000) / 10000000 * 100);
  const benchmark = ((closes[closes.length-1] - closes[14]) / closes[14] * 100);

  return { ret, benchmark, winRate: trades > 0 ? (wins/trades*100) : 0, mdd, sharpe: ret / (mdd||1), trades };
}

function backtestStrategy3(closes) {
  let cash = 10000000, shares = 0, trades = 0, wins = 0;
  const macd = computeMACD(closes);
  const bb = computeBollinger(closes, 20, 2);
  let peak = cash, mdd = 0;

  for (let i = 26; i < closes.length; i++) {
    const portfolio = cash + shares * closes[i];
    peak = Math.max(peak, portfolio);
    mdd = Math.max(mdd, (peak - portfolio) / peak * 100);

    if (macd.histogram[i] > 0 && closes[i] < (bb.lower[i]||closes[i]) && shares === 0) {
      shares = Math.floor(cash / closes[i]);
      cash -= shares * closes[i];
    } else if ((macd.histogram[i] < 0 || closes[i] > (bb.upper[i]||closes[i]*2)) && shares > 0) {
      const profit = shares * (closes[i] - closes[i-1]);
      if (profit > 0) wins++;
      cash += shares * closes[i];
      shares = 0;
      trades++;
    }
  }
  const finalVal = cash + shares * closes[closes.length-1];
  const ret = ((finalVal - 10000000) / 10000000 * 100);
  const benchmark = ((closes[closes.length-1] - closes[26]) / closes[26] * 100);

  return { ret, benchmark, winRate: trades > 0 ? (wins/trades*100) : 0, mdd, sharpe: ret / (mdd||1), trades };
}

function renderStratCard(elId, name, desc, result) {
  document.getElementById(elId).innerHTML = `
    <div class="strat-name">${name}</div>
    <div class="strat-desc">${desc}</div>
    <div class="strat-stats">
      <div class="strat-stat">
        <div class="strat-stat-val ${result.ret>=0?'pos':'neg'}">${result.ret.toFixed(1)}%</div>
        <div class="strat-stat-lbl">ì „ëµ ìˆ˜ìµë¥ </div>
      </div>
      <div class="strat-stat">
        <div class="strat-stat-val">${result.winRate.toFixed(0)}%</div>
        <div class="strat-stat-lbl">ìŠ¹ë¥ </div>
      </div>
      <div class="strat-stat">
        <div class="strat-stat-val">${result.mdd.toFixed(1)}%</div>
        <div class="strat-stat-lbl">ìµœëŒ€ ë‚™í­</div>
      </div>
    </div>
    <div style="margin-top:8px;font-size:11px;color:var(--text3);display:flex;justify-content:space-between">
      <span>ê¸°ì¤€ ìˆ˜ìµë¥ : ${result.benchmark.toFixed(1)}%</span>
      <span>ê±°ë˜: ${result.trades}íšŒ</span>
      <span>íš¨ìœ¨: ${result.sharpe.toFixed(2)}</span>
    </div>
  `;
}

// ==================== TECHNICAL ANALYSIS (INTERNAL) ====================
function computeTechScore(prices) {
  const closes = prices.map(p => p.close);
  const volumes = prices.map(p => p.volume);

  // RSI
  const rsi = computeRSI(closes, 14);
  const lastRSI = rsi[rsi.length - 1] || 50;

  // MACD
  const macd = computeMACD(closes);
  const lastHist = macd.histogram[macd.histogram.length - 1] || 0;

  // Bollinger Band position
  const bb = computeBollinger(closes, 20, 2);
  const lastClose = closes[closes.length - 1];
  const bbPos = bb.upper[bb.upper.length-1] && bb.lower[bb.lower.length-1]
    ? (lastClose - bb.lower[bb.lower.length-1]) / (bb.upper[bb.upper.length-1] - bb.lower[bb.lower.length-1]) * 100
    : 50;

  // Stochastic
  const stoch = computeStochastic(closes, 14);
  const lastK = stoch[stoch.length - 1] || 50;

  // MA trend
  const ma5 = movingAvg(closes, 5);
  const ma20 = movingAvg(closes, 20);
  const ma60 = movingAvg(closes, 60);
  const maTrend = (ma5[ma5.length-1] > ma20[ma20.length-1] ? 20 : 0) +
                  (ma20[ma20.length-1] > ma60[ma60.length-1] ? 15 : 0);

  // Volume trend
  const avgVol = volumes.slice(-20).reduce((a,b) => a+b, 0) / 20;
  const recentVol = volumes.slice(-5).reduce((a,b) => a+b, 0) / 5;
  const volScore = recentVol > avgVol * 1.2 ? 10 : recentVol < avgVol * 0.8 ? -5 : 0;

  // Composite score (0-100)
  let score = 0;
  // RSI: oversold=buy signal, overbought=sell signal
  if (lastRSI < 30) score += 20;
  else if (lastRSI < 45) score += 15;
  else if (lastRSI > 70) score += 0;
  else if (lastRSI > 55) score += 5;
  else score += 10;

  // MACD
  score += lastHist > 0 ? 15 : 5;

  // Bollinger
  if (bbPos < 20) score += 15; // near lower = oversold
  else if (bbPos > 80) score += 0;
  else score += 8;

  // Stochastic
  if (lastK < 20) score += 10;
  else if (lastK > 80) score += 0;
  else score += 5;

  score += maTrend;
  score += volScore;

  return Math.max(0, Math.min(100, score));
}

function getSignalText(score) {
  if (score >= 80) return { text: 'ğŸŸ¢ ì§€ê¸ˆ ì‚¬ë„ ì¢‹ì•„ìš”!', bg: 'rgba(0,214,126,0.15)', color: 'var(--green)' };
  if (score >= 65) return { text: 'ğŸŸ¢ ì‚¬ë„ ê´œì°®ì•„ìš”', bg: 'rgba(0,214,126,0.1)', color: 'var(--green)' };
  if (score >= 55) return { text: 'ğŸ”µ ì¡°ê¸ˆì”© ì˜¤ë¥´ëŠ” ì¤‘', bg: 'rgba(55,66,250,0.1)', color: 'var(--cyan)' };
  if (score >= 45) return { text: 'ğŸŸ¡ ì§€ì¼œë³´ì„¸ìš”', bg: 'rgba(255,165,2,0.1)', color: 'var(--yellow)' };
  if (score >= 35) return { text: 'ğŸŸ  ì¡°ê¸ˆ ê±±ì •ë˜ëŠ” ìƒí™©', bg: 'rgba(255,165,2,0.15)', color: 'var(--yellow)' };
  if (score >= 20) return { text: 'ğŸ”´ íŒ”ì•„ì•¼ í•  ìˆ˜ë„', bg: 'rgba(255,71,87,0.1)', color: 'var(--red)' };
  return { text: 'ğŸ”´ ì§€ê¸ˆ íŒ”ì•„ì•¼ í•´ìš”!', bg: 'rgba(255,71,87,0.15)', color: 'var(--red)' };
}

function computeRSI(closes, period) {
  const rsi = new Array(closes.length).fill(50);
  for (let i = period; i < closes.length; i++) {
    let gains = 0, losses = 0;
    for (let j = i - period + 1; j <= i; j++) {
      const diff = closes[j] - closes[j-1];
      if (diff > 0) gains += diff;
      else losses -= diff;
    }
    const avgGain = gains / period;
    const avgLoss = losses / period;
    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
    rsi[i] = 100 - (100 / (1 + rs));
  }
  return rsi;
}

function computeMACD(closes) {
  const ema12 = ema(closes, 12);
  const ema26 = ema(closes, 26);
  const macdLine = closes.map((_, i) => (ema12[i] || 0) - (ema26[i] || 0));
  const signal = ema(macdLine, 9);
  const histogram = macdLine.map((v, i) => v - (signal[i] || 0));
  return { line: macdLine, signal, histogram };
}

function computeBollinger(closes, period, mult) {
  const mid = movingAvg(closes, period);
  const upper = [], lower = [];
  for (let i = 0; i < closes.length; i++) {
    if (i < period - 1) { upper.push(null); lower.push(null); continue; }
    const slice = closes.slice(i - period + 1, i + 1);
    const std = Math.sqrt(slice.reduce((s, v) => s + Math.pow(v - mid[i], 2), 0) / period);
    upper.push(mid[i] + mult * std);
    lower.push(mid[i] - mult * std);
  }
  return { mid, upper, lower };
}

function computeStochastic(closes, period) {
  const k = [];
  for (let i = 0; i < closes.length; i++) {
    if (i < period - 1) { k.push(50); continue; }
    const slice = closes.slice(i - period + 1, i + 1);
    const high = Math.max(...slice);
    const low = Math.min(...slice);
    k.push(high === low ? 50 : ((closes[i] - low) / (high - low)) * 100);
  }
  return k;
}

function movingAvg(data, period) {
  const result = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) { result.push(data[i]); continue; }
    const slice = data.slice(i - period + 1, i + 1);
    result.push(slice.reduce((a, b) => a + b, 0) / period);
  }
  return result;
}

function ema(data, period) {
  const result = [];
  const mult = 2 / (period + 1);
  for (let i = 0; i < data.length; i++) {
    if (i === 0) { result.push(data[0]); continue; }
    result.push((data[i] - result[i-1]) * mult + result[i-1]);
  }
  return result;
}

// ==================== CHART ====================
function generatePriceData(basePrice, days) {
  const prices = [];
  let price = basePrice * (0.9 + Math.random() * 0.2);
  const seed = basePrice * 137;

  for (let i = 0; i < days; i++) {
    const noise = (seededRandom(seed + i) - 0.48) * basePrice * 0.03;
    const trend = Math.sin(i / 20) * basePrice * 0.02;
    price = Math.max(price * 0.95, price + noise + trend * 0.3);

    const high = price * (1 + seededRandom(seed + i + 1000) * 0.02);
    const low = price * (1 - seededRandom(seed + i + 2000) * 0.02);
    const open = price * (1 + (seededRandom(seed + i + 3000) - 0.5) * 0.015);
    const close = price;
    const volume = Math.round(50000 + seededRandom(seed + i + 4000) * 200000);

    prices.push({ open, high: Math.max(open, close, high), low: Math.min(open, close, low), close, volume });
  }
  return prices;
}

function seededRandom(seed) {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

function drawCandleChart(canvasId, prices) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const w = canvas.parentElement.clientWidth;
  const h = 200;
  canvas.width = w * 2;
  canvas.height = h * 2;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.scale(2, 2);
  ctx.clearRect(0, 0, w, h);

  const padding = { top: 10, right: 10, bottom: 20, left: 50 };
  const chartW = w - padding.left - padding.right;
  const chartH = h - padding.top - padding.bottom;

  const visible = prices.slice(-60);
  const allHighs = visible.map(p => p.high);
  const allLows = visible.map(p => p.low);
  const maxP = Math.max(...allHighs);
  const minP = Math.min(...allLows);
  const range = maxP - minP || 1;

  const barW = chartW / visible.length;

  // Bollinger bands
  const closes = visible.map(p => p.close);
  const bb = computeBollinger(closes, 20, 2);

  // Draw BB fill
  ctx.beginPath();
  ctx.globalAlpha = 0.1;
  for (let i = 0; i < visible.length; i++) {
    if (bb.upper[i] === null) continue;
    const x = padding.left + i * barW + barW / 2;
    const y = padding.top + (1 - (bb.upper[i] - minP) / range) * chartH;
    if (i === 0 || bb.upper[i-1] === null) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  for (let i = visible.length - 1; i >= 0; i--) {
    if (bb.lower[i] === null) continue;
    const x = padding.left + i * barW + barW / 2;
    const y = padding.top + (1 - (bb.lower[i] - minP) / range) * chartH;
    ctx.lineTo(x, y);
  }
  ctx.fillStyle = '#6c5ce7';
  ctx.fill();
  ctx.globalAlpha = 1;

  // Draw BB lines
  ctx.strokeStyle = 'rgba(108,92,231,0.4)';
  ctx.lineWidth = 0.5;
  ['upper', 'lower', 'mid'].forEach(key => {
    ctx.beginPath();
    for (let i = 0; i < visible.length; i++) {
      if (bb[key][i] === null) continue;
      const x = padding.left + i * barW + barW / 2;
      const y = padding.top + (1 - (bb[key][i] - minP) / range) * chartH;
      if (i === 0 || bb[key][i-1] === null) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  });

  // Draw candles
  visible.forEach((p, i) => {
    const x = padding.left + i * barW;
    const isGreen = p.close >= p.open;
    ctx.strokeStyle = isGreen ? '#00d67e' : '#ff4757';
    ctx.fillStyle = isGreen ? '#00d67e' : '#ff4757';

    // Wick
    const wickX = x + barW / 2;
    const highY = padding.top + (1 - (p.high - minP) / range) * chartH;
    const lowY = padding.top + (1 - (p.low - minP) / range) * chartH;
    ctx.beginPath();
    ctx.moveTo(wickX, highY);
    ctx.lineTo(wickX, lowY);
    ctx.lineWidth = 0.5;
    ctx.stroke();

    // Body
    const openY = padding.top + (1 - (p.open - minP) / range) * chartH;
    const closeY = padding.top + (1 - (p.close - minP) / range) * chartH;
    const bodyH = Math.max(1, Math.abs(closeY - openY));
    ctx.fillRect(x + barW * 0.15, Math.min(openY, closeY), barW * 0.7, bodyH);
  });

  // Y-axis labels
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text3');
  ctx.font = '9px Outfit';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const val = minP + (range * i / 4);
    const y = padding.top + chartH - (chartH * i / 4);
    ctx.fillText(formatNum(Math.round(val)), padding.left - 4, y + 3);
  }
}

// ==================== DATA EXPORT/IMPORT ====================
function exportData() {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'alpha-engine-backup-' + toDateStr(new Date()) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      state = { ...state, ...imported };
      saveState();
      alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
      location.reload();
    } catch(err) {
      alert('ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// ==================== UTILITIES ====================
function findStock(name, code) {
  return ALL_STOCKS.find(s => s.name === name || s.code === code);
}

function formatNum(n) {
  if (n === undefined || n === null) return '0';
  return Number(n).toLocaleString('ko-KR');
}

function formatKRW(n) {
  if (n >= 100000000) return (n/100000000).toFixed(1) + 'ì–µ';
  if (n >= 10000) return (n/10000).toFixed(0) + 'ë§Œ';
  return formatNum(Math.round(n));
}

function toDateStr(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

// ==================== INIT ====================
init();
</script>
</body>
</html>
