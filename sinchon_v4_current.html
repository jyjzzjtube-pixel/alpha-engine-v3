<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í˜„ëŒ€ë°±í™”ì  ì‹ ì´Œì  ì •ì‚° ê´€ë¦¬</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap');
:root{--bg:#f5f3ef;--bg2:#eceae4;--card:#fff;--border:#ddd8cf;--border2:#c8c2b8;--accent:#0d8a6a;--accent-bg:rgba(13,138,106,0.06);--accent-lt:#e8f5f0;--navy:#1a2332;--navy2:#2d3a4a;--red:#d1455b;--red-bg:rgba(209,69,91,0.06);--orange:#d48a2c;--purple:#6b52ae;--text:#1a2332;--text2:#5a6577;--text3:#8e97a5;--mono:'IBM Plex Mono',monospace;--sans:'Noto Sans KR',sans-serif;--sh:0 1px 3px rgba(26,35,50,0.06);--sh2:0 4px 12px rgba(26,35,50,0.08)}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}input,button,select,textarea{font-family:var(--sans);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.app{display:flex;height:100vh}
.sidebar{width:224px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.s-logo{padding:22px 20px;border-bottom:1px solid var(--border)}
.s-logo h1{font-size:15px;font-weight:900;color:var(--accent)}.s-logo p{font-size:11px;color:var(--text3);margin-top:3px;font-family:var(--mono)}
.s-year{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;border-bottom:1px solid var(--border);background:var(--bg)}
.s-year button{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;font-size:13px}
.s-year button:hover{border-color:var(--accent);color:var(--accent)}.s-year span{font-family:var(--mono);font-weight:700;font-size:16px}
.m-list{flex:1;overflow-y:auto;padding:8px}
.mi{width:100%;padding:11px 14px;border-radius:10px;border:0;background:0;color:var(--text3);font-size:13px;font-weight:500;font-family:var(--sans);cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;transition:.12s;margin-bottom:2px}
.mi:hover{background:var(--bg);color:var(--text2)}.mi.act{background:var(--accent);color:#fff;font-weight:700;box-shadow:0 2px 8px rgba(13,138,106,.25)}
.mi .dot{width:7px;height:7px;border-radius:50%;background:var(--accent);display:none}.mi.hd .dot{display:block}.mi.act .dot{background:rgba(255,255,255,.6)}
.mi .vl{font-family:var(--mono);font-size:11px;font-weight:600}
.s-bot{padding:12px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.sb{width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;font-family:var(--sans);transition:.12s}
.sb:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-lt)}.sb.pri{background:var(--accent);color:#fff;border-color:var(--accent)}

.main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.top{height:56px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0;box-shadow:var(--sh)}
.top-t{font-size:16px;font-weight:700;color:var(--navy)}.top-t span{color:var(--accent)}
.top-r{display:flex;align-items:center;gap:12px}
.vtabs{display:flex;gap:3px;background:var(--bg);border-radius:10px;padding:3px;border:1px solid var(--border)}
.vt{padding:7px 15px;border-radius:8px;border:0;background:0;color:var(--text3);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--sans)}.vt:hover{color:var(--text2)}.vt.act{background:var(--card);color:var(--accent);box-shadow:var(--sh)}
.tb{height:34px;padding:0 14px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;font-family:var(--sans);display:flex;align-items:center;gap:5px}.tb:hover{border-color:var(--accent);color:var(--accent)}
.ct{flex:1;overflow-y:auto;padding:24px}

/* REPORT - ìš”ì•½ë³¸ */
.rpt{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--sh2)}
.rpt-h{background:linear-gradient(135deg,#1a2332,#2d4a5a);padding:24px 32px;text-align:center;color:#fff}
.rpt-h h2{font-size:18px;font-weight:900;margin-bottom:4px}.rpt-h p{font-size:11px;opacity:.65;font-family:var(--mono)}
.rpt-b{padding:28px 32px}
.rr{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}.rr:last-child{border-bottom:0}
.rr.hl{background:var(--accent-bg);margin:4px -16px;padding:12px 16px;border-radius:10px;border-bottom:0}
.rr.sep{border-bottom:0;padding:0;margin:12px 0;height:1px;background:var(--border)}
.rl{font-size:14px;font-weight:500;color:var(--text2)}.rl.b{font-weight:700;color:var(--text)}
.rv{font-family:var(--mono);font-size:15px;font-weight:600;color:var(--navy)}.rv.big{font-size:20px;font-weight:800}
.rv .pc{font-size:11px;color:var(--text3);margin-left:6px}
.pbox{border-radius:14px;padding:24px;text-align:center;margin-top:20px;border:1px solid}
.pbox.pos{background:var(--accent-bg);border-color:rgba(13,138,106,.2)}.pbox.neg{background:var(--red-bg);border-color:rgba(209,69,91,.15)}
.pbox-l{font-size:13px;color:var(--text2);margin-bottom:6px}.pbox-v{font-family:var(--mono);font-size:30px;font-weight:900}

/* TABLES */
.ltbl{width:100%;border-collapse:collapse;margin:10px 0}
.ltbl th{padding:10px 12px;font-size:11px;font-weight:600;color:var(--text3);border-bottom:2px solid var(--border);font-family:var(--mono);text-align:right}
.ltbl th:first-child{text-align:center;width:36px}.ltbl th:nth-child(2){text-align:left}
.ltbl td{padding:10px 12px;font-size:13px;font-family:var(--mono);text-align:right;border-bottom:1px solid var(--border)}
.ltbl td:first-child{text-align:center;font-family:var(--sans);color:var(--text3)}.ltbl td:nth-child(2){text-align:left;font-family:var(--sans);font-weight:600;color:var(--navy)}
.ltbl tr:hover{background:var(--accent-bg)}.ltbl tr.tot td{font-weight:700;border-top:2px solid var(--border);background:var(--bg)}
.itbl{width:100%;border-collapse:collapse;margin:10px 0}
.itbl th,.itbl td{padding:8px 12px;font-size:12px;font-family:var(--mono);text-align:right;border-bottom:1px solid var(--border)}
.itbl th:first-child,.itbl td:first-child{text-align:left;font-family:var(--sans)}.itbl th{font-size:11px;color:var(--text3);font-weight:600;border-bottom:2px solid var(--border)}

/* TREND */
.tg{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.sc{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:var(--sh);position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}.sc:nth-child(1)::before{background:var(--accent)}.sc:nth-child(2)::before{background:var(--red)}.sc:nth-child(3)::before{background:var(--purple)}.sc:nth-child(4)::before{background:var(--orange)}
.sc-l{font-size:11px;color:var(--text3);font-weight:600;margin-bottom:8px}.sc-v{font-family:var(--mono);font-size:20px;font-weight:700}.sc-s{font-family:var(--mono);font-size:11px;color:var(--text3);margin-top:5px}
.cb{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:16px;box-shadow:var(--sh)}
.cb-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}.cb-t{font-size:14px;font-weight:700}
.cleg{display:flex;gap:14px}.lg{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text2)}.ld{width:8px;height:8px;border-radius:50%}
.cha{height:280px}.chs{height:210px}
.stbl{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--sh)}
.stbl-t{padding:16px 22px;font-size:14px;font-weight:700;border-bottom:1px solid var(--border)}
.stbl table{width:100%;border-collapse:collapse}
.stbl th{padding:10px 14px;font-size:10px;font-weight:600;color:var(--text3);text-align:right;border-bottom:2px solid var(--border);font-family:var(--mono)}.stbl th:first-child{text-align:left}
.stbl td{padding:11px 14px;font-size:12px;text-align:right;font-family:var(--mono);border-bottom:1px solid var(--border)}.stbl td:first-child{text-align:left;font-family:var(--sans);font-weight:600}
.stbl tr.tot td{font-weight:700;background:var(--bg);border-top:2px solid var(--border)}.stbl tr.cur td{background:var(--accent-bg)}.stbl tr:hover td{background:rgba(13,138,106,.03)}

/* INPUT */
.inp-lay{display:grid;grid-template-columns:1fr 380px;gap:20px;max-width:1200px}
.fc{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:14px;box-shadow:var(--sh)}
.fc-t{font-size:13px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:6px;color:var(--navy)}
.fr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.fr:last-child{margin-bottom:0}
.fl{font-size:13px;color:var(--text2)}.fl.b{font-weight:700;color:var(--navy)}
.fi{width:165px;padding:9px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--mono);font-size:13px;text-align:right;outline:0;transition:.15s}
.fi:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(13,138,106,.08)}.fi.auto{background:var(--accent-lt);color:var(--accent);border-color:rgba(13,138,106,.2);font-weight:600}
.fl-i{flex:1;padding:9px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;outline:0;font-weight:500}.fl-i:focus{border-color:var(--accent)}
.dyn-r{gap:10px}
.btn-sv{width:100%;padding:14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(13,138,106,.25)}.btn-sv:hover{opacity:.9}
.btn-a{width:auto;padding:5px 12px;border-radius:7px;border:1px dashed var(--border2);background:0;color:var(--text3);font-size:11px;cursor:pointer;font-family:var(--sans)}.btn-a:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-lt)}
.ocr-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:8px;border:1px dashed var(--border2);background:var(--bg);color:var(--text3);font-size:11px;font-weight:600;cursor:pointer;transition:.15s}.ocr-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-lt)}
.xb{width:28px;height:28px;min-width:28px;border-radius:6px;border:1px solid var(--red);background:0;color:var(--red);cursor:pointer;font-size:13px;font-weight:700;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:0}.xb:hover{background:var(--red);color:#fff}

/* Staff input */
.stf{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.stf-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.stf-i{padding:8px 10px;border-radius:7px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;font-family:var(--mono);outline:0;text-align:right;transition:.15s}
.stf-i:focus{border-color:var(--accent)}.stf-i.nm{font-family:var(--sans);text-align:left;width:80px;font-weight:600}
.stf-i.sal{width:130px}.stf-i.ded{width:110px}.stf-i.res{width:130px;background:var(--accent-lt);color:var(--accent);font-weight:600;border-color:rgba(13,138,106,.2)}
.stf-lb{font-size:11px;color:var(--text3);flex-shrink:0;font-weight:500}
.stf-sel{padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;font-family:var(--sans);outline:0;cursor:pointer}
.stf-sel:focus{border-color:var(--accent)}

/* OCR */
.ocr{background:var(--card);border:2px dashed var(--border2);border-radius:14px;padding:28px 16px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:14px}
.ocr:hover{border-color:var(--accent);background:var(--accent-lt)}.ocr.drag{border-color:var(--accent);background:var(--accent-lt)}
.ocr-i{font-size:32px;margin-bottom:8px}.ocr-tx{font-size:12px;color:var(--text3);line-height:1.6}.ocr-tx b{color:var(--accent)}
.ocr-rs{background:var(--accent-lt);border:1px solid rgba(13,138,106,.2);border-radius:12px;padding:16px;margin-bottom:14px;display:none}.ocr-rs.show{display:block}
.ocr-rl{font-size:11px;color:var(--text3);margin-bottom:4px}.ocr-rv{font-family:var(--mono);font-size:22px;font-weight:800;color:var(--accent)}.ocr-rx{font-size:11px;color:var(--text2);margin-top:4px}
.ocr-pv{max-width:100%;max-height:100px;border-radius:8px;margin-top:8px;display:none;border:1px solid var(--border)}

/* ACCT */
.atbl{width:100%;border-collapse:collapse;margin:10px 0}
.atbl th{padding:10px 12px;font-size:11px;font-weight:600;color:var(--text3);border-bottom:2px solid var(--border);text-align:left;font-family:var(--mono)}
.atbl td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border)}.atbl td:last-child{text-align:right;font-family:var(--mono);font-weight:700;color:var(--accent)}
.atbl input{width:100%;padding:7px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;outline:0}.atbl input:focus{border-color:var(--accent)}
.cpb{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:7px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;font-weight:600}.cpb:hover{border-color:var(--accent);color:var(--accent)}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(26,35,50,.4);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center}.mo.show{display:flex}
.md{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:440px;max-height:80vh;overflow-y:auto;box-shadow:var(--sh2)}
.md h3{font-size:16px;margin-bottom:12px}.md p{font-size:12px;color:var(--text2);margin-bottom:16px}
.md input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;margin-bottom:12px;outline:0}
.md-b{display:flex;gap:8px}.md-btn{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer}.md-btn.pri{background:var(--accent);color:#fff;border-color:var(--accent)}
.ka{width:100%;min-height:140px;padding:14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.8;resize:none;white-space:pre}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--accent);color:#fff;padding:12px 28px;border-radius:12px;font-size:13px;font-weight:700;z-index:999;transition:transform .3s;pointer-events:none;box-shadow:0 4px 16px rgba(13,138,106,.3)}.toast.show{transform:translateX(-50%) translateY(0)}
.empty{text-align:center;padding:80px 20px;color:var(--text3)}.empty .ei{font-size:48px;margin-bottom:16px;opacity:.4}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
  <div class="s-logo"><h1>ì‹ ì´Œì  ì •ì‚°ê´€ë¦¬</h1><p>í˜„ëŒ€ë°±í™”ì  Â· ì›ìœŒì•¤ì½”</p></div>
  <div class="s-year"><button onclick="chgY(-1)">â—‚</button><span id="yL">2025</span><button onclick="chgY(1)">â–¸</button></div>
  <div class="m-list" id="mL"></div>
  <div class="s-bot">
    <button class="sb" style="background:var(--accent);color:#fff;border-color:var(--accent)" onclick="gDriveSave()">â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ì €ì¥</button>
    <button class="sb" onclick="gDriveLoad()">â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ë³µì›</button>
    <div style="height:1px;background:var(--border);margin:2px 0"></div>
    <button class="sb" onclick="expJSON()">ğŸ’¾ ë°±ì—… (JSON)</button>
    <button class="sb" onclick="document.getElementById('impF').click()">ğŸ“‚ ë³µì› (JSON)</button>
    <button class="sb" onclick="showApi()">ğŸ”‘ API í‚¤</button>
    <input type="file" id="impF" accept=".json" style="display:none" onchange="impJSON(event)">
    <div id="gdStatus" style="font-size:9px;color:var(--text3);text-align:center;padding:2px;font-family:var(--mono)"></div>
  </div>
</div>
<div class="main">
  <div class="top">
    <div class="top-t" id="tT"><span>12</span>ì›” ì •ì‚°</div>
    <div class="top-r">
      <div class="vtabs">
        <button class="vt act" onclick="sw('rpt',this)">ğŸ“‹ ë³´ê³ ì„œ</button>
        <button class="vt" onclick="sw('labor',this)">ğŸ‘¥ ì¸ê±´ë¹„</button>
        <button class="vt" onclick="sw('trend',this)">ğŸ“Š íŠ¸ë Œë“œ</button>
        <button class="vt" onclick="sw('inp',this)">âœï¸ ì…ë ¥</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="tb" onclick="capImg()">ğŸ“¸ ì´ë¯¸ì§€</button>
        <button class="tb" onclick="capPDF()">ğŸ“„ PDF</button>
        <button class="tb" onclick="expXLSX()">ğŸ“Š ì—‘ì…€</button>
      </div>
    </div>
  </div>
  <div class="ct" id="ct"></div>
</div>
</div>
<div class="mo" id="apiMo"><div class="md"><h3>ğŸ”‘ API í‚¤ ì„¤ì •</h3><p>OCR ìŠ¤ìº”ì— ì‚¬ìš©. ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p><div style="margin-bottom:12px"><div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px">âœ¨ Gemini API (ë¬´ë£Œ ì¶”ì²œ)</div><input type="password" id="gemIn" placeholder="AIzaSy..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;outline:0"><div style="font-size:10px;color:var(--text3);margin-top:3px"><a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent)">Google AI Studio</a>ì—ì„œ ë¬´ë£Œ ë°œê¸‰</div></div><div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:4px">Claude API (ìœ ë£Œ ë°±ì—…)</div><input type="password" id="apiIn" placeholder="sk-ant-api03-..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;outline:0"></div><div class="md-b"><button class="md-btn" onclick="hideApi()">ì·¨ì†Œ</button><button class="md-btn pri" onclick="saveApi()">ì €ì¥</button></div></div></div>
<div class="mo" id="kakMo"><div class="md"><h3>ğŸ’¬ ì¹´í†¡ ì†¡ê¸ˆ í…ìŠ¤íŠ¸</h3><p>ë³µì‚¬í•˜ì—¬ ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°</p><textarea class="ka" id="kakTx" readonly></textarea><div class="md-b" style="margin-top:12px"><button class="md-btn" onclick="$('#kakMo').classList.remove('show')">ë‹«ê¸°</button><button class="md-btn pri" onclick="navigator.clipboard.writeText($('#kakTx').value);toast('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ')">ğŸ“‹ ë³µì‚¬</button></div></div></div>
<div class="toast" id="toast"></div>

<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
let Y=2025,M=12,V='rpt',D={},CH={};
const SK='sinchon_v5',AK='sinchon_api',GK='sinchon_gemini',BK='sinchon_bank';
let BNK={};
function init(){
  // API í‚¤ ìë™ ì„¤ì • (localStorageì— ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¸íŒ…)
  if(!localStorage.getItem(GK))localStorage.setItem(GK,'AIzaSyDyVjF8xDEsZNJk3_TTaWPj6bzluiiY3To');
  if(!localStorage.getItem(AK))localStorage.setItem(AK,'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');
  try{BNK=JSON.parse(localStorage.getItem(BK))||{}}catch(e){BNK={}}
  // ê³„ì¢Œì •ë³´ ê°•ì œ ì„¸íŒ…
  const defBnk={'ì´ì±„ì˜':{bank:'ìš°ë¦¬ì€í–‰',acct:'001-21-0174-858'},'ì„ëª…ì':{bank:'ë†í˜‘',acct:'356-0906-5354-83'},'ì„œì§€í¬':{bank:'ì‹ í•œ',acct:'110-58775-1268'},'ì„œí˜„ê²½':{bank:'êµ­ë¯¼',acct:'814301-04-064842'},'ì •í˜œë¹ˆ':{bank:'ìš°ë¦¬ì€í–‰',acct:'119-04-972102-601'},'ì •ì˜ì†¡':{bank:'',acct:''},'ê¸¸í˜¸ì •':{bank:'ë†í˜‘',acct:'302-1204-0117-61'}};
  for(const nm in defBnk){BNK[nm]=defBnk[nm]}
  svB();
  try{D=JSON.parse(localStorage.getItem(SK))||{}}catch(e){D={}}
  if(!D['2025'])D['2025']={};
  const S=[
    {name:'ê¸¸í˜¸ì •',salary:2800000,type:'4ëŒ€ë³´í—˜',ded:159130,net:2640870},
    {name:'ì†¡ì„±ë¡€',salary:2700000,type:'4ëŒ€ë³´í—˜',ded:153740,net:2546260},
    {name:'ì •ì˜ì†¡',salary:2160000,type:'ì¼ë‹¹',ded:71280,net:2088720},
    {name:'í•œë¯¸ì• ',salary:360000,type:'ì¼ë‹¹',ded:3240,net:356760}
  ];
  const S8=[{name:'ê¸¸í˜¸ì •',salary:1772865,type:'4ëŒ€ë³´í—˜',ded:61860,net:1711005},{name:'ì†¡ì„±ë¡€',salary:1772865,type:'4ëŒ€ë³´í—˜',ded:61860,net:1711005},{name:'ì •ì˜ì†¡',salary:1680000,type:'ì¼ë‹¹',ded:55440,net:1624560}];
  const INS={health:368320,employ:101680,injury:35710},TAX={i1:75290,i2:124800,loc:20000};
  const pre={
    8:{revenue:15923580,commission:3184717,netRevenue:12738863,foodCost:7450961,foodDetail:{entree:7159601,side:291360,oil:0},rent:3184717,utilities:132000,hongPay:3000000,staff:S8,totalSalary:5225730,insurance:{health:0,employ:0,injury:0},totalInsurance:582800,laborCost:5808530,tax:{i1:0,i2:0,loc:0},totalTax:0},
    9:{revenue:21738458,commission:4347692,netRevenue:17390766,foodCost:8048301,foodDetail:{entree:7793701,side:254600,oil:0},rent:4347692,utilities:132000,hongPay:3000000,staff:S,totalSalary:8020000,insurance:INS,totalInsurance:505710,laborCost:8358410,tax:TAX,totalTax:220090},
    10:{revenue:18386100,commission:3677221,netRevenue:14708879,foodCost:6791784,foodDetail:{entree:6375264,side:306520,oil:110000},rent:3677221,utilities:132000,hongPay:0,staff:S,totalSalary:8020000,insurance:INS,totalInsurance:505710,laborCost:8358410,tax:TAX,totalTax:220090},
    11:{revenue:16986400,commission:3397281,netRevenue:13589119,foodCost:6627511,foodDetail:{entree:6253991,side:306520,oil:67000},rent:3397281,utilities:132000,hongPay:0,staff:S,totalSalary:8020000,insurance:INS,totalInsurance:505710,laborCost:8358410,tax:TAX,totalTax:220090},
    12:{revenue:19687108,commission:3937422,netRevenue:15749686,foodCost:7070888,foodDetail:{entree:6743428,side:260460,oil:67000},rent:3937422,utilities:132000,hongPay:0,staff:S,totalSalary:8020000,insurance:INS,totalInsurance:505710,laborCost:8358410,tax:TAX,totalTax:220090}
  };
  for(let m in pre)if(!D['2025'][m])D['2025'][m]=pre[m];
  // ëª¨ë“  ì›” ë°ì´í„° ì¬ê³„ì‚° (laborCost = ì°¨ì¸ì§€ê¸‰ì•¡ + 4ëŒ€ë³´í—˜ + ì„¸ê¸ˆ)
  for(let yr in D){for(let mo in D[yr]){
    var dd=D[yr][mo];if(!dd)continue;
    // insItems/taxItems2 ì—†ìœ¼ë©´ ìƒì„±
    if(!dd.insItems&&dd.insurance)dd.insItems=[{l:'ê±´ê°•ë³´í—˜',v:dd.insurance.health||0},{l:'ê³ ìš©ë³´í—˜',v:dd.insurance.employ||0},{l:'ì‚°ì¬ë³´í—˜',v:dd.insurance.injury||0}];
    if(!dd.taxItems2&&dd.tax)dd.taxItems2=[{l:'ì†Œë“ì„¸1',v:dd.tax.i1||0},{l:'ì§€ë°©ì„¸',v:dd.tax.loc||0},{l:'ì†Œë“ì„¸2',v:dd.tax.i2||0}];
    if(!dd.taxItems&&dd.tax)dd.taxItems=[{l:'ì†Œë“ì„¸1',v:dd.tax.i1||0},{l:'ì§€ë°©ì„¸',v:dd.tax.loc||0},{l:'ì†Œë“ì„¸2',v:dd.tax.i2||0}];
    recalcAll(dd);
  }}
  sv();rM();rV();
}
function sv(){localStorage.setItem(SK,JSON.stringify(D))}
function svB(){localStorage.setItem(BK,JSON.stringify(BNK))}
function fmt(n){return n==null||isNaN(n)?'-':'â‚©'+Math.round(n).toLocaleString('ko-KR')}
function fS(n){const a=Math.abs(n);return a>=1e8?(n/1e8).toFixed(1)+'ì–µ':a>=1e4?Math.round(n/1e4).toLocaleString()+'ë§Œ':n.toLocaleString()}
function pc(n){return(n*100).toFixed(1)+'%'}
function comp(d){if(!d)return null;const r=d.revenue||0,c=d.commission||0,n=d.netRevenue||0,f=d.foodCost||0,rn=d.rent||0,l=d.laborCost||0,u=d.utilities||0,t=d.totalTax||0,h=d.hongPay||0;
  const e=f+l+u+h,p=n-e,rt=r>0?p/r:0;return{r,c,n,f,rn,l,u,t,h,e,p,rt}}
function rM(){const yd=D[Y]||{};let h='';for(let m=1;m<=12;m++){const has=!!yd[m],act=m===M;let cls='mi';if(has)cls+=' hd';if(act)cls+=' act';let sub='';if(has){const c=comp(yd[m]);sub=`<span class="vl" style="color:${act?'rgba(255,255,255,.8)':(c.p>=0?'var(--accent)':'var(--red)')}">${fS(c.p)}</span>`}h+=`<button class="${cls}" onclick="sM(${m})">${m}ì›” ${sub}<span class="dot"></span></button>`}$('#mL').innerHTML=h;$('#yL').textContent=Y}
function sM(m){M=m;rM();rV()}
function chgY(d){Y+=d;rM();rV()}
function sw(v,b){V=v;$$('.vt').forEach(t=>t.classList.remove('act'));if(b)b.classList.add('act');rV()}
function rV(){$('#tT').innerHTML=`<span>${M}</span>ì›” ì •ì‚°`;Object.values(CH).forEach(c=>c.destroy());CH={};if(V==='rpt')rRpt();else if(V==='labor')rLab();else if(V==='trend')rTrd();else rInp()}

// â•â•â• REPORT ìš”ì•½ë³¸ â•â•â•
function rRpt(){const d=(D[Y]||{})[M];if(!d){$('#ct').innerHTML=`<div class="empty"><div class="ei">ğŸ“‹</div><p>${M}ì›” ë°ì´í„° ì—†ìŒ</p></div>`;return}
  const c=comp(d),ip=c.p>=0;
  const totalExp=c.u+c.f+c.l+(c.h||0);
  const profit=c.n-totalExp;
  const supplyAmt=Math.round(c.r/1.1);
  const vatAmt=c.r-supplyAmt;
  const pC=profit>=0?'var(--accent)':'var(--red)';
  $('#ct').innerHTML=`<div id="capA">
    <div style="display:grid;grid-template-columns:1fr 1.4fr 1fr;gap:20px;align-items:stretch;max-width:1200px;margin:0 auto">

      <!-- â‘  ì…ê¸ˆì•ˆë‚´ -->
      <div style="background:var(--card);border:2px solid var(--accent);border-radius:16px;overflow:hidden;box-shadow:0 6px 24px rgba(13,138,106,0.1);display:flex;flex-direction:column">
        <div style="background:linear-gradient(135deg,#0d8a6a,#0a7359);padding:14px;text-align:center">
          <div style="font-size:14px;font-weight:900;color:#fff;letter-spacing:1.5px">ğŸ’³ ì…ê¸ˆ ì•ˆë‚´</div>
        </div>
        <div style="padding:22px 20px;flex:1;display:flex;flex-direction:column">
          <div style="font-size:11px;color:var(--text3);margin-bottom:4px;font-weight:600">ì˜ˆê¸ˆì£¼</div>
          <div style="font-size:17px;font-weight:900;color:var(--navy);margin-bottom:16px">ì£¼ì‹íšŒì‚¬ ì›ìœŒì•¤ì½”</div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:4px;font-weight:600">ì…ê¸ˆê³„ì¢Œ</div>
          <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--navy);margin-bottom:2px">ì‹ í•œì€í–‰</div>
          <div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--navy);letter-spacing:0.3px">100-038-120057</div>
          <div style="height:2px;background:linear-gradient(90deg,var(--accent),transparent);margin:18px 0;border-radius:2px"></div>
          <div style="font-size:12px;color:var(--accent);margin-bottom:10px;font-weight:700;letter-spacing:0.5px">ì…ê¸ˆì•¡</div>
          <div style="background:linear-gradient(135deg,rgba(13,138,106,0.06),rgba(13,138,106,0.02));border:1.5px solid rgba(13,138,106,0.18);border-radius:12px;padding:18px 12px;text-align:center">
            <div style="font-family:var(--mono);font-size:30px;font-weight:900;color:var(--accent);letter-spacing:-0.5px">${fmt(c.n)}</div>
          </div>
          <div style="flex:1"></div>
          <div style="margin-top:16px;padding:12px;background:var(--accent-bg);border-radius:10px;border-left:3px solid var(--accent);font-size:11px;color:var(--text2);line-height:1.7">
            ìœ„ ê¸ˆì•¡ì„ ìƒê¸° ê³„ì¢Œë¡œ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            <div style="font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:4px">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ 275-88-03346</div>
          </div>
        </div>
      </div>

      <!-- â‘¡ ì •ì‚° ìš”ì•½ -->
      <div class="rpt" style="display:flex;flex-direction:column"><div class="rpt-h"><h2>í˜„ëŒ€ë°±í™”ì  ì‹ ì´Œì  ${M}ì›” ë§¤ì¶œ ì •ì‚°</h2><p>${Y}ë…„ ${M}ì›” Â· ë³´ê³ : ì£¼ì‹íšŒì‚¬ í™ìˆœìš° Â· 275-88-03346</p></div>
    <div class="rpt-b" style="flex:1;display:flex;flex-direction:column">
      <div class="rr"><span class="rl b">ì´ ë§¤ì¶œ (VAT í¬í•¨)</span><span class="rv big">${fmt(c.r)}</span></div>
      <div class="rr"><span class="rl">í˜„ëŒ€ìˆ˜ìˆ˜ë£Œ (20%)</span><span class="rv" style="color:var(--red)">-${fmt(c.c)}</span></div>
      <div class="rr hl"><span class="rl b">ì§€ê¸‰ì•¡</span><span class="rv big" style="color:var(--accent)">${fmt(c.n)}</span></div>
      <div class="rr sep"></div>
      <div class="rr"><span class="rl">ê¸°ì¥ë£Œ</span><span class="rv">${fmt(c.u)}</span></div>
      ${(d.foodItems||[{l:'ì—”í‘¸ë“œ',v:d.foodDetail?.entree},{l:'ìš°ì‚¼ê²¹&ì‹ìì¬',v:d.foodDetail?.side},{l:'ì‹ìš©ìœ ',v:d.foodDetail?.oil}]).filter(it=>it.v).map(it=>'<div class="rr"><span class="rl">'+it.l+'</span><span class="rv">'+fmt(it.v)+'</span></div>').join('')}
      <div class="rr" style="border-bottom:2px solid var(--border)"><span class="rl b">ì‹ì¬ë£Œ í•©ê³„</span><span class="rv" style="font-weight:700">${fmt(c.f)}</span></div>
      <div class="rr"><span class="rl b">ì¸ê±´ë¹„ í•©ê³„</span><span class="rv" style="font-weight:700">${fmt(c.l)}</span></div>
      <div style="padding:2px 0 0;font-size:10px;color:var(--text3);font-style:italic">* 4ëŒ€ë³´í—˜ ë° ì„¸ê¸ˆ í¬í•¨</div>
      ${c.h>0?`<div class="rr"><span class="rl">í™ìˆœìš° ë¶„í• ì •ì‚°</span><span class="rv">${fmt(c.h)}</span></div>`:''}
      <div class="rr sep"></div>
      <div class="rr"><span class="rl b">ì§€ê¸‰ì•¡</span><span class="rv">${fmt(c.n)}</span></div>
      <div class="rr"><span class="rl b" style="color:var(--red)">ì´ ì§€ì¶œ</span><span class="rv" style="color:var(--red);font-weight:700">${fmt(totalExp)}</span></div>
      <div style="flex:1"></div>
      <div class="pbox ${profit>=0?'pos':'neg'}"><div class="pbox-l" style="font-size:12px">ì„¸ì „ ìˆ˜ìµ</div><div class="pbox-v" style="color:${pC};font-size:24px">${fmt(profit)}</div></div>
    </div></div>

      <!-- â‘¢ ì„¸ê¸ˆê³„ì‚°ì„œ -->
      <div style="background:var(--card);border:2px solid var(--navy2);border-radius:16px;overflow:hidden;box-shadow:0 6px 24px rgba(26,35,50,0.08);display:flex;flex-direction:column">
        <div style="background:linear-gradient(135deg,#1a2332,#2d3a4a);padding:14px;text-align:center">
          <div style="font-size:14px;font-weight:900;color:#fff;letter-spacing:1.5px">ğŸ“„ ì„¸ê¸ˆê³„ì‚°ì„œ</div>
        </div>
        <div style="padding:22px 20px;flex:1;display:flex;flex-direction:column">
          <div style="font-size:11px;color:var(--text3);margin-bottom:4px;font-weight:600">ê³µê¸‰ì</div>
          <div style="font-size:14px;font-weight:900;color:var(--navy);margin-bottom:12px">ì£¼ì‹íšŒì‚¬ í˜„ëŒ€ë°±í™”ì </div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:4px;font-weight:600">ê³µê¸‰ë°›ëŠ”ì</div>
          <div style="font-size:14px;font-weight:900;color:var(--navy);margin-bottom:14px">ì£¼ì‹íšŒì‚¬ í™ìˆœìš°</div>
          <div style="height:2px;background:linear-gradient(90deg,var(--navy),transparent);margin:0 0 14px;border-radius:2px"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg2)">
            <span style="font-size:12px;color:var(--text2)">ê³µê¸‰ê°€ì•¡</span>
            <span style="font-family:var(--mono);font-size:14px;font-weight:700">${fmt(supplyAmt)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg2)">
            <span style="font-size:12px;color:var(--text2)">ì„¸ì•¡ (VAT)</span>
            <span style="font-family:var(--mono);font-size:14px;font-weight:700">${fmt(vatAmt)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 6px;background:rgba(26,35,50,0.03);margin:6px -6px;border-radius:8px">
            <span style="font-size:13px;font-weight:900;color:var(--navy)">í•©ê³„ê¸ˆì•¡</span>
            <span style="font-family:var(--mono);font-size:17px;font-weight:900;color:var(--navy)">${fmt(c.r)}</span>
          </div>

          <div style="height:1px;background:var(--border);margin:10px 0"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg2)">
            <span style="font-size:12px;color:var(--text2)">ìˆ˜ìˆ˜ë£Œ (20%)</span>
            <span style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--red)">${fmt(c.c)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 6px;background:rgba(13,138,106,0.04);margin:6px -6px;border-radius:8px">
            <span style="font-size:13px;font-weight:900;color:var(--accent)">ì •ì‚°ì§€ê¸‰ì•¡</span>
            <span style="font-family:var(--mono);font-size:17px;font-weight:900;color:var(--accent)">${fmt(c.n)}</span>
          </div>

          <div style="flex:1"></div>
          <div style="margin-top:14px;padding:10px;background:var(--bg);border-radius:8px;font-size:10px;color:var(--text3);line-height:1.6;font-family:var(--mono)">
            ì‘ì„±ì¼: ${Y}.${String(M).padStart(2,'0')}.ë§ì¼<br>
            ì‚¬ì—…ìë²ˆí˜¸: 104-81-45370
          </div>
        </div>
      </div>

    </div>
  </div>`}

// â•â•â• LABOR â•â•â•
function rLab(){
  const d=(D[Y]||{})[M];
  if(!d){$('#ct').innerHTML='<div class="empty"><div class="ei">ğŸ‘¥</div><p>'+M+'ì›” ë°ì´í„° ì—†ìŒ</p></div>';return}
  const staff=d.staff||[];
  const tS=staff.reduce((a,s)=>a+(s.salary||0),0);
  const tD=staff.reduce((a,s)=>a+(s.ded||0),0);
  const tN=staff.reduce((a,s)=>a+(s.net||0),0);
  // 4ëŒ€ë³´í—˜ ë™ì  í•­ëª©
  if(!d.insItems)d.insItems=[{l:'ê±´ê°•ë³´í—˜',v:d.insurance?.health||0},{l:'ê³ ìš©ë³´í—˜',v:d.insurance?.employ||0},{l:'ì‚°ì¬ë³´í—˜',v:d.insurance?.injury||0}];
  var insItems=d.insItems;
  var tIns=insItems.reduce(function(a,it){return a+(it.v||0)},0);
  // ì„¸ê¸ˆ ë™ì  í•­ëª©
  if(!d.taxItems2)d.taxItems2=[{l:'ì†Œë“ì„¸1',v:d.tax?.i1||0},{l:'ì§€ë°©ì„¸',v:d.tax?.loc||0},{l:'ì†Œë“ì„¸2',v:d.tax?.i2||0}];
  var taxItems=d.taxItems2;
  var tTax=taxItems.reduce(function(a,it){return a+(it.v||0)},0);
  // ì§ì› í–‰
  var stRows='';
  staff.forEach(function(s,i){
    var sel4='';var sel33='';var selD='';
    if(s.type==='4ëŒ€ë³´í—˜')sel4=' selected';
    if(s.type==='3.3%')sel33=' selected';
    if(s.type==='ì¼ë‹¹')selD=' selected';
    stRows+='<tr><td>'+(i+1)+'</td>';
    stRows+='<td><input value="'+(s.name||'')+'" style="width:80px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-weight:700;font-family:var(--sans);font-size:13px" onchange="updStf('+i+',\'name\',this.value)"></td>';
    stRows+='<td><select style="border:1px solid var(--border);border-radius:6px;padding:4px;font-size:11px;font-family:var(--sans)" onchange="updStf('+i+',\'type\',this.value)">';
    stRows+='<option value="4ëŒ€ë³´í—˜"'+sel4+'>4ëŒ€ë³´í—˜</option><option value="3.3%"'+sel33+'>3.3%</option><option value="ì¼ë‹¹"'+selD+'>ì¼ë‹¹</option></select></td>';
    stRows+='<td><input value="'+(s.salary||0)+'" style="width:100px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:var(--mono);font-size:13px;text-align:right" onchange="updStf('+i+',\'salary\',parseInt(this.value)||0)"></td>';
    stRows+='<td style="color:var(--red)">'+fmt(s.ded)+'</td>';
    stRows+='<td style="color:var(--accent);font-weight:700">'+fmt(s.net)+'</td>';
    stRows+='<td><button style="border:0;background:0;color:var(--red);cursor:pointer;font-size:14px;padding:4px" onclick="delStfLab('+i+')">âœ•</button></td></tr>';
  });
  // 4ëŒ€ë³´í—˜ í–‰
  var insRows='';
  insItems.forEach(function(it,i){
    insRows+='<tr><td><input value="'+(it.l||'')+'" style="width:100px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px" onchange="updInsItem('+i+',\'l\',this.value)"></td>';
    insRows+='<td><input value="'+(it.v||0)+'" style="width:120px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:var(--mono);font-size:12px;text-align:right" onchange="updInsItem('+i+',\'v\',this.value)"></td>';
    insRows+='<td style="width:30px"><button style="border:0;background:0;color:var(--red);cursor:pointer;font-size:14px;padding:4px" onclick="delInsItem('+i+')">âœ•</button></td></tr>';
  });
  // ì„¸ê¸ˆ í–‰
  var taxRows='';
  taxItems.forEach(function(it,i){
    taxRows+='<tr><td><input value="'+(it.l||'')+'" style="width:100px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px" onchange="updTaxItem('+i+',\'l\',this.value)"></td>';
    taxRows+='<td><input value="'+(it.v||0)+'" style="width:120px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:var(--mono);font-size:12px;text-align:right" onchange="updTaxItem('+i+',\'v\',this.value)"></td>';
    taxRows+='<td style="width:30px"><button style="border:0;background:0;color:var(--red);cursor:pointer;font-size:14px;padding:4px" onclick="delTaxItem('+i+')">âœ•</button></td></tr>';
  });
  // ê³„ì¢Œ í…Œì´ë¸” - ì„±ëª…/ì€í–‰/ê³„ì¢Œ/ì°¨ì¸ì§€ê¸‰ì•¡ ëª¨ë‘ í¸ì§‘ ê°€ëŠ¥
  var ar='';
  staff.forEach(function(s,i){
    var b=BNK[s.name]||{};
    ar+='<tr>';
    ar+='<td><input value="'+(s.name||'')+'" placeholder="ì„±ëª…" style="width:70px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-weight:700;font-size:13px" onchange="updAcctName('+i+',this.value)"></td>';
    ar+='<td><input value="'+(b.bank||'')+'" placeholder="ì€í–‰ëª…" onchange="updB(\''+(s.name||'')+'\',\'bank\',this.value)"></td>';
    ar+='<td><input value="'+(b.acct||'')+'" placeholder="ê³„ì¢Œë²ˆí˜¸" style="font-family:var(--mono)" onchange="updB(\''+(s.name||'')+'\',\'acct\',this.value)"></td>';
    ar+='<td><input value="'+(s.net||0)+'" style="width:110px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:var(--mono);font-size:13px;text-align:right;color:var(--accent);font-weight:700" onchange="updStfNet('+i+',this.value)"></td>';
    ar+='<td style="width:30px"><button style="border:0;background:0;color:var(--red);cursor:pointer;font-size:14px;padding:4px" onclick="delAcctRow('+i+')">âœ•</button></td>';
    ar+='</tr>';
  });

  var h='<div id="capA" style="max-width:860px">';
  // â‘  ì§ì› ê¸‰ì—¬
  h+='<div class="fc" id="dz-staff"><div class="fc-t" style="justify-content:space-between"><span>ğŸ‘¥ '+Y+'ë…„ '+M+'ì›” ì¸ê±´ë¹„</span>';
  h+='<div style="display:flex;gap:6px;align-items:center">';
  h+='<button class="btn-a" onclick="addStfLab()">+ ì§ì› ì¶”ê°€</button>';
  h+='<div class="ocr-btn" onclick="document.getElementById(\'labOcr\').click()"><span>ğŸ“„</span> ì¸ê±´ë¹„ OCR<input type="file" id="labOcr" accept="image/*,.pdf" multiple style="display:none" onchange="hLabOCR(event)"></div>';
  h+='</div></div>';
  h+='<div class="ocr-rs" id="labRes"><div class="ocr-rl">ğŸ¤– AI ìë™ë¶„ë¥˜</div><div id="labBody"></div></div>';
  h+='<table class="ltbl"><thead><tr><th>NO</th><th style="text-align:left">ì„±ëª…</th><th>êµ¬ë¶„</th><th>ê¸‰ì—¬</th><th>ê³µì œì•¡</th><th style="color:var(--accent)">ì°¨ì¸ì§€ê¸‰ì•¡</th><th></th></tr></thead><tbody>';
  h+=stRows;
  h+='<tr class="tot"><td></td><td>í•©ê³„ '+staff.length+'ëª…</td><td></td><td>'+fmt(tS)+'</td><td style="color:var(--red)">'+fmt(tD)+'</td><td style="color:var(--accent);font-weight:700">'+fmt(tN)+'</td><td></td></tr></tbody></table></div>';

  // â‘¡ 4ëŒ€ë³´í—˜
  h+='<div class="fc" id="dz-ins"><div class="fc-t" style="justify-content:space-between"><span>ğŸ¦ 4ëŒ€ë³´í—˜ <span style="font-size:11px;color:var(--text3);font-weight:400">ìë™ì´ì²´</span></span>';
  h+='<div style="display:flex;gap:6px;align-items:center">';
  h+='<button class="btn-a" onclick="addInsItem()">+ í•­ëª© ì¶”ê°€</button>';
  h+='<div class="ocr-btn" onclick="document.getElementById(\'insOcr\').click()"><span>ğŸ“„</span> OCR<input type="file" id="insOcr" accept="image/*,.pdf" multiple style="display:none" onchange="hSecOCR(event,\'ins\')"></div>';
  h+='</div></div>';
  h+='<div class="ocr-rs" id="insRes"><div class="ocr-rl">ğŸ¤– AI ìë™ë¶„ë¥˜</div><div id="insBody"></div></div>';
  h+='<table class="itbl"><thead><tr><th>ëª©ë¡</th><th>ë‚©ë¶€ê¸ˆì•¡</th><th></th></tr></thead><tbody>';
  h+=insRows;
  h+='<tr><td><b>í•©ê³„</b></td><td style="font-weight:700;font-family:var(--mono)">'+fmt(tIns)+'</td><td></td></tr></tbody></table></div>';

  // â‘¢ ì„¸ê¸ˆ ë‚©ë¶€
  h+='<div class="fc" id="dz-tax"><div class="fc-t" style="justify-content:space-between"><span>ğŸ“‹ ì„¸ê¸ˆ ë‚©ë¶€</span>';
  h+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">';
  h+='<button class="btn-a" onclick="addTaxItem()">+ í•­ëª© ì¶”ê°€</button>';
  h+='<div class="ocr-btn" onclick="document.getElementById(\'taxOcr\').click()"><span>ğŸ“„</span> OCR<input type="file" id="taxOcr" accept="image/*,.pdf" multiple style="display:none" onchange="hSecOCR(event,\'tax\')"></div>';
  h+='<button class="cpb" onclick="cpTax()">ğŸ“‹ ë³µì‚¬</button><button class="cpb" onclick="showKakTax()">ğŸ’¬ ì¹´í†¡</button><button class="cpb" onclick="expTax()">ğŸ“Š ì—‘ì…€</button>';
  h+='</div></div>';
  h+='<div class="ocr-rs" id="taxRes"><div class="ocr-rl">ğŸ¤– AI ìë™ë¶„ë¥˜</div><div id="taxBody"></div></div>';
  h+='<table class="itbl"><thead><tr><th>ëª©ë¡</th><th>ë‚©ë¶€ê¸ˆì•¡</th><th></th></tr></thead><tbody>';
  h+=taxRows;
  h+='<tr><td><b>í•©ê³„</b></td><td style="font-weight:700;font-family:var(--mono)">'+fmt(tTax)+'</td><td></td></tr></tbody></table></div>';

  // â‘£ ì¸ê±´ë¹„ ì´í•©
  h+='<div class="fc"><div class="rr hl" style="margin:0"><span class="rl b">ì¸ê±´ë¹„ ì´ í•©ê³„</span><span class="rv big">'+fmt(tN+tIns+tTax)+'</span></div>';
  h+='<div style="padding:4px 12px;font-size:10px;color:var(--text3);font-style:italic">ì°¨ì¸ì§€ê¸‰ì•¡ '+fmt(tN)+' + 4ëŒ€ë³´í—˜ '+fmt(tIns)+' + ì„¸ê¸ˆ '+fmt(tTax)+'</div></div>';

  // â‘¤ ê¸‰ì—¬ ì†¡ê¸ˆ ê³„ì¢Œ
  h+='<div class="fc" id="dz-acct"><div class="fc-t" style="justify-content:space-between"><span>ğŸ¦ ê¸‰ì—¬ ì†¡ê¸ˆ ê³„ì¢Œ</span>';
  h+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">';
  h+='<button class="btn-a" onclick="addAcctRow()">+ ëª©ë¡ ì¶”ê°€</button>';
  h+='<div class="ocr-btn" onclick="document.getElementById(\'acctOcr\').click()"><span>ğŸ“„</span> OCR<input type="file" id="acctOcr" accept="image/*,.pdf" multiple style="display:none" onchange="hSecOCR(event,\'acct\')"></div>';
  h+='<button class="cpb" onclick="cpAcct()">ğŸ“‹ ë³µì‚¬</button><button class="cpb" onclick="showKak()">ğŸ’¬ ì¹´í†¡</button><button class="cpb" onclick="expAcct()">ğŸ“Š ì—‘ì…€</button>';
  h+='</div></div>';
  h+='<div class="ocr-rs" id="acctRes"><div class="ocr-rl">ğŸ¤– AI ìë™ë¶„ë¥˜</div><div id="acctBody"></div></div>';
  h+='<table class="atbl"><thead><tr><th>ì„±ëª…</th><th>ì€í–‰</th><th>ê³„ì¢Œë²ˆí˜¸</th><th style="text-align:right">ì°¨ì¸ì§€ê¸‰ì•¡</th><th></th></tr></thead><tbody>'+ar+'</tbody></table></div>';

  // â‘¥ ì €ì¥ ë²„íŠ¼
  h+='<button class="btn-sv" onclick="saveLabor()" style="margin-top:16px">ğŸ’¾ ì¸ê±´ë¹„ ì €ì¥</button>';

  h+='</div>';
  $('#ct').innerHTML=h;

  // ë“œë˜ê·¸&ë“œë¡­ â†’ ì „ë¶€ universalOCR (ì–´ë””ë“  ë†“ìœ¼ë©´ ìë™ë¶„ë¥˜)
  setupDZ('dz-staff',function(f){universalOCR([f],'lab')},function(fs){universalOCR(fs,'lab')});
  setupDZ('dz-ins',function(f){universalOCR([f],'ins')},function(fs){universalOCR(fs,'ins')});
  setupDZ('dz-tax',function(f){universalOCR([f],'tax')},function(fs){universalOCR(fs,'tax')});
  setupDZ('dz-acct',function(f){universalOCR([f],'acct')},function(fs){universalOCR(fs,'acct')});
}

// ë“œë˜ê·¸&ë“œë¡­ (ë‹¤ì¤‘íŒŒì¼ ì§€ì›)
function setupDZ(id,handler,multiHandler){
  var el=$('#'+id);if(!el)return;
  el.addEventListener('dragover',function(e){e.preventDefault();el.style.outline='2px dashed var(--accent)';el.style.outlineOffset='-2px'});
  el.addEventListener('dragleave',function(){el.style.outline='none'});
  el.addEventListener('drop',function(e){e.preventDefault();el.style.outline='none';
    var files=Array.from(e.dataTransfer.files||[]);
    if(files.length>1&&multiHandler){multiHandler(files)}
    else if(files.length===1)handler(files[0]);
  });
}

// ì¸ê±´ë¹„ ì „ì²´ ì €ì¥
function saveLabor(){
  var d=D[Y]?.[M];if(!d)return;
  recalcAll(d);syncInsObj(d);syncTaxObj(d);
  sv();svB();rM();toast('ğŸ’¾ ì¸ê±´ë¹„ ì €ì¥ ì™„ë£Œ');
}

// ê¸‰ì—¬ ì†¡ê¸ˆ ê³„ì¢Œì—ì„œ ì°¨ì¸ì§€ê¸‰ì•¡ ìˆ˜ì • (ì¸ë±ìŠ¤ ê¸°ë°˜)
function updStfNet(idx,val){
  var d=D[Y]?.[M];if(!d||!d.staff)return;
  var v=parseInt(String(val).replace(/[^0-9]/g,''))||0;
  if(d.staff[idx]){d.staff[idx].net=v;d.staff[idx].ded=d.staff[idx].salary-v}
  recalcAll(d);sv();rM();rLab();
}
// ê³„ì¢Œ ì„±ëª… ìˆ˜ì • â†’ staff + BNK ì–‘ë°©í–¥ ì—°ë™
function updAcctName(idx,newName){
  var d=D[Y]?.[M];if(!d||!d.staff)return;
  var oldName=d.staff[idx].name;
  // BNKì—ì„œ ì´ì „ ì´ë¦„ì˜ ê³„ì¢Œì •ë³´ë¥¼ ìƒˆ ì´ë¦„ìœ¼ë¡œ ì´ë™
  if(oldName&&BNK[oldName]){
    BNK[newName]=BNK[oldName];
    if(oldName!==newName)delete BNK[oldName];
    svB();
  }
  d.staff[idx].name=newName;
  sv();rLab();
}
// ê³„ì¢Œ ëª©ë¡ ì¶”ê°€ (ì§ì›ë„ ë™ì‹œ ì¶”ê°€)
function addAcctRow(){
  if(!D[Y])D[Y]={};if(!D[Y][M])D[Y][M]={};var d=D[Y][M];
  if(!d.staff)d.staff=[];
  d.staff.push({name:'',salary:0,type:'ì¼ë‹¹',ded:0,net:0});
  sv();rLab();toast('ëª©ë¡ ì¶”ê°€ë¨');
}
// ê³„ì¢Œ ëª©ë¡ ì‚­ì œ
function delAcctRow(idx){
  var d=D[Y]?.[M];if(!d||!d.staff)return;
  var nm=d.staff[idx].name||'ì‹ ê·œ';
  if(!confirm(nm+' ì‚­ì œ?'))return;
  d.staff.splice(idx,1);recalcAll(d);sv();rM();rLab();toast('ì‚­ì œ');
}

// ì§ì› ì¶”ê°€/ì‚­ì œ/ìˆ˜ì •
function addStfLab(){
  if(!D[Y])D[Y]={};if(!D[Y][M])D[Y][M]={};var d=D[Y][M];
  if(!d.staff)d.staff=[];
  d.staff.push({name:'',salary:0,type:'ì¼ë‹¹',ded:0,net:0});
  sv();rLab();toast('ì§ì› ì¶”ê°€ë¨')
}
function delStfLab(i){
  var d=D[Y]?.[M];if(!d||!d.staff)return;
  var nm=d.staff[i].name||'ì‹ ê·œ';if(!confirm(nm+' ì‚­ì œ?'))return;
  d.staff.splice(i,1);recalcAll(d);sv();rM();rLab();toast('ì‚­ì œ')
}
function updStf(i,field,val){
  var d=D[Y]?.[M];if(!d||!d.staff||!d.staff[i])return;
  d.staff[i][field]=val;
  if(field==='salary'){
    var s=d.staff[i];
    if(s.type==='4ëŒ€ë³´í—˜'){s.ded=Math.round(s.salary*0.0935);s.net=s.salary-s.ded}
    else{s.ded=Math.round(s.salary*0.033);s.net=s.salary-s.ded}
  }
  recalcAll(d);sv();rM();rLab()
}

// 4ëŒ€ë³´í—˜ í•­ëª©
function addInsItem(){
  var d=D[Y]?.[M];if(!d)return;
  if(!d.insItems)d.insItems=[];
  d.insItems.push({l:'',v:0});sv();rLab();toast('í•­ëª© ì¶”ê°€')
}
function delInsItem(i){
  var d=D[Y]?.[M];if(!d||!d.insItems)return;
  d.insItems.splice(i,1);syncInsObj(d);recalcAll(d);sv();rM();rLab()
}
function updInsItem(i,f,v){
  var d=D[Y]?.[M];if(!d||!d.insItems)return;
  if(f==='v')d.insItems[i].v=parseInt(String(v).replace(/[^0-9]/g,''))||0;
  else d.insItems[i].l=v;
  syncInsObj(d);recalcAll(d);sv();rM();rLab()
}
function syncInsObj(d){
  var items=d.insItems||[];
  d.insurance={health:0,employ:0,injury:0};
  items.forEach(function(it){
    if(it.l.includes('ê±´ê°•'))d.insurance.health=it.v;
    else if(it.l.includes('ê³ ìš©'))d.insurance.employ=it.v;
    else if(it.l.includes('ì‚°ì¬'))d.insurance.injury=it.v;
  });
  d.totalInsurance=items.reduce(function(a,it){return a+(it.v||0)},0);
}

// ì•ˆì „í•œ JSON ì¶”ì¶œ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡, í›„í–‰ í…ìŠ¤íŠ¸ ì œê±°)
function extractJSON(txt){
  if(!txt)return null;
  // ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡ ì œê±°
  var clean=txt.replace(/```json\s*/gi,'').replace(/```\s*/g,'');
  // ì¤‘ê´„í˜¸ ë§¤ì¹­ìœ¼ë¡œ JSON ì¶”ì¶œ (ì¤‘ì²© ì§€ì›)
  var start=clean.indexOf('{');
  if(start===-1)return null;
  var depth=0,end=-1;
  for(var i=start;i<clean.length;i++){
    if(clean[i]==='{')depth++;
    else if(clean[i]==='}'){depth--;if(depth===0){end=i;break}}
  }
  if(end===-1)return null;
  try{return JSON.parse(clean.substring(start,end+1))}
  catch(e){
    // 2ì°¨ ì‹œë„: ì œì–´ë¬¸ì ì œê±°
    var s2=clean.substring(start,end+1).replace(/[\x00-\x1f\x7f]/g,' ');
    try{return JSON.parse(s2)}catch(e2){console.warn('[extractJSON] parse fail:',e2.message);return null}
  }
}

// ì„¸ê¸ˆ í•­ëª©
function addTaxItem(){
  var d=D[Y]?.[M];if(!d)return;
  if(!d.taxItems2)d.taxItems2=[];
  d.taxItems2.push({l:'',v:0});sv();rLab();toast('í•­ëª© ì¶”ê°€')
}
function delTaxItem(i){
  var d=D[Y]?.[M];if(!d||!d.taxItems2)return;
  d.taxItems2.splice(i,1);syncTaxObj(d);recalcAll(d);sv();rM();rLab()
}
function updTaxItem(i,f,v){
  var d=D[Y]?.[M];if(!d||!d.taxItems2)return;
  if(f==='v')d.taxItems2[i].v=parseInt(String(v).replace(/[^0-9]/g,''))||0;
  else d.taxItems2[i].l=v;
  syncTaxObj(d);recalcAll(d);sv();rM();rLab()
}
function syncTaxObj(d){
  var items=d.taxItems2||[];
  d.tax={i1:0,i2:0,loc:0};
  items.forEach(function(it){
    if(it.l.includes('ì›ì²œ')||it.l==='ì†Œë“ì„¸2')d.tax.i2=it.v;
    else if(it.l.includes('ì§€ë°©'))d.tax.loc=it.v;
    else if(it.l.includes('ì†Œë“'))d.tax.i1=it.v;
  });
  d.totalTax=items.reduce(function(a,it){return a+(it.v||0)},0);
  d.taxItems=JSON.parse(JSON.stringify(items));
}

function recalcAll(d){
  d.totalSalary=(d.staff||[]).reduce(function(a,s){return a+(s.salary||0)},0);
  var totalNet=(d.staff||[]).reduce(function(a,s){return a+(s.net||0)},0);
  var tI=(d.insItems||[]).reduce(function(a,it){return a+(it.v||0)},0);
  var tT=(d.taxItems2||[]).reduce(function(a,it){return a+(it.v||0)},0);
  d.totalInsurance=tI;d.totalTax=tT;
  d.totalNet=totalNet;
  d.laborCost=totalNet+tI+tT;
  // ì‹ì¬ë£Œ í•©ê³„ë„ foodItemsì—ì„œ ë™ì  ê³„ì‚°
  if(d.foodItems)d.foodCost=d.foodItems.reduce(function(a,it){return a+(parseInt(it.v)||0)},0);
}

// ì„¹ì…˜ë³„ OCR (ë‹¤ì¤‘íŒŒì¼ ì§€ì›)
var secOcrD={};
function hSecOCR(e,sec){
  var files=Array.from(e.target.files||[]);
  if(files.length>0)universalOCR(files,sec);
  e.target.value='';
}
// â•â•â• í†µí•© OCR: ì–´ë–¤ ë²„íŠ¼ì—ì„œë“  Nê°œ íŒŒì¼ â†’ ìë™ë¶„ë¥˜ â†’ ìë™ì ìš© â•â•â•
async function universalOCR(files,originSec){
  // í‘œì‹œí•  ì˜ì—­ ê²°ì •
  var secId=originSec||'tax';
  var resEl=$('#'+secId+'Res');
  var bodyEl=$('#'+secId+'Body');
  if(resEl)resEl.classList.add('show');
  if(bodyEl)bodyEl.innerHTML='<div style="color:var(--text3)">ğŸ”„ '+files.length+'ê°œ íŒŒì¼ ìŠ¤ìº” ì¤‘...</div>';
  // íŒŒì¼ë³„ smartProcessFile â†’ ê²°ê³¼ ìˆ˜ì§‘
  var results=[];
  for(var i=0;i<files.length;i++){
    try{
      if(bodyEl)bodyEl.innerHTML='<div style="color:var(--text3)">ğŸ”„ '+(i+1)+'/'+files.length+' ìŠ¤ìº”: '+files[i].name+'</div>';
      var parsed=await smartProcessFile(files[i]);
      if(parsed){
        results.push({file:files[i].name,data:parsed});
        console.log('[UNIVERSAL] '+files[i].name+' â†’ '+(parsed.docType||'unknown'));
      }
    }catch(err){console.warn('[OCR] '+files[i].name+' error:',err.message)}
  }
  if(results.length===0){if(bodyEl)bodyEl.innerHTML='<div style="color:var(--red)">ì¸ì‹ ì‹¤íŒ¨ - ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”</div>';return}
  // docTypeë³„ ìë™ ì ìš©
  if(!D[Y])D[Y]={};if(!D[Y][M])D[Y][M]=initM?initM():{};
  var d=D[Y][M];
  var appliedTypes=[];
  // upsert í—¬í¼: ê¸°ì¡´ ë°°ì—´ì— í•­ëª© ì¶”ê°€/ì—…ë°ì´íŠ¸ (ê°™ì€ ë¼ë²¨ì´ë©´ ê°’ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€)
  function upsertItem(arr,label,val){
    var found=false;
    for(var k=0;k<arr.length;k++){if(arr[k].l===label){arr[k].v=val;found=true;break}}
    if(!found)arr.push({l:label,v:val});
    return arr;
  }
  // upsert í—¬í¼: ì§ì› (ê°™ì€ ì´ë¦„ì´ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€)
  function upsertStaff(arr,newS){
    var found=false;
    for(var k=0;k<arr.length;k++){if(arr[k].name===newS.name){arr[k]=newS;found=true;break}}
    if(!found)arr.push(newS);
    return arr;
  }

  results.forEach(function(r){
    var dt=r.data.docType;
    if(dt==='income_tax'){
      // ê¸°ì¡´ ì„¸ê¸ˆ í•­ëª©ì— ì¶”ê°€ (upsert)
      var existing=d.taxItems2||d.taxItems||[];
      (r.data.items||[]).forEach(function(it){
        upsertItem(existing,it.label||'ì†Œë“ì„¸',parseInt(it.amount)||0);
      });
      if(r.data.localTax){
        upsertItem(existing,r.data.localTax.label||'ì§€ë°©ì†Œë“ì„¸',parseInt(r.data.localTax.amount)||0);
      }
      d.taxItems2=existing;d.taxItems=JSON.parse(JSON.stringify(existing));syncTaxObj(d);
      appliedTypes.push('ì†Œë“ì„¸');
    }else if(dt==='local_tax'){
      // ê¸°ì¡´ ì„¸ê¸ˆ í•­ëª©ì— ì§€ë°©ì„¸ ì¶”ê°€ (upsert)
      var existing=d.taxItems2||d.taxItems||[];
      upsertItem(existing,r.data.label||'ì§€ë°©ì†Œë“ì„¸(íŠ¹ë³„ì§•ìˆ˜)',parseInt(r.data.amount)||0);
      d.taxItems2=existing;d.taxItems=JSON.parse(JSON.stringify(existing));syncTaxObj(d);
      appliedTypes.push('ì§€ë°©ì„¸');
    }else if(dt==='payroll'||dt==='freelance'){
      // ê¸‰ì—¬ëŒ€ì¥ â†’ ì§ì›+ë³´í—˜+ì„¸ê¸ˆ APPEND (upsert)
      var rd=r.data;
      if(rd.staff){
        if(!d.staff)d.staff=[];
        rd.staff.forEach(function(ns){upsertStaff(d.staff,ns)});
        d.totalSalary=d.staff.reduce(function(a,s){return a+(s.salary||0)},0);
      }
      if(rd.insurance){
        if(!d.insItems)d.insItems=[];
        upsertItem(d.insItems,'ê±´ê°•ë³´í—˜',rd.insurance.health||0);
        upsertItem(d.insItems,'ê³ ìš©ë³´í—˜',rd.insurance.employ||0);
        upsertItem(d.insItems,'ì‚°ì¬ë³´í—˜',rd.insurance.injury||0);
        d.insurance=rd.insurance;d.totalInsurance=rd.insurance.total||0;syncInsObj(d);
      }
      if(rd.tax){
        if(!d.taxItems)d.taxItems=[];
        if(rd.tax.i1)upsertItem(d.taxItems,'ì†Œë“ì„¸',rd.tax.i1);
        if(rd.tax.loc)upsertItem(d.taxItems,'ì§€ë°©ì„¸',rd.tax.loc);
        if(rd.tax.i2)upsertItem(d.taxItems,'ê¸°íƒ€ì†Œë“ì„¸',rd.tax.i2);
        d.taxItems2=JSON.parse(JSON.stringify(d.taxItems));
        d.tax={i1:rd.tax.i1||0,i2:rd.tax.i2||0,loc:rd.tax.loc||0};
        d.totalTax=(rd.tax.i1||0)+(rd.tax.i2||0)+(rd.tax.loc||0);syncTaxObj(d);
      }
      if(rd.laborTotal)d.laborCost=rd.laborTotal;
      appliedTypes.push(dt==='freelance'?'ê¸°íƒ€ì†Œë“':'ê¸‰ì—¬ëŒ€ì¥');
    }else if(dt==='insurance'){
      // ë³´í—˜ í•­ëª© ì¶”ê°€ (upsert)
      if(!d.insItems)d.insItems=[];
      if(r.data.items){r.data.items.forEach(function(it){
        upsertItem(d.insItems,it.l||it.label,parseInt(it.v||it.amount)||0);
      });syncInsObj(d)}
      appliedTypes.push('4ëŒ€ë³´í—˜');
    }
  });
  // í™”ë©´ ê°±ì‹  (ì–´ë–¤ ë·°ì—ì„œë“ )
  recalcAll(d);sv();rM();
  try{rLab()}catch(e){}
  try{rInp()}catch(e){}
  // ê²°ê³¼ í‘œì‹œ â€” rLab/rInpì´ DOM ì¬ìƒì„±í•˜ë¯€ë¡œ ìš”ì†Œ ë‹¤ì‹œ íšë“
  resEl=$('#'+secId+'Res');bodyEl=$('#'+secId+'Body');
  if(resEl)resEl.classList.add('show');
  var oh='';
  results.forEach(function(r){oh+='<div style="margin-bottom:4px;font-size:10px;color:var(--text3)">ğŸ“ '+r.file+'</div>'+renderSmartResult(r.data)});
  if(bodyEl)bodyEl.innerHTML=oh;
  var typeStr=appliedTypes.length>0?(' ('+appliedTypes.join('+')+')'):'';
  toast('âœ… '+results.length+'ê°œ íŒŒì¼ ìë™ë¶„ë¥˜'+typeStr);
}
// ë ˆê±°ì‹œ í˜¸í™˜
async function hSecOCRFiles(files,sec){return universalOCR(files,sec)}
// PDF í…ìŠ¤íŠ¸ ì§ì ‘ ì¶”ì¶œ (ëª¨ë“  í˜ì´ì§€)
async function extractPDFText(file){
  if(!window.pdfjsLib)return '';
  var isPDF=file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  if(!isPDF)return '';
  try{
    var buf=await file.arrayBuffer();
    var pdf=await pdfjsLib.getDocument({data:buf,cMapUrl:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',cMapPacked:true}).promise;
    var allText='';
    for(var i=1;i<=pdf.numPages;i++){
      var pg=await pdf.getPage(i);
      var tc=await pg.getTextContent();
      var pageText=tc.items.map(function(it){return it.str}).join(' ');
      allText+='[PAGE '+i+'] '+pageText+'\n';
    }
    console.log('[PDF Text] '+file.name+': '+allText.substring(0,300));
    return allText;
  }catch(e){console.warn('[PDF Text] extract fail:',e.message);return ''}
}

// PDF í…ìŠ¤íŠ¸ ì •ê·œí™” (ê¸€ì ì‚¬ì´ ê³µë°± ì œê±° â€” êµ­ì„¸ì²­ PDF ì–‘ì‹ ëŒ€ì‘)
function normalizePDFText(text){
  if(!text)return '';
  var t=text;
  // 1) í•œê¸€ ê¸€ì ì‚¬ì´ ë‹¨ì¼/ë‹¤ì¤‘ ê³µë°± ì œê±°: "ê·¼ ë¡œ ì†Œ ë“ ì„¸" â†’ "ê·¼ë¡œì†Œë“ì„¸"
  var prev='';while(prev!==t){prev=t;t=t.replace(/([\uAC00-\uD7AF])\s+([\uAC00-\uD7AF])/g,'$1$2')}
  // 2) ìˆ«ì ì‚¬ì´ ê³µë°± ì œê±°: "3   9   ,   6   9   0" â†’ "39,690"
  prev='';while(prev!==t){prev=t;t=t.replace(/(\d)\s+(\d)/g,'$1$2')}
  // 3) ìˆ«ì-ì½¤ë§ˆ ê³µë°±: "39 , 690" â†’ "39,690"
  t=t.replace(/(\d)\s*,\s*(\d)/g,'$1,$2');
  // 4) ê´„í˜¸ ì•ˆ ê³µë°±: "( ê°‘ )" â†’ "(ê°‘)"
  t=t.replace(/\(\s+/g,'(').replace(/\s+\)/g,')');
  // 5) í•œê¸€-ê´„í˜¸ ì‚¬ì´ ê³µë°±: "ì†Œë“ì„¸ (ê°‘)" â†’ "ì†Œë“ì„¸(ê°‘)"
  t=t.replace(/([\uAC00-\uD7AF])\s+\(/g,'$1(');
  // 6) ìŠ¬ë˜ì‹œ ê³µë°±: "êµìœ¡ / ë°©ìœ„ì„¸" â†’ "êµìœ¡/ë°©ìœ„ì„¸"
  t=t.replace(/\s*\/\s*/g,'/');
  // 7) ì—°ì† ê³µë°± â†’ ë‹¨ì¼ ê³µë°±
  t=t.replace(/\s{2,}/g,' ');
  return t;
}
// ë‚©ë¶€ì„œ í…ìŠ¤íŠ¸ì—ì„œ ì„¸ê¸ˆ í•­ëª© ì§ì ‘ íŒŒì‹± (API ë¶ˆí•„ìš”, 100% ì •í™•)
function parseTaxFromText(text){
  if(!text)return null;
  // PDF í…ìŠ¤íŠ¸ ì •ê·œí™” (ê¸€ì ì‚¬ì´ ê³µë°± ì œê±°)
  var norm=normalizePDFText(text);
  console.log('[Tax Parse] Normalized:',norm.substring(0,300));
  var items=[];
  // ì„¸ëª©ë³„ ë‚©ë¶€ê¸ˆì•¡ íŒ¨í„´ (êµ­ì„¸ì²­ ë‚©ë¶€ì„œ ì–‘ì‹)
  var taxPatterns=[
    {re:/ê·¼ë¡œì†Œë“ì„¸\s*\(?\s*ê°‘?\s*\)?\s*[\s:]*?([\d,]+)/g, l:'ê·¼ë¡œì†Œë“ì„¸(ê°‘)'},
    {re:/ì‚¬ì—…ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ì‚¬ì—…ì†Œë“ì„¸'},
    {re:/ê¸°íƒ€ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ê¸°íƒ€ì†Œë“ì„¸'},
    {re:/ì´ìì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ì´ìì†Œë“ì„¸'},
    {re:/ë°°ë‹¹ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ë°°ë‹¹ì†Œë“ì„¸'},
    {re:/í‡´ì§ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'í‡´ì§ì†Œë“ì„¸'},
    {re:/ì–‘ë„ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ì–‘ë„ì†Œë“ì„¸'},
    {re:/ì§€ë°©ì†Œë“ì„¸\s*\(?\s*íŠ¹ë³„\s*ì§•ìˆ˜\s*\)?\s*[\s:]*?([\d,]+)/g, l:'ì§€ë°©ì†Œë“ì„¸(íŠ¹ë³„ì§•ìˆ˜)'},
    {re:/ì§€ë°©ì†Œë“ì„¸\s*[\s:]*?([\d,]+)/g, l:'ì§€ë°©ì†Œë“ì„¸'}
  ];
  // ì „ì²´ í…ìŠ¤íŠ¸ íŒŒì‹± (PAGE êµ¬ë¶„ ì—†ì´ â€” PDF.js ì¶”ì¶œ í…ìŠ¤íŠ¸ í˜¸í™˜)
  taxPatterns.forEach(function(p){
    var m;p.re.lastIndex=0;
    while((m=p.re.exec(norm))!==null){
      var v=parseInt(m[1].replace(/,/g,''));
      if(v>0){
        var exists=items.find(function(it){return it.l===p.l&&it.v===v});
        if(!exists)items.push({l:p.l,v:v});
      }
    }
  });
  // ë‚©ë¶€ê¸ˆì•¡/ë‚©ë¶€í• ì„¸ì•¡ íŒ¨í„´ (ì§€ë°©ì„¸ ë‚©ë¶€ì„œìš© â€” ì„¸ëª©ëª… ì—†ì´ ê¸ˆì•¡ë§Œ)
  if(items.length===0){
    var amtMatch=norm.match(/ë‚©ë¶€\s*(?:í• \s*)?(?:ì„¸ì•¡|ê¸ˆì•¡)\s*[\s:]*?([\d,]+)/);
    if(amtMatch){
      var v=parseInt(amtMatch[1].replace(/,/g,''));
      if(v>0){
        var isLocal=norm.includes('ì§€ë°©');
        items.push({l:isLocal?'ì§€ë°©ì†Œë“ì„¸(íŠ¹ë³„ì§•ìˆ˜)':'ì†Œë“ì„¸',v:v});
      }
    }
  }
  if(items.length>0){
    console.log('[Tax Parse] Found:',JSON.stringify(items));
    return {items:items};
  }
  return null;
}

// ë‹¨ì¼ íŒŒì¼ OCR (ê²°ê³¼ë§Œ ë°˜í™˜, UI ë¯¸ì œì–´)
async function hSecOCRSingle(file,sec){
  var gk=localStorage.getItem(GK),ak=localStorage.getItem(AK);
  // ì„¸ê¸ˆ ë‚©ë¶€ì„œ: PDF í…ìŠ¤íŠ¸ ì§ì ‘ ì¶”ì¶œ ìš°ì„  (ë¬´ë£Œ+ì •í™•)
  if(sec==='tax'){
    var pdfText=await extractPDFText(file);
    if(pdfText){
      var parsed=parseTaxFromText(pdfText);
      if(parsed&&parsed.items.length>0){
        console.log('[OCR] '+file.name+' â†’ PDFí…ìŠ¤íŠ¸ ì§ì ‘ íŒŒì‹± ì„±ê³µ!',JSON.stringify(parsed));
        return parsed;
      }
    }
  }
  // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ â†’ ì´ë¯¸ì§€ OCR (Gemini/Claude)
  if(!gk&&!ak){showApi();throw new Error('API í‚¤ ì—†ìŒ')}
  var prompts={
    ins:'4ëŒ€ë³´í—˜ ê³ ì§€ì„œ ë¶„ì„. JSONë§Œ: {"items":[{"l":"í•­ëª©ëª…","v":ê¸ˆì•¡}]}\nê±´ê°•ë³´í—˜,ê³ ìš©ë³´í—˜,ì‚°ì¬ë³´í—˜ ë°˜ë“œì‹œ ì¸ì‹. ìˆ«ìëŠ” ì½¤ë§ˆì—†ëŠ” ì •ìˆ˜. ê¸ˆì•¡ì´ 0ì¸ í•­ëª©ì€ ì œì™¸.',
    tax:'êµ­ì„¸/ì§€ë°©ì„¸ ë‚©ë¶€ì„œ ë¶„ì„. JSONë§Œ ë°˜í™˜: {"items":[{"l":"ì„¸ê¸ˆëª…ì¹­","v":ë‚©ë¶€ê¸ˆì•¡}]}\në‚©ë¶€ê¸ˆì•¡>0ì¸ ì„¸ëª©ë§Œ. ê°€ì‚°ê¸ˆ/ë†ì–´ì´ŒíŠ¹ë³„ì„¸/êµìœ¡ì„¸ 0ì›ì€ ì œì™¸. ìˆ«ìëŠ” ì½¤ë§ˆì—†ëŠ” ì •ìˆ˜.',
    acct:'ê¸‰ì—¬ëª…ì„¸ì„œ/ê³„ì¢Œì •ë³´ ë¶„ì„. JSONë§Œ: {"accounts":[{"name":"ì´ë¦„","bank":"ì€í–‰ëª…","acct":"ê³„ì¢Œë²ˆí˜¸"}]}'
  };
  var fd=await fileToBase64All(file);var txt='';
  if(gk){try{txt=await geminiOCR(fd.b64,fd.mt,prompts[sec])}catch(ge){console.warn('[OCR] Gemini:',ge.message)}}
  if(!txt&&ak){
    // Claude: PDFëŠ” document íƒ€ì…, ì´ë¯¸ì§€ëŠ” image íƒ€ì…
    var contentType=fd.mt==='application/pdf'?'document':'image';
    var r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':ak,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,messages:[{role:'user',content:[{type:contentType,source:{type:'base64',media_type:fd.mt,data:fd.b64}},{type:'text',text:prompts[sec]}]}]})});
    if(!r.ok){var err=await r.json();throw new Error(err.error?.message||'API ì˜¤ë¥˜ '+r.status)}
    var data=await r.json();txt=data.content?.[0]?.text||'';
  }
  console.log('[OCR] Raw response for',file.name,':',txt.substring(0,200));
  return extractJSON(txt);
}
// ë ˆê±°ì‹œ í˜¸í™˜ (ë‹¨ì¼íŒŒì¼)
async function hSecOCRFile(file,sec){return hSecOCRFiles([file],sec)}
function apSecOCR(sec){
  var od=secOcrD[sec];if(!od)return;
  var d=D[Y]?.[M];if(!d)return;
  if(sec==='ins'&&od.items){d.insItems=od.items;syncInsObj(d)}
  else if(sec==='tax'&&od.items){
    // ê¸°ì¡´ ì„¸ê¸ˆ í•­ëª©ê³¼ ë³‘í•© (ì†Œë“ì„¸â†’ì§€ë°©ì„¸ ìˆœì„œ ì—…ë¡œë“œ ì§€ì›)
    var existing=d.taxItems2||[];
    var newItems=od.items.filter(function(it){return it.v&&it.v>0});
    // ìƒˆ í•­ëª©ì´ ì†Œë“ì„¸ë¥˜ì¸ì§€ ì§€ë°©ì„¸ë¥˜ì¸ì§€ íŒë³„
    var hasLocal=newItems.some(function(it){return it.l.includes('ì§€ë°©')});
    var hasIncome=newItems.some(function(it){return!it.l.includes('ì§€ë°©')});
    if(hasIncome&&!hasLocal){
      // ì†Œë“ì„¸ë§Œ â†’ ê¸°ì¡´ ì§€ë°©ì„¸ ìœ ì§€
      var kept=existing.filter(function(t){return t.l.includes('ì§€ë°©')});
      newItems.forEach(function(it){kept.unshift(it)});
      d.taxItems2=kept;
    }else if(hasLocal&&!hasIncome){
      // ì§€ë°©ì„¸ë§Œ â†’ ê¸°ì¡´ ì†Œë“ì„¸ ìœ ì§€
      var kept=existing.filter(function(t){return!t.l.includes('ì§€ë°©')});
      kept.push.apply(kept,newItems);
      d.taxItems2=kept;
    }else{
      // ë‘˜ ë‹¤ ìˆìœ¼ë©´ ì „ì²´ êµì²´
      d.taxItems2=newItems;
    }
    d.taxItems=JSON.parse(JSON.stringify(d.taxItems2));syncTaxObj(d)
  }
  else if(sec==='acct'&&od.accounts){
    od.accounts.forEach(function(a){if(a.name)BNK[a.name]={bank:a.bank||'',acct:a.acct||''}});svB()
  }
  recalcAll(d);sv();rM();rLab();toast('âœ… ì ìš©')
}

// â•â•â• í†µí•© ìŠ¤ë§ˆíŠ¸ OCR ì‹œìŠ¤í…œ â•â•â•
var labD=null;

// í•µì‹¬: íŒŒì¼ 1ê°œë¥¼ ìŠ¤ë§ˆíŠ¸ ì²˜ë¦¬ (PDFí…ìŠ¤íŠ¸ìš°ì„  â†’ ì´ë¯¸ì§€OCR í´ë°±)
async function smartProcessFile(file){
  var fname=file.name||'file';
  console.log('[SMART] ì²˜ë¦¬ ì‹œì‘:',fname);
  // â‘  PDF í…ìŠ¤íŠ¸ ì§ì ‘ ì¶”ì¶œ ì‹œë„ (ë¬´ë£Œ, ë¹ ë¦„, ì •í™•)
  var pdfText=await extractPDFText(file);
  if(pdfText&&pdfText.trim().length>50){
    var norm=normalizePDFText(pdfText);
    // ì„¸ê¸ˆ ë‚©ë¶€ì„œì¸ì§€ í™•ì¸
    var taxResult=parseTaxFromText(pdfText);
    if(taxResult&&taxResult.items.length>0){
      // ì†Œë“ì„¸/ì§€ë°©ì„¸ ìë™ ë¶„ë¥˜
      var hasLocal=taxResult.items.some(function(it){return it.l.includes('ì§€ë°©')});
      var hasIncome=taxResult.items.some(function(it){return!it.l.includes('ì§€ë°©')});
      if(hasLocal&&!hasIncome){
        var it=taxResult.items[0];
        console.log('[SMART] '+fname+' â†’ ì§€ë°©ì„¸ (PDFí…ìŠ¤íŠ¸)',it.v);
        return {docType:'local_tax',amount:it.v,label:it.l};
      }else{
        var items=taxResult.items.filter(function(it){return!it.l.includes('ì§€ë°©')}).map(function(it){return{label:it.l,amount:it.v}});
        var localItems=taxResult.items.filter(function(it){return it.l.includes('ì§€ë°©')});
        var total=items.reduce(function(a,it){return a+it.amount},0);
        console.log('[SMART] '+fname+' â†’ ì†Œë“ì„¸ (PDFí…ìŠ¤íŠ¸)',items.length+'ê±´, í•©ê³„:',total);
        var result={docType:'income_tax',items:items,total:total};
        // ì§€ë°©ì„¸ë„ ê°™ì´ ìˆìœ¼ë©´ í¬í•¨
        if(localItems.length>0)result.localTax={label:localItems[0].l,amount:localItems[0].v};
        return result;
      }
    }
  }
  // â‘¡ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨/ë¹„ì„¸ê¸ˆ â†’ AI OCR (Gemini/Claude)
  var gk=localStorage.getItem(GK),ak=localStorage.getItem(AK);
  if(!gk&&!ak){showApi();throw new Error('API í‚¤ ì—†ìŒ')}
  // PDFëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ ë³´ëƒ„ (Gemini/Claude ëª¨ë‘ PDF ë„¤ì´í‹°ë¸Œ ì§€ì›, ì´ë¯¸ì§€ ë³€í™˜ë³´ë‹¤ ì •í™•)
  var isPDF=file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  var fd;
  if(isPDF){
    // PDF â†’ ì›ë³¸ base64 ì§ì ‘ (ì´ë¯¸ì§€ ë³€í™˜ ì—†ì´)
    var rawB64=await new Promise(function(res){var r=new FileReader();r.onload=function(ev){res(ev.target.result.split(',')[1])};r.readAsDataURL(file)});
    fd={b64:rawB64,mt:'application/pdf',preview:null};
    console.log('[SMART] '+fname+' â†’ ì›ë³¸ PDF base64 ì „ì†¡ ('+rawB64.length+' chars)');
  }else{
    fd=await fileToBase64(file);
  }
  var txt='';
  if(gk){try{txt=await geminiOCR(fd.b64,fd.mt,SMART_PROMPT)}catch(ge){console.warn('[OCR] Gemini:',ge.message)}}
  // Geminiê°€ unknown ë°˜í™˜ ì‹œ â†’ ë©€í‹°í˜ì´ì§€ ì´ë¯¸ì§€ë¡œ ì¬ì‹œë„
  if(txt){var j=extractJSON(txt);if(j&&j.docType&&j.docType!=='unknown'){console.log('[SMART] '+fname+' Gemini OK:',j.docType);return j}}
  // Gemini ì‹¤íŒ¨/unknown â†’ Claude API ì‹œë„
  if(ak){
    var contentType=fd.mt==='application/pdf'?'document':'image';
    var r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':ak,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:[{type:contentType,source:{type:'base64',media_type:fd.mt,data:fd.b64}},{type:'text',text:SMART_PROMPT}]}]})});
    if(r.ok){var data=await r.json();txt=data.content?.[0]?.text||''}
  }
  console.log('[SMART] '+fname+' OCRì‘ë‹µ:',txt.substring(0,200));
  return extractJSON(txt);
}

// ì¸ê±´ë¹„ OCR ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ â†’ í†µí•© OCRë¡œ ì „ë‹¬
function hLabOCR(e){
  var files=Array.from(e.target.files||[]);
  if(files.length>0)universalOCR(files,'lab');
  e.target.value='';
}
// ëª¨ë“  OCRì€ universalOCRë¡œ í†µí•©
async function hLabOCRAll(files){return universalOCR(files,'lab')}
async function hLabOCRFile(file){return universalOCR([file],'lab')}
async function hLabOCRMulti(files){return universalOCR(files,'lab')}
// ìŠ¤ë§ˆíŠ¸ OCR ê²°ê³¼ ë Œë”ë§
function renderSmartResult(d){
  var oh='<div style="margin-bottom:6px;font-size:11px;padding:4px 8px;background:var(--accent-bg);border-radius:6px;color:var(--accent);font-weight:700">ğŸ“‹ '+docTypeLabel(d.docType)+' ì¸ì‹</div>';
  if(d.docType==='payroll'||d.docType==='freelance'){
    oh+='<table class="ltbl" style="margin-top:4px"><thead><tr><th style="text-align:left">ì„±ëª…</th><th>êµ¬ë¶„</th><th>ê¸‰ì—¬</th><th>ê³µì œ</th><th style="color:var(--accent)">ì°¨ì¸ì§€ê¸‰ì•¡</th></tr></thead><tbody>';
    (d.staff||[]).forEach(function(s){oh+='<tr><td style="text-align:left">'+s.name+'</td><td style="text-align:center;font-size:11px">'+(s.type||'-')+'</td><td>'+fmt(s.salary)+'</td><td>'+fmt(s.ded)+'</td><td style="color:var(--accent);font-weight:700">'+fmt(s.net)+'</td></tr>'});
    oh+='</tbody></table>';
    if(d.insurance||d.tax){oh+='<div style="margin-top:6px;padding:6px 8px;background:rgba(13,138,106,0.04);border-radius:6px;font-size:11px;line-height:1.8">';
      if(d.insurance){if(d.insurance.health)oh+='ê±´ê°•ë³´í—˜ <b>'+fmt(d.insurance.health)+'</b> Â· ';if(d.insurance.employ)oh+='ê³ ìš©ë³´í—˜ <b>'+fmt(d.insurance.employ)+'</b> Â· ';if(d.insurance.injury)oh+='ì‚°ì¬ë³´í—˜ <b>'+fmt(d.insurance.injury)+'</b><br>'}
      if(d.tax){if(d.tax.i1)oh+='ì†Œë“ì„¸ <b>'+fmt(d.tax.i1)+'</b> Â· ';if(d.tax.loc)oh+='ì§€ë°©ì„¸ <b>'+fmt(d.tax.loc)+'</b>';if(d.tax.i2)oh+=' Â· ê¸°íƒ€ <b>'+fmt(d.tax.i2)+'</b>'}
      oh+='</div>'}
  }else if(d.docType==='income_tax'){
    oh+='<table class="itbl" style="margin-top:4px"><tbody>';
    (d.items||[]).forEach(function(it){oh+='<tr><td>'+it.label+'</td><td style="font-weight:700">'+fmt(it.amount)+'</td></tr>'});
    if(d.localTax)oh+='<tr><td>'+d.localTax.label+'</td><td style="font-weight:700">'+fmt(d.localTax.amount)+'</td></tr>';
    var displayTotal=d.total+(d.localTax?d.localTax.amount:0);
    oh+='<tr><td><b>í•©ê³„</b></td><td style="font-weight:700;color:var(--accent)">'+fmt(displayTotal)+'</td></tr></tbody></table>';
  }else if(d.docType==='local_tax'){
    oh+='<div style="margin-top:4px;font-size:13px">'+(d.label||'ì§€ë°©ì†Œë“ì„¸')+': <b style="color:var(--accent)">'+fmt(d.amount)+'</b></div>';
  }else if(d.docType==='insurance'){
    oh+='<table class="itbl" style="margin-top:4px"><tbody>';
    (d.items||[]).forEach(function(it){oh+='<tr><td>'+it.l+'</td><td style="font-weight:700">'+fmt(it.v)+'</td></tr>'});
    oh+='<tr><td><b>í•©ê³„</b></td><td style="font-weight:700;color:var(--accent)">'+fmt(d.total)+'</td></tr></tbody></table>';
  }
  return oh;
}
// ìŠ¤ë§ˆíŠ¸ ì ìš© (docType ê¸°ë°˜ ìë™ ë¼ìš°íŒ…)
function apLabOCR(){if(!labD)return;if(!D[Y])D[Y]={};if(!D[Y][M])D[Y][M]={};var d=D[Y][M];
  var dt=labD.docType||'';
  if(dt==='payroll'||dt==='freelance'||!dt){
    // ê¸‰ì—¬ëŒ€ì¥/ê¸°íƒ€ì†Œë“/ë ˆê±°ì‹œ â†’ ì§ì›+ë³´í—˜+ì„¸ê¸ˆ
    if(labD.staff){
      if(dt==='freelance'&&d.staff&&d.staff.length>0&&d.staff[0].type==='4ëŒ€ë³´í—˜'){d.staff=d.staff.concat(labD.staff)}
      else{d.staff=labD.staff}
      d.totalSalary=d.staff.reduce(function(a,s){return a+(s.salary||0)},0)}
    if(labD.insurance){d.insItems=[{l:'ê±´ê°•ë³´í—˜',v:labD.insurance.health||0},{l:'ê³ ìš©ë³´í—˜',v:labD.insurance.employ||0},{l:'ì‚°ì¬ë³´í—˜',v:labD.insurance.injury||0}];d.insurance=labD.insurance;d.totalInsurance=labD.insurance.total||0}
    if(labD.tax){var ti=[{l:'ì†Œë“ì„¸',v:labD.tax.i1||0},{l:'ì§€ë°©ì„¸',v:labD.tax.loc||0}];if(labD.tax.i2)ti.push({l:'ê¸°íƒ€ì†Œë“ì„¸',v:labD.tax.i2});d.taxItems2=ti;d.taxItems=JSON.parse(JSON.stringify(ti));d.tax={i1:labD.tax.i1||0,i2:labD.tax.i2||0,loc:labD.tax.loc||0};d.totalTax=labD.tax.total||0}
    if(labD.laborTotal)d.laborCost=labD.laborTotal;
  }else if(dt==='income_tax'){
    // ì†Œë“ì„¸ ë‚©ë¶€ì„œ â†’ ì„¸ê¸ˆ í•­ëª©ì— ì¶”ê°€ (ì§€ë°©ì„¸ ê¸°ì¡´ ìœ ì§€)
    var existing=d.taxItems2||d.taxItems||[];
    var kept=existing.filter(function(t){return t.l.includes('ì§€ë°©')});
    (labD.items||[]).forEach(function(it){kept.unshift({l:it.label||'ì†Œë“ì„¸',v:parseInt(it.amount)||0})});
    // ì†Œë“ì„¸ ë‚©ë¶€ì„œì— ì§€ë°©ì„¸ë„ í¬í•¨ëœ ê²½ìš° (ì˜ˆ: parseTaxFromTextë¡œ ë‘˜ ë‹¤ ì¶”ì¶œ)
    if(labD.localTax){
      kept=kept.filter(function(t){return!t.l.includes('ì§€ë°©')});
      kept.push({l:labD.localTax.label||'ì§€ë°©ì†Œë“ì„¸',v:parseInt(labD.localTax.amount)||0});
      // ë‹¤ì‹œ ì†Œë“ì„¸ í•­ëª© ì•ì— ì¶”ê°€
      var incomeItems=(labD.items||[]).map(function(it){return{l:it.label||'ì†Œë“ì„¸',v:parseInt(it.amount)||0}});
      kept=incomeItems.concat(kept);
    }
    d.taxItems2=kept;d.taxItems=JSON.parse(JSON.stringify(kept));syncTaxObj(d);
  }else if(dt==='local_tax'){
    // ì§€ë°©ì„¸ ë‚©ë¶€ì„œ â†’ ì§€ë°©ì„¸ í•­ëª©ì— ì¶”ê°€
    var existing=d.taxItems2||d.taxItems||[];
    var nonLocal=existing.filter(function(t){return!t.l.includes('ì§€ë°©')});
    nonLocal.push({l:labD.label||'ì§€ë°©ì†Œë“ì„¸',v:labD.amount||0});
    d.taxItems2=nonLocal;d.taxItems=JSON.parse(JSON.stringify(nonLocal));syncTaxObj(d);
  }else if(dt==='insurance'){
    if(labD.items){d.insItems=labD.items;syncInsObj(d)}
  }
  recalcAll(d);sv();rM();rLab();toast('âœ… '+docTypeLabel(dt)+' ì ìš©')
}

// ì„¸ê¸ˆ ë³µì‚¬/ì¹´í†¡/ì—‘ì…€
function cpTax(){
  var d=(D[Y]||{})[M];if(!d)return;var items=d.taxItems2||[];
  var tot=items.reduce(function(a,it){return a+(it.v||0)},0);
  var t='â” '+Y+'ë…„ '+M+'ì›” ì„¸ê¸ˆ ë‚©ë¶€ â”\n';
  items.forEach(function(it){t+=it.l+': '+(it.v||0).toLocaleString()+'ì›\n'});
  t+='â”â”â”â”â”â”â”â”â”â”â”\ní•©ê³„: '+tot.toLocaleString()+'ì›';
  navigator.clipboard.writeText(t);toast('ğŸ“‹ ì„¸ê¸ˆ ë³µì‚¬ ì™„ë£Œ')
}
function showKakTax(){
  var d=(D[Y]||{})[M];if(!d)return;var items=d.taxItems2||[];
  var tot=items.reduce(function(a,it){return a+(it.v||0)},0);
  var t='â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  '+Y+'ë…„ '+M+'ì›” ì„¸ê¸ˆ ë‚©ë¶€ ë‚´ì—­\n  ì›ìœŒì•¤ì½” Â· ì‹ ì´Œì \nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
  items.forEach(function(it,i){t+=(i+1)+'. '+it.l+'\n   ë‚©ë¶€ê¸ˆì•¡: '+(it.v||0).toLocaleString()+'ì›\n\n'});
  t+='â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì´ ë‚©ë¶€ì•¡: '+tot.toLocaleString()+'ì›\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';
  $('#kakTx').value=t;$('#kakMo').classList.add('show')
}
function expTax(){
  var d=(D[Y]||{})[M];if(!d)return;var items=d.taxItems2||[];
  var tot=items.reduce(function(a,it){return a+(it.v||0)},0);
  var rows=[['ëª©ë¡','ë‚©ë¶€ê¸ˆì•¡']];
  items.forEach(function(it){rows.push([it.l,it.v||0])});
  rows.push(['í•©ê³„',tot]);
  var ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'ì„¸ê¸ˆ');XLSX.writeFile(wb,'ì„¸ê¸ˆ_'+Y+'ë…„'+M+'ì›”.xlsx');toast('ğŸ“Š ì €ì¥')
}

function updB(n,f,v){if(!BNK[n])BNK[n]={bank:'',acct:''};BNK[n][f]=v;svB()}
function cpAcct(){
  var d=(D[Y]||{})[M];if(!d)return;
  var lines=(d.staff||[]).map(function(s){var b=BNK[s.name]||{};return s.name+' | '+(b.bank||'-')+' | '+(b.acct||'-')+' | '+(s.net||0).toLocaleString()+'ì›'});
  navigator.clipboard.writeText(lines.join('\n'));toast('ğŸ“‹ ë³µì‚¬ ì™„ë£Œ')
}
function showKak(){
  var d=(D[Y]||{})[M];if(!d)return;var st=d.staff||[];
  var t='â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  '+Y+'ë…„ '+M+'ì›” ê¸‰ì—¬ ì†¡ê¸ˆ ë‚´ì—­\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
  st.forEach(function(s,i){var b=BNK[s.name]||{};t+=(i+1)+'. '+s.name+'\n   '+(b.bank||'-')+'  '+(b.acct||'-')+'\n   ì°¨ì¸ì§€ê¸‰ì•¡: '+(s.net||0).toLocaleString()+'ì›\n\n'});
  t+='â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nì´ ì§€ê¸‰ì•¡: '+st.reduce(function(a,s){return a+(s.net||0)},0).toLocaleString()+'ì›\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';
  $('#kakTx').value=t;$('#kakMo').classList.add('show')
}
function expAcct(){
  var d=(D[Y]||{})[M];if(!d)return;
  var rows=[['ì„±ëª…','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ì°¨ì¸ì§€ê¸‰ì•¡']];
  (d.staff||[]).forEach(function(s){var b=BNK[s.name]||{};rows.push([s.name,b.bank||'',b.acct||'',s.net])});
  var ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'ê¸‰ì—¬');XLSX.writeFile(wb,'ê¸‰ì—¬_'+Y+'ë…„'+M+'ì›”.xlsx');toast('ğŸ“Š ì €ì¥')
}
// â•â•â• TREND â•â•â•
function rTrd(){const yd=D[Y]||{},ms=[],ss=[];for(let m=1;m<=12;m++)if(yd[m]){ms.push(m);ss.push(comp(yd[m]))}
  if(!ms.length){$('#ct').innerHTML=`<div class="empty"><div class="ei">ğŸ“Š</div><p>ë°ì´í„° ì—†ìŒ</p></div>`;return}
  const tR=ss.reduce((a,s)=>a+s.r,0),tE=ss.reduce((a,s)=>a+s.e,0),tP=ss.reduce((a,s)=>a+s.p,0),aR=tR>0?tP/tR:0;
  let tr='';ms.forEach((m,i)=>{const s=ss[i],cur=m===M?' class="cur"':'';tr+=`<tr${cur}><td>${m}ì›”</td><td>${fmt(s.r)}</td><td>${fmt(s.f)}</td><td>${fmt(s.l)}</td><td>${fmt(s.rn)}</td><td>${fmt(s.h)}</td><td>${fmt(s.u+s.t)}</td><td>${fmt(s.e)}</td><td style="color:${s.p>=0?'var(--accent)':'var(--red)'};font-weight:700">${fmt(s.p)}</td><td style="color:${s.p>=0?'var(--accent)':'var(--red)'}">${pc(s.rt)}</td></tr>`});
  tr+=`<tr class="tot"><td>í•©ê³„</td><td>${fmt(tR)}</td><td>${fmt(ss.reduce((a,s)=>a+s.f,0))}</td><td>${fmt(ss.reduce((a,s)=>a+s.l,0))}</td><td>${fmt(ss.reduce((a,s)=>a+s.rn,0))}</td><td>${fmt(ss.reduce((a,s)=>a+s.h,0))}</td><td>${fmt(ss.reduce((a,s)=>a+s.u+s.t,0))}</td><td>${fmt(tE)}</td><td style="color:${tP>=0?'var(--accent)':'var(--red)'};font-weight:700">${fmt(tP)}</td><td style="color:${aR>=0?'var(--accent)':'var(--red)'}">${pc(aR)}</td></tr>`;
  $('#ct').innerHTML=`<div id="capA"><div class="tg"><div class="sc"><div class="sc-l">ì—°ê°„ ë§¤ì¶œ</div><div class="sc-v">${fmt(tR)}</div><div class="sc-s">${ms.length}ê°œì›”</div></div><div class="sc"><div class="sc-l">ì—°ê°„ ì§€ì¶œ</div><div class="sc-v" style="color:var(--red)">${fmt(tE)}</div></div><div class="sc"><div class="sc-l">ì—°ê°„ ìˆ˜ìµ</div><div class="sc-v" style="color:${tP>=0?'var(--accent)':'var(--red)'}">${fmt(tP)}</div></div><div class="sc"><div class="sc-l">í‰ê·  ìˆ˜ìµë¥ </div><div class="sc-v" style="color:${aR>=0?'var(--accent)':'var(--red)'}">${pc(aR)}</div></div></div>
    <div class="cb"><div class="cb-h"><div class="cb-t">ì›”ë³„ ë§¤ì¶œÂ·ì§€ì¶œÂ·ìˆ˜ìµ</div><div class="cleg"><div class="lg"><div class="ld" style="background:var(--accent)"></div>ë§¤ì¶œ</div><div class="lg"><div class="ld" style="background:var(--red)"></div>ì§€ì¶œ</div><div class="lg"><div class="ld" style="background:var(--purple)"></div>ìˆ˜ìµ</div></div></div><div class="cha"><canvas id="c1"></canvas></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px"><div class="cb"><div class="cb-t" style="margin-bottom:14px">ë¹„ìš© êµ¬ì¡°</div><div class="chs"><canvas id="c2"></canvas></div></div><div class="cb"><div class="cb-t" style="margin-bottom:14px">ìˆ˜ìµë¥  ì¶”ì´</div><div class="chs"><canvas id="c3"></canvas></div></div></div>
    <div class="stbl"><div class="stbl-t">${Y}ë…„ ì›”ë³„ ìƒì„¸</div><table><thead><tr><th style="text-align:left">ì›”</th><th>ë§¤ì¶œ</th><th>ì‹ì¬ë£Œ</th><th>ì¸ê±´ë¹„</th><th>ì„ëŒ€ë£Œ</th><th>í™ìˆœìš°</th><th>ê¸°íƒ€</th><th>ì´ì§€ì¶œ</th><th>ìˆ˜ìµ</th><th>ìˆ˜ìµë¥ </th></tr></thead><tbody>${tr}</tbody></table></div></div>`;
  const lb=ms.map(m=>m+'ì›”'),fo={family:"IBM Plex Mono"},go={color:'rgba(221,216,207,.7)',drawBorder:false};
  CH.m=new Chart($('#c1'),{type:'bar',data:{labels:lb,datasets:[{label:'ë§¤ì¶œ',data:ss.map(s=>s.r),backgroundColor:'rgba(13,138,106,.15)',borderColor:'rgba(13,138,106,.7)',borderWidth:1.5,borderRadius:6,barPercentage:.55},{label:'ì§€ì¶œ',data:ss.map(s=>s.e),backgroundColor:'rgba(209,69,91,.12)',borderColor:'rgba(209,69,91,.6)',borderWidth:1.5,borderRadius:6,barPercentage:.55},{label:'ìˆ˜ìµ',type:'line',data:ss.map(s=>s.p),borderColor:'#6b52ae',backgroundColor:'rgba(107,82,174,.06)',borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#6b52ae',pointBorderColor:'#fff',pointBorderWidth:2,fill:true,tension:.3}]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},plugins:{legend:{display:false},tooltip:{backgroundColor:'#1a2332',padding:12,cornerRadius:8,callbacks:{label:c=>c.dataset.label+': '+fmt(c.parsed.y)}}},scales:{x:{grid:{display:false},ticks:{font:{...fo,size:10},color:'#8e97a5'}},y:{grid:go,ticks:{font:{...fo,size:10},color:'#8e97a5',callback:v=>fS(v)},border:{display:false}}}}});
  const lt=ss[ss.length-1];
  CH.c=new Chart($('#c2'),{type:'doughnut',data:{labels:['ì‹ì¬ë£Œ','ì¸ê±´ë¹„','ì„ëŒ€ë£Œ','í™ìˆœìš°','ê¸°íƒ€'],datasets:[{data:[lt.f,lt.l,lt.rn,lt.h,lt.u+lt.t],backgroundColor:['#d1455b','#d48a2c','#6b52ae','#3674b8','#8e97a5'],borderColor:'#fff',borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'bottom',labels:{font:{...fo,size:10},color:'#5a6577',padding:10,usePointStyle:true}}}}});
  CH.r=new Chart($('#c3'),{type:'line',data:{labels:lb,datasets:[{data:ss.map(s=>s.rt*100),segment:{borderColor:c=>c.p1.parsed.y>=0?'#0d8a6a':'#d1455b'},backgroundColor:'rgba(13,138,106,.04)',borderWidth:2.5,pointRadius:6,pointBackgroundColor:ss.map(s=>s.rt>=0?'#0d8a6a':'#d1455b'),pointBorderColor:'#fff',pointBorderWidth:2,fill:true,tension:.3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.parsed.y.toFixed(2)+'%'}}},scales:{x:{grid:{display:false},ticks:{font:{...fo,size:10},color:'#8e97a5'}},y:{grid:go,ticks:{font:{...fo,size:10},color:'#8e97a5',callback:v=>v.toFixed(1)+'%'},border:{display:false}}}}});
}

// â•â•â• INPUT â•â•â•
function rInp(){const d=(D[Y]||{})[M]||{};const staff=d.staff||[{name:'',salary:0,type:'4ëŒ€ë³´í—˜',ded:0,net:0}];
  let sH='';staff.forEach((s,i)=>{sH+=`<div class="stf" data-i="${i}"><div class="stf-row">
    <input class="stf-i nm" value="${s.name||''}" data-f="sn-${i}" placeholder="ì´ë¦„">
    <span class="stf-lb">ê¸‰ì—¬</span><input class="stf-i sal" value="${s.salary||''}" data-f="ss-${i}" oninput="acI()">
    <span class="stf-lb">ê³µì œ</span><input class="stf-i ded" value="${s.ded||''}" data-f="sd-${i}" oninput="acI()">
    <span class="stf-lb">=</span><input class="stf-i res" value="${s.net||''}" data-f="sr-${i}" readonly>
    <select class="stf-sel" data-f="st-${i}"><option value="4ëŒ€ë³´í—˜" ${s.type==='4ëŒ€ë³´í—˜'?'selected':''}>4ëŒ€ë³´í—˜</option><option value="3.3%" ${s.type==='3.3%'?'selected':''}>3.3%</option><option value="ì¼ë‹¹" ${s.type==='ì¼ë‹¹'?'selected':''}>ì¼ë‹¹</option></select>
    <button class="xb" onclick="dStf(this)">âœ•</button>
  </div></div>`});

  const foodItems=d.foodItems||[{l:'ì—”í‘¸ë“œ',v:d.foodDetail?.entree||''},{l:'ìš°ì‚¼ê²¹&ì‹ìì¬',v:d.foodDetail?.side||''},{l:'ì‹ìš©ìœ ',v:d.foodDetail?.oil||''}];
  const etcItems=d.etcItems||[{l:'ê¸°ì¥ë£Œ',v:d.utilities||132000},{l:'í™ìˆœìš° ë¶„í• ì •ì‚°',v:d.hongPay||''}];
  const insItems=d.insItems||[{l:'ê±´ê°•ë³´í—˜',v:d.insurance?.health||''},{l:'ê³ ìš©ë³´í—˜',v:d.insurance?.employ||''},{l:'ì‚°ì¬ë³´í—˜',v:d.insurance?.injury||''}];
  const taxItems=d.taxItems||d.taxItems2||[{l:'ì†Œë“ì„¸1',v:d.tax?.i1||''},{l:'ì§€ë°©ì„¸',v:d.tax?.loc||''},{l:'ì†Œë“ì„¸2',v:d.tax?.i2||''}];

  function dynSec(id,icon,title,items){let h='';(items||[]).forEach((it,i)=>{h+=`<div class="fr dyn-r" data-sec="${id}" data-i="${i}"><input class="fl-i" value="${it.l||''}" data-f="${id}-l-${i}" placeholder="í•­ëª©ëª…"><div style="display:flex;align-items:center;gap:4px"><input class="fi" value="${it.v||''}" data-f="${id}-v-${i}" oninput="acI()"><button class="xb" onclick="dDyn('${id}',${i})">âœ•</button></div></div>`});
    return`<div class="fc"><div class="fc-t" style="justify-content:space-between"><span>${icon} ${title}</span><button class="btn-a" onclick="aDyn('${id}')">+ ì¶”ê°€</button></div><div id="dy-${id}">${h}</div><div class="fr" style="margin-top:8px;padding-top:8px;border-top:2px solid var(--border)"><span class="fl b">í•©ê³„ (ìë™)</span><input class="fi auto" data-f="${id}-tot" readonly></div></div>`}

  $('#ct').innerHTML=`<div class="inp-lay"><div>
    <div class="fc"><div class="fc-t">ğŸ’° ë§¤ì¶œ</div>
      <div class="fr"><span class="fl">ì´ ë§¤ì¶œ</span><input class="fi" data-f="revenue" value="${d.revenue||''}" oninput="acI()"></div>
      <div class="fr"><span class="fl">í˜„ëŒ€ìˆ˜ìˆ˜ë£Œ</span><input class="fi" data-f="commission" value="${d.commission||''}" oninput="acI()"></div>
      <div class="fr hl" style="margin-top:8px;padding:10px 12px;background:var(--accent-bg);border-radius:8px"><span class="fl b">ì§€ê¸‰ì•¡ (ìë™)</span><input class="fi auto" data-f="netRev" readonly></div></div>
    ${dynSec('food','ğŸ¥©','ì‹ì¬ë£Œ',foodItems)}
    <div class="fc"><div class="fc-t" style="justify-content:space-between"><span>ğŸ‘¥ ì¸ê±´ë¹„</span><button class="btn-a" onclick="aStf()">+ ì§ì› ì¶”ê°€</button></div>
      <div id="stfA">${sH}</div>
      <div class="fr" style="margin-top:12px;padding-top:8px;border-top:2px solid var(--border)"><span class="fl b">ê¸‰ì—¬í•©ê³„ (ìë™)</span><input class="fi auto" data-f="totSal" readonly></div></div>
    ${dynSec('ins','ğŸ¦','4ëŒ€ë³´í—˜',insItems)}
    ${dynSec('tax','ğŸ“‹','ì„¸ê¸ˆ',taxItems)}
    <div class="fc"><div class="fr"><span class="fl b" style="color:var(--accent)">ì¸ê±´ë¹„ í•©ê³„ (ê¸‰ì—¬+ë³´í—˜) (ìë™)</span><input class="fi auto" data-f="labTot" readonly></div></div>
    ${dynSec('etc','ğŸ¢','ê¸°íƒ€ ë¹„ìš©',etcItems)}
    <button class="btn-sv" onclick="savM()">ğŸ’¾ ${M}ì›” ì €ì¥</button>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="sb" style="flex:1" onclick="cpPrev()">ğŸ“‹ ì „ì›” ë³µì‚¬</button><button class="sb" style="flex:1;border-color:var(--red);color:var(--red)" onclick="delM()">ğŸ—‘ ì‚­ì œ</button></div>
  </div><div>
    <div class="ocr" id="ocrInv" onclick="document.getElementById('ocrF').click()"><div class="ocr-i">ğŸ“„</div><div class="ocr-tx"><b>ì„¸ê¸ˆê³„ì‚°ì„œ ì—…ë¡œë“œ</b><br>ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­<br>AIê°€ í•©ê³„ê¸ˆì•¡ ìë™ ì¸ì‹</div><input type="file" id="ocrF" accept="image/*,.pdf,application/pdf" style="display:none" onchange="hInvOCR(event)"></div>
    <img class="ocr-pv" id="invPv"><div class="ocr-rs" id="invRes"><div class="ocr-rl">ğŸ¤– ì¸ì‹ í•©ê³„ê¸ˆì•¡</div><div class="ocr-rv" id="invAmt">-</div><div class="ocr-rx" id="invSb"></div><button class="sb pri" style="margin-top:8px" onclick="apInv()">â†’ ì§€ê¸‰ì•¡ ì ìš©</button></div>

    <div class="ocr" id="ocrLab2" onclick="document.getElementById('ocrL2').click()" style="margin-top:8px"><div class="ocr-i">ğŸ‘¥</div><div class="ocr-tx"><b>ì¸ê±´ë¹„ ëª…ì„¸ì„œ ì—…ë¡œë“œ</b><br>ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­<br>AIê°€ ì§ì›ë³„ ê¸‰ì—¬ ìë™ ì¸ì‹</div><input type="file" id="ocrL2" accept="image/*,.pdf" multiple style="display:none" onchange="hLabOCR2(event)"></div>
    <div class="ocr-rs" id="lab2Res"><div class="ocr-rl">ğŸ¤– AI ìë™ë¶„ë¥˜</div><div id="lab2Body"></div></div>

    <div class="fc"><div class="fc-t">ğŸ“„ ì„¸ê¸ˆê³„ì‚°ì„œ</div><div class="fr"><span class="fl">ê³µê¸‰ê°€ì•¡</span><input class="fi" data-f="invAmt" value="${d.invoiceAmt||''}"></div></div>
  </div></div>`;

  // Drag & drop
  ['ocrInv','ocrLab2'].forEach(id=>{const el=$('#'+id);el.addEventListener('dragover',e=>{e.preventDefault();el.classList.add('drag')});el.addEventListener('dragleave',()=>el.classList.remove('drag'));
    el.addEventListener('drop',e=>{e.preventDefault();el.classList.remove('drag');
      var files=Array.from(e.dataTransfer.files||[]);
      if(id==='ocrInv'&&files[0])procInv(files[0]);
      else if(id==='ocrLab2'){
        if(files.length>1){hLabOCRMulti2(files)}
        else if(files[0])procLab2(files[0]);
      }
    })});
  acI();
}

function gv(f){const el=$(`[data-f="${f}"]`);return el?(parseInt(String(el.value).replace(/[^0-9-]/g,''))||0):0}
function sv2(f,v){const el=$(`[data-f="${f}"]`);if(el)el.value=v||''}
function dynTot(id){const rows=$$(`#dy-${id} .dyn-r`);let t=0;rows.forEach((_,i)=>{t+=parseInt(String($(`[data-f="${id}-v-${i}"]`)?.value||'0').replace(/[^0-9-]/g,''))||0});return t}
function getDynItems(id){const rows=$$(`#dy-${id} .dyn-r`);const items=[];rows.forEach((_,i)=>{const l=$(`[data-f="${id}-l-${i}"]`)?.value||'';const v=parseInt(String($(`[data-f="${id}-v-${i}"]`)?.value||'0').replace(/[^0-9-]/g,''))||0;items.push({l,v})});return items}

function acI(){
  sv2('netRev',gv('revenue')-gv('commission'));
  sv2('food-tot',dynTot('food'));
  let ts=0;$$('.stf').forEach((_,i)=>{
    const sal=gv(`ss-${i}`),ded=gv(`sd-${i}`);
    sv2(`sr-${i}`,sal-ded);
    ts+=sal;
  });
  sv2('totSal',ts);
  sv2('ins-tot',dynTot('ins'));
  sv2('tax-tot',dynTot('tax'));
  sv2('labTot',ts+dynTot('ins'));
  sv2('etc-tot',dynTot('etc'));
}

function aDyn(id){const c=$(`#dy-${id}`),i=c.children.length,d=document.createElement('div');d.className='fr dyn-r';d.dataset.sec=id;d.dataset.i=i;
  d.innerHTML=`<input class="fl-i" data-f="${id}-l-${i}" placeholder="í•­ëª©ëª…"><div style="display:flex;align-items:center;gap:4px"><input class="fi" data-f="${id}-v-${i}" oninput="acI()"><button class="xb" onclick="dDyn('${id}',${i})">âœ•</button></div>`;c.appendChild(d)}
function dDyn(id,i){const c=$(`#dy-${id}`),rows=c.querySelectorAll('.dyn-r');if(rows.length<=1)return;rows[i]?.remove();c.querySelectorAll('.dyn-r').forEach((r,j)=>{r.dataset.i=j;r.querySelectorAll('[data-f]').forEach(el=>{el.dataset.f=el.dataset.f.replace(new RegExp(id+'-(l|v)-\\d+'),id+'-$1-'+j)})});acI()}
function aStf(){const a=$('#stfA'),i=a.children.length,d=document.createElement('div');d.className='stf';d.dataset.i=i;
  d.innerHTML=`<div class="stf-row"><input class="stf-i nm" data-f="sn-${i}" placeholder="ì´ë¦„"><span class="stf-lb">ê¸‰ì—¬</span><input class="stf-i sal" data-f="ss-${i}" oninput="acI()"><span class="stf-lb">ê³µì œ</span><input class="stf-i ded" data-f="sd-${i}" oninput="acI()"><span class="stf-lb">=</span><input class="stf-i res" data-f="sr-${i}" readonly><select class="stf-sel" data-f="st-${i}"><option value="4ëŒ€ë³´í—˜">4ëŒ€ë³´í—˜</option><option value="3.3%">3.3%</option><option value="ì¼ë‹¹">ì¼ë‹¹</option></select><button class="xb" onclick="dStf(this)">âœ•</button></div>`;a.appendChild(d)}
function dStf(el){
  // elì´ ìˆ«ì(ì¸ë±ìŠ¤)ë©´ ê¸°ì¡´ ë°©ì‹, DOM ìš”ì†Œë©´ ìƒˆ ë°©ì‹
  var target;
  if(typeof el==='number'){target=$$('.stf')[el]}
  else{target=el.closest?el.closest('.stf'):null}
  if(!target)return;
  var bl=$$('.stf');if(bl.length<=1)return;
  target.remove();
  $$('.stf').forEach(function(b,j){b.dataset.i=j;b.querySelectorAll('[data-f]').forEach(function(e){e.dataset.f=e.dataset.f.replace(/-\d+$/,'-'+j)})});
  acI();
}

function savM(){if(!D[Y])D[Y]={};
  const staff=[];$$('.stf').forEach((_,i)=>{const sal=gv(`ss-${i}`),ded=gv(`sd-${i}`);staff.push({name:$(`[data-f="sn-${i}"]`)?.value||'',salary:sal,type:$(`[data-f="st-${i}"]`)?.value||'4ëŒ€ë³´í—˜',ded,net:sal-ded})});
  const foodItems=getDynItems('food'),insItems=getDynItems('ins'),taxItems=getDynItems('tax'),etcItems=getDynItems('etc');
  var fdObj={};foodItems.forEach(function(it){fdObj[it.l]=it.v||0});
  D[Y][M]={revenue:gv('revenue'),commission:gv('commission'),netRevenue:gv('revenue')-gv('commission'),
    foodCost:dynTot('food'),foodDetail:{entree:foodItems[0]?.v||0,side:foodItems[1]?.v||0,oil:foodItems[2]?.v||0},
    rent:etcItems.find(x=>x.l.includes('ì„ëŒ€'))?.v||gv('commission'),utilities:etcItems.find(x=>x.l.includes('ê¸°ì¥'))?.v||132000,hongPay:etcItems.find(x=>x.l.includes('í™ìˆœìš°'))?.v||0,
    staff,totalSalary:staff.reduce((a,s)=>a+s.salary,0),
    insurance:{health:insItems[0]?.v||0,employ:insItems[1]?.v||0,injury:insItems[2]?.v||0},totalInsurance:dynTot('ins'),
    tax:(function(){var tm={i1:0,i2:0,loc:0};taxItems.forEach(function(it){if(it.l.includes('ì›ì²œ')||it.l==='ì†Œë“ì„¸2')tm.i2=it.v||0;else if(it.l.includes('ì§€ë°©'))tm.loc=it.v||0;else if(it.l.includes('ì†Œë“'))tm.i1=it.v||0});return tm})(),totalTax:dynTot('tax'),
    invoiceAmt:gv('invAmt'),foodItems,insItems,taxItems2:JSON.parse(JSON.stringify(taxItems)),taxItems,etcItems};
  recalcAll(D[Y][M]);sv();rM();toast('âœ… '+M+'ì›” ì €ì¥')}
function delM(){if(!confirm(Y+'ë…„ '+M+'ì›” ì‚­ì œ?'))return;if(D[Y])delete D[Y][M];sv();rM();rInp();toast('ğŸ—‘ ì‚­ì œ')}
function cpPrev(){const p=M-1;if(p<1||!(D[Y]||{})[p]){toast('âš ï¸ ì „ì›” ì—†ìŒ');return}if(!D[Y])D[Y]={};D[Y][M]=JSON.parse(JSON.stringify(D[Y][p]));sv();rM();rInp();toast('ğŸ“‹ ë³µì‚¬')}

// â•â•â• INVOICE OCR â•â•â•
let invVal=0;
function hInvOCR(e){if(e.target.files[0])procInv(e.target.files[0]);e.target.value=''}

// PDF/ì´ë¯¸ì§€ â†’ base64 ë³€í™˜ ê³µí†µ í•¨ìˆ˜
async function fileToBase64(file){
  const isPDF=file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  if(isPDF){
    // PDF: canvas ë Œë”ë§ ì‹œë„ â†’ ì‹¤íŒ¨ ì‹œ PDF ì›ë³¸ ì§ì ‘ ì „ì†¡ (Gemini ë„¤ì´í‹°ë¸Œ PDF ì§€ì›)
    try{
      if(!window.pdfjsLib)throw new Error('PDF.js ë¯¸ë¡œë“œ');
      const buf=await file.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:buf,cMapUrl:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',cMapPacked:true}).promise;
      const pg=await pdf.getPage(1);
      const sc=2;const vp=pg.getViewport({scale:sc});
      const cv=document.createElement('canvas');cv.width=vp.width;cv.height=vp.height;
      const ctx=cv.getContext('2d');
      await Promise.race([
        pg.render({canvasContext:ctx,viewport:vp}).promise,
        new Promise(function(_,rj){setTimeout(function(){rj(new Error('PDF render timeout'))},10000)})
      ]);
      const dataUrl=cv.toDataURL('image/png');
      console.log('[OCR] PDFâ†’ì´ë¯¸ì§€ ë³€í™˜ ì„±ê³µ. í¬ê¸°:',cv.width,'x',cv.height);
      return {b64:dataUrl.split(',')[1], mt:'image/png', preview:dataUrl};
    }catch(pdfErr){
      // ë Œë”ë§ ì‹¤íŒ¨ â†’ PDF ì›ë³¸ base64 ì§ì ‘ ì „ì†¡ (Gemini/Claude ëª¨ë‘ PDF ì§€ì›)
      console.warn('[OCR] PDF ìº”ë²„ìŠ¤ ë Œë”ë§ ì‹¤íŒ¨, ì›ë³¸ PDF ì „ì†¡:',pdfErr.message);
      return new Promise(function(res,rej){
        var rd=new FileReader();
        rd.onload=function(ev){
          var dataUrl=ev.target.result;
          console.log('[OCR] PDF ì›ë³¸ base64 ì „ì†¡. size:',file.size);
          res({b64:dataUrl.split(',')[1], mt:'application/pdf', preview:null});
        };
        rd.onerror=function(){rej(new Error('PDF íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'))};
        rd.readAsDataURL(file);
      });
    }
  }else{
    // ì´ë¯¸ì§€ â†’ base64
    return new Promise((res,rej)=>{
      const rd=new FileReader();
      rd.onload=ev=>{
        const dataUrl=ev.target.result;
        console.log('[OCR] ì´ë¯¸ì§€ ì½ê¸° ì„±ê³µ. type:',file.type);
        res({b64:dataUrl.split(',')[1], mt:file.type||'image/png', preview:dataUrl});
      };
      rd.onerror=()=>rej(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
      rd.readAsDataURL(file);
    });
  }
}

// ë©€í‹°í˜ì´ì§€ PDF â†’ 1ì¥ ì´ë¯¸ì§€ ë³‘í•© (í˜ì´ì§€ êµ¬ë¶„ì„ +ë²ˆí˜¸ í¬í•¨)
async function fileToBase64All(file){
  const isPDF=file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  if(!isPDF||!window.pdfjsLib)return fileToBase64(file);
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf,cMapUrl:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',cMapPacked:true}).promise;
  if(pdf.numPages===1)return fileToBase64(file);
  // ë©€í‹°í˜ì´ì§€: ëª¨ë“  í˜ì´ì§€ë¥¼ í•˜ë‚˜ì˜ ì„¸ë¡œ ì´ë¯¸ì§€ë¡œ ë³‘í•©
  const cvs=[];let totalH=0,maxW=0;const sc=2;const SEP=60;
  for(let i=1;i<=pdf.numPages;i++){
    const pg=await pdf.getPage(i);const vp=pg.getViewport({scale:sc});
    const cv=document.createElement('canvas');cv.width=vp.width;cv.height=vp.height;
    await Promise.race([
      pg.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise,
      new Promise(function(_,rj){setTimeout(function(){rj(new Error('PDF page render timeout'))},20000)})
    ]);
    cvs.push(cv);totalH+=vp.height+(i<pdf.numPages?SEP:0);maxW=Math.max(maxW,vp.width);
  }
  const merged=document.createElement('canvas');merged.width=maxW;merged.height=totalH;
  const ctx=merged.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,maxW,totalH);
  let y=0;
  cvs.forEach(function(cv,idx){
    if(idx>0){
      // í˜ì´ì§€ êµ¬ë¶„ì„  + ë²ˆí˜¸
      ctx.fillStyle='#ff0000';ctx.fillRect(0,y,maxW,3);y+=5;
      ctx.font='bold 28px sans-serif';ctx.fillStyle='#ff0000';
      ctx.fillText('===== PAGE '+(idx+1)+' / '+cvs.length+' =====',20,y+25);
      y+=SEP-8;
    }
    ctx.drawImage(cv,0,y);y+=cv.height;
  });
  const du=merged.toDataURL('image/png');
  console.log('[OCR] Multi-page merged. Pages:',pdf.numPages,'Size:',maxW+'x'+totalH);
  return{b64:du.split(',')[1],mt:'image/png',preview:du};
}

// ìŠ¤ë§ˆíŠ¸ OCR í”„ë¡¬í”„íŠ¸ (ê¸‰ì—¬ëŒ€ì¥/ì†Œë“ì„¸/ì§€ë°©ì„¸/ê¸°íƒ€ì†Œë“/4ëŒ€ë³´í—˜ ìë™ ì‹ë³„)
const SMART_PROMPT=`ê¸‰ì—¬/ì„¸ê¸ˆ ê´€ë ¨ ë¬¸ì„œë¥¼ ìë™ ì‹ë³„í•˜ê³  ë¶„ì„. JSONë§Œ ë°˜í™˜.

[A] ê¸‰ì—¬ëŒ€ì¥ (ì§ì›ë³„ ê¸‰ì—¬ í…Œì´ë¸”: ì„±ëª…,ê¸°ë³¸ê¸‰,ì‹ëŒ€,ê±´ê°•ë³´í—˜,ê³ ìš©ë³´í—˜,ì‚°ì¬ë³´í—˜,ì†Œë“ì„¸,ì§€ë°©ì†Œë“ì„¸,ê³µì œí•©ê³„,ê¸‰ì—¬í•©ê³„,ì°¨ì¸ì§€ê¸‰ì•¡):
{"docType":"payroll","staff":[{"name":"ì„±ëª…","salary":ê¸‰ì—¬í•©ê³„,"type":"4ëŒ€ë³´í—˜","ded":ê³µì œí•©ê³„,"net":ì°¨ì¸ì§€ê¸‰ì•¡}],"insurance":{"health":ê±´ê°•ë³´í—˜í•©ê³„,"employ":ê³ ìš©ë³´í—˜í•©ê³„,"injury":ì‚°ì¬ë³´í—˜í•©ê³„,"total":í•©ê³„},"tax":{"i1":ì†Œë“ì„¸í•©ê³„,"loc":ì§€ë°©ì†Œë“ì„¸í•©ê³„,"total":í•©ê³„},"laborTotal":ì°¨ì¸ì§€ê¸‰í•©ê³„}

[B] ì†Œë“ì„¸ ë‚©ë¶€ì„œ (êµ­ì„¸ì²­ ê³ ì§€ì„œ, ë‚©ë¶€ê¸ˆì•¡ ìˆìŒ. ì—¬ëŸ¬ì¥ì´ë©´ ê°ê°):
{"docType":"income_tax","items":[{"label":"ê·¼ë¡œì†Œë“ì„¸(ê°‘)","amount":39690}],"total":ë‚©ë¶€í•©ê³„}

[C] ì§€ë°©ì„¸ ë‚©ë¶€ì„œ (ì§€ë°©ì†Œë“ì„¸ íŠ¹ë³„ì§•ìˆ˜):
{"docType":"local_tax","amount":ë‚©ë¶€ê¸ˆì•¡,"label":"ì§€ë°©ì†Œë“ì„¸(íŠ¹ë³„ì§•ìˆ˜)"}

[D] ê¸°íƒ€ì†Œë“ ì›ì²œì§•ìˆ˜ (3.3% í”„ë¦¬ëœì„œ: ì„±ëª…,ì§€ê¸‰ì•¡,ì†Œë“ì„¸,ì§€ë°©ì†Œë“ì„¸,ì°¨ì¸ì§€ê¸‰ì•¡):
{"docType":"freelance","staff":[{"name":"ì„±ëª…","salary":ì§€ê¸‰ì•¡,"type":"3.3%","ded":ì†Œë“ì„¸+ì§€ë°©ì†Œë“ì„¸,"net":ì°¨ì¸ì§€ê¸‰ì•¡}],"tax":{"i1":ì†Œë“ì„¸í•©ê³„,"loc":ì§€ë°©ì†Œë“ì„¸í•©ê³„,"total":í•©ê³„},"laborTotal":ì°¨ì¸ì§€ê¸‰í•©ê³„}

[E] 4ëŒ€ë³´í—˜ ê³ ì§€ì„œ:
{"docType":"insurance","items":[{"l":"ê±´ê°•ë³´í—˜","v":ê¸ˆì•¡}],"total":í•©ê³„}

ì£¼ì˜: ìˆ«ìëŠ” ì½¤ë§ˆì—†ëŠ” ì •ìˆ˜. ì´ë¦„/ê¸‰ì—¬/ë³´í—˜/ì„¸ê¸ˆ ë°˜ë“œì‹œ ì¸ì‹. ì—¬ëŸ¬í˜ì´ì§€ë©´ ëª¨ë‘ ë¶„ì„.`;

// ë¬¸ì„œìœ í˜• ë¼ë²¨
function docTypeLabel(t){return{payroll:'ê¸‰ì—¬ëŒ€ì¥',income_tax:'ì†Œë“ì„¸ ë‚©ë¶€ì„œ',local_tax:'ì§€ë°©ì„¸ ë‚©ë¶€ì„œ',freelance:'ê¸°íƒ€ì†Œë“',insurance:'4ëŒ€ë³´í—˜'}[t]||'ë¬¸ì„œ'}

// (extractPDFTextëŠ” ìƒë‹¨ì— ì •ì˜ë¨ â€” ì¤‘ë³µ ì œê±°)

// ì„¸ê¸ˆê³„ì‚°ì„œ í…ìŠ¤íŠ¸ì—ì„œ ê¸ˆì•¡ íŒŒì‹± (ì „ìì„¸ê¸ˆê³„ì‚°ì„œ í…Œì´ë¸” êµ¬ì¡° ëŒ€ì‘)
function parseInvoiceText(text){
  const t=text.replace(/\s+/g,'').replace(/,/g,'').replace(/-/g,'');
  console.log('[OCR] ì •ì œ:',t.substring(0,200));
  let supply=0,tax=0,total=0;
  // ë°©ë²•1: í‚¤ì›Œë“œ ë°”ë¡œ ë’¤ì— ìˆ«ì (ì¼ë°˜ í…ìŠ¤íŠ¸ PDF)
  const sp=t.match(/ê³µê¸‰ê°€ì•¡[:ï¼š]?[â‚©ï¿¦]?(\d{4,})/);
  if(sp)supply=parseInt(sp[1]);
  const tx=t.match(/ì„¸ì•¡[:ï¼š]?[â‚©ï¿¦]?(\d{4,})/);
  if(tx)tax=parseInt(tx[1]);
  const tot=t.match(/í•©ê³„ê¸ˆ?ì•¡?[:ï¼š]?[â‚©ï¿¦]?(\d{4,})/);
  if(tot)total=parseInt(tot[1]);
  if(supply&&tax&&!total)total=supply+tax;
  if(total&&!supply){supply=Math.round(total/1.1);tax=total-supply}
  if(supply&&!tax&&total)tax=total-supply;
  if(supply>0){console.log('[OCR] ë°©ë²•1:',{supply,tax,total});return{supply,tax,total}}
  // ë°©ë²•2: ì „ìì„¸ê¸ˆê³„ì‚°ì„œ í…Œì´ë¸” (ì…€ ê²½ê³„ ì—†ì´ ìˆ«ì í•©ì³ì§)
  // Step A: "í•©ê³„ê¸ˆì•¡" ë’¤ í•œê¸€+ìˆ«ìë¸”ë¡ì—ì„œ í•©ê³„ (í•©ê³„ê°€ 2ë²ˆ ë°˜ë³µë¨)
  const tb=t.match(/í•©ê³„ê¸ˆì•¡[ê°€-í£().]*?(\d{12,})/);
  if(tb){const d=tb[1];
    for(let l=6;l<=11;l++){const a=d.substring(0,l);
      if(d.substring(l).startsWith(a)){total=parseInt(a);console.log('[OCR] í•©ê³„:',total);break}}}
  // Step B: "ìˆ˜ì •ì‚¬ìœ " ë’¤ YYYYMMDD+supply+tax ë¶„ë¦¬
  const db=t.match(/ìˆ˜ì •ì‚¬ìœ (\d{16,})/);
  if(db&&total>0){const d=db[1];
    if(/^202\d{5}/.test(d)){const rest=d.substring(8);
      for(let l=6;l<=11;l++){const s=parseInt(rest.substring(0,l)),tx2=parseInt(rest.substring(l)||'0');
        if(s>0&&tx2>0&&tx2>s*0.05&&tx2<s*0.15&&Math.abs(s+tx2-total)<2){
          supply=s;tax=tx2;console.log('[OCR] ë°©ë²•2:',{supply,tax,total});break}}}}
  // Step C: totalë§Œ ìˆìœ¼ë©´ ì—­ì‚°
  if(total>0&&!supply){supply=Math.round(total/1.1);tax=total-supply}
  if(supply>0)return{supply,tax,total};
  // ë°©ë²•3: ìˆ«ì íœ´ë¦¬ìŠ¤í‹±
  const nums=[...t.matchAll(/\d{6,}/g)].map(m=>parseInt(m[0])).filter(n=>n>100000&&n<1e10);
  for(let i=0;i<nums.length;i++){for(let j=i+1;j<nums.length;j++){
    const sum=nums[i]+nums[j];const idx=nums.indexOf(sum);
    if(idx!==-1&&idx!==i&&idx!==j){const sm=Math.min(nums[i],nums[j]),bg=Math.max(nums[i],nums[j]);
      if(sm>bg*0.05&&sm<bg*0.15){console.log('[OCR] ë°©ë²•3:',{supply:bg,tax:sm,total:sum});return{supply:bg,tax:sm,total:sum}}}}}
  return{supply:0,tax:0,total:0};
}

async function procInv(file){
  const isPDF=file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  const ak=localStorage.getItem(AK);
  try{
    toast('ğŸ“„ íŒŒì¼ ë¶„ì„ ì¤‘...');
    const{b64,mt,preview}=await fileToBase64All(file);
    const pvEl=$('#invPv');if(pvEl){pvEl.src=preview;pvEl.style.display='block'}
    const resEl=$('#invRes');if(resEl)resEl.classList.add('show');
    const amtEl=document.getElementById('invAmt');if(amtEl)amtEl.textContent='ğŸ”„ ìŠ¤ìº” ì¤‘...';
    const sbEl=document.getElementById('invSb');if(sbEl)sbEl.textContent='';
    let supply=0,tax=0,total=0,method='';
    // PDF: í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¨¼ì € ì‹œë„ (API í‚¤ ë¶ˆí•„ìš”)
    if(isPDF&&window.pdfjsLib){
      try{
        console.log('[OCR] PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œë„...');
        const text=await extractPDFText(file);
        console.log('[OCR] ì¶”ì¶œëœ í…ìŠ¤íŠ¸:',text.substring(0,300));
        const parsed=parseInvoiceText(text);
        if(parsed.supply>0){supply=parsed.supply;tax=parsed.tax;total=parsed.total;method='PDF í…ìŠ¤íŠ¸';console.log('[OCR] PDF íŒŒì‹± ì„±ê³µ:',parsed)}
      }catch(pe){console.warn('[OCR] PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨:',pe.message)}
    }
    // Step 2: Gemini Vision API (ë¬´ë£Œ, CORS OK)
    const invPrompt='ì´ ì„¸ê¸ˆê³„ì‚°ì„œì—ì„œ ë‹¤ìŒì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”:\n1. ê³µê¸‰ê°€ì•¡\n2. ì„¸ì•¡ (ë¶€ê°€ì„¸)\n3. í•©ê³„ (ê³µê¸‰ê°€ì•¡+ì„¸ì•¡)\nJSONë§Œ ë‹µë³€: {"supply":ê³µê¸‰ê°€ì•¡ìˆ«ì,"tax":ì„¸ì•¡ìˆ«ì,"total":í•©ê³„ìˆ«ì}\nì½¤ë§ˆ/ì› ì œì™¸, ìˆ«ìë§Œ';
    if(supply===0&&localStorage.getItem(GK)){
      try{
        console.log('[OCR] Gemini Vision ì‹œë„...');
        const gtxt=await geminiOCR(b64,mt,invPrompt);
        if(gtxt){const gj=extractJSON(gtxt);
          if(gj){supply=gj.supply||0;tax=gj.tax||0;total=gj.total||0;method='Gemini'}
          if(!supply){const nums=gtxt.match(/\d{5,}/g);if(nums&&nums.length>=2){supply=parseInt(nums[0]);tax=parseInt(nums[1]);total=supply+tax;method='Gemini'}}}
      }catch(ge){console.warn('[OCR] Gemini ì‹¤íŒ¨:',ge.message)}
    }
    // Step 3: Claude API (ìœ ë£Œ ë°±ì—…)
    if(supply===0&&ak){
      try{
        console.log('[OCR] Claude API ì‹œë„...');
        const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':ak,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
          body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:500,messages:[{role:'user',content:[{type:(mt==='application/pdf'?'document':'image'),source:{type:'base64',media_type:mt,data:b64}},{type:'text',text:invPrompt}]}]})});
        if(!r.ok){const errData=await r.json().catch(()=>({}));throw new Error(errData.error?.message||'API ì˜¤ë¥˜ '+r.status)}
        const data=await r.json();const txt=data.content?.[0]?.text||'';
        const cj=extractJSON(txt);
        if(cj){supply=cj.supply||0;tax=cj.tax||0;total=cj.total||0;method='Claude'}
        if(!supply){supply=parseInt(txt.replace(/[^0-9]/g,''))||0;if(supply)method='Claude'}
      }catch(ce){console.warn('[OCR] Claude ì‹¤íŒ¨:',ce.message)}
    }
    // API í‚¤ ì—†ëŠ” ê²½ìš° ì•ˆë‚´
    const gk=localStorage.getItem(GK),ck=localStorage.getItem(AK);
    if(supply===0&&!gk&&!ck){
      showApi();toast('ğŸ”‘ API í‚¤ë¥¼ ë“±ë¡í•˜ë©´ AI OCRë¡œ ìŠ¤ìº”í•©ë‹ˆë‹¤');
      if(amtEl)amtEl.textContent='ğŸ”‘ API í‚¤ í•„ìš”';
      if(sbEl)sbEl.textContent='Gemini(ë¬´ë£Œ) ë˜ëŠ” Claude API í‚¤ë¥¼ ë“±ë¡í•˜ì„¸ìš”.';return
    }
    // ê²°ê³¼ í‘œì‹œ
    if(supply>0){
      invVal=total||supply;
      if(amtEl)amtEl.textContent='ê³µê¸‰ê°€ì•¡: â‚©'+supply.toLocaleString()+(tax?' / ì„¸ì•¡: â‚©'+tax.toLocaleString():'');
      if(sbEl)sbEl.textContent='âœ… ì¸ì‹ ì„±ê³µ ('+method+')'+(total?' í•©ê³„: â‚©'+total.toLocaleString():'');
      acI();
    }else{
      if(amtEl)amtEl.textContent='ì¸ì‹ ì‹¤íŒ¨ - ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”';
      if(sbEl)sbEl.textContent=isPDF?'PDFì—ì„œ ê¸ˆì•¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤':'AI ì¸ì‹ ì‹¤íŒ¨'}
  }catch(err){
    console.error('[OCR] ì „ì²´ ì—ëŸ¬:',err);
    const resEl=$('#invRes');if(resEl)resEl.classList.add('show');
    const amtEl=document.getElementById('invAmt');
    const sbEl=document.getElementById('invSb');
    if(amtEl)amtEl.textContent='âš ï¸ ì˜¤ë¥˜';
    if(err.message.includes('Failed to fetch')||err.message.includes('NetworkError')){
      if(sbEl)sbEl.textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ - CORS ì°¨ë‹¨ ê°€ëŠ¥. PDF íŒŒì¼ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.';
    }else if(err.message.includes('401')||err.message.includes('invalid')){
      if(sbEl)sbEl.textContent='API í‚¤ ì˜¤ë¥˜ - ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”';showApi();
    }else{
      if(sbEl)sbEl.textContent=err.message;
    }
  }
}

function apInv(){if(!invVal)return;var rev=gv('revenue');if(rev>0){sv2('commission',rev-invVal)}sv2('netRev',invVal);acI();toast('âœ… ì§€ê¸‰ì•¡ ì ìš©')}

// ì…ë ¥ë·° OCR â†’ universalOCR í†µí•©
let lab2D=null;
async function hLabOCR2(e){
  var files=Array.from(e.target.files||[]);
  if(files.length>0)universalOCR(files,'lab2');
  e.target.value='';
}
async function hLabOCRAll2(files){return universalOCR(files,'lab2')}
async function hLabOCRMulti2(files){return universalOCR(files,'lab2')}
async function procLab2(file){return universalOCR([file],'lab2')}
function apLabOCR2(){} // ë ˆê±°ì‹œ ìŠ¤í… â€” universalOCRì´ ì§ì ‘ ì ìš©

// â•â•â• EXPORT â•â•â•
function capImg(){const t=$('#capA')||$('#ct');toast('ğŸ“¸...');html2canvas(t,{backgroundColor:'#f5f3ef',scale:2,useCORS:true}).then(c=>{const a=document.createElement('a');a.download=`ì‹ ì´Œì _${Y}ë…„${M}ì›”.png`;a.href=c.toDataURL();a.click();toast('ğŸ“¸ ì €ì¥')})}
function capPDF(){const t=$('#capA')||$('#ct');toast('ğŸ“„...');html2canvas(t,{backgroundColor:'#f5f3ef',scale:2,useCORS:true}).then(c=>{const{jsPDF}=window.jspdf;const w=210,h=c.height*w/c.width;const p=new jsPDF({unit:'mm',format:[w,Math.max(h,297)]});p.addImage(c.toDataURL(),'PNG',0,0,w,h);p.save(`ì‹ ì´Œì _${Y}ë…„${M}ì›”.pdf`);toast('ğŸ“„ ì €ì¥')})}
function expXLSX(){const yd=D[Y]||{},rows=[['ì›”','ì´ë§¤ì¶œ','ìˆ˜ìˆ˜ë£Œ','ì§€ê¸‰ì•¡','ì‹ì¬ë£Œ','ì¸ê±´ë¹„','ì„ëŒ€ë£Œ','í™ìˆœìš°','ê¸°ì¥ë£Œ','ì„¸ê¸ˆ','ì´ì§€ì¶œ','ìˆ˜ìµ','ìˆ˜ìµë¥ ']];for(let m=1;m<=12;m++){if(!yd[m])continue;const c=comp(yd[m]);rows.push([m+'ì›”',c.r,c.c,c.n,c.f,c.l,c.rn,c.h,c.u,c.t,c.e,c.p,(c.rt*100).toFixed(2)+'%'])}
  const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,Y+'ë…„');XLSX.writeFile(wb,`ì‹ ì´Œì _${Y}ë…„.xlsx`);toast('ğŸ“Š ì €ì¥')}
function expJSON(){const b=new Blob([JSON.stringify({data:D,bank:BNK},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;a.click();toast('ğŸ’¾ ë°±ì—…')}
function impJSON(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const j=JSON.parse(ev.target.result);if(j.data)D=j.data;else D=j;if(j.bank)BNK=j.bank;sv();svB();rM();rV();toast('ğŸ“‚ ë³µì›')}catch(err){toast('âš ï¸ ì˜¤ë¥˜')}};r.readAsText(f);e.target.value=''}
function showApi(){$('#apiMo').classList.add('show');$('#apiIn').value=localStorage.getItem(AK)||'';$('#gemIn').value=localStorage.getItem(GK)||''}
function hideApi(){$('#apiMo').classList.remove('show')}
function saveApi(){localStorage.setItem(AK,$('#apiIn').value.trim());localStorage.setItem(GK,$('#gemIn').value.trim());hideApi();toast('ğŸ”‘ ì €ì¥')}
// Gemini Vision API (ë¬´ë£Œ, CORS OK)
async function geminiOCR(b64,mt,prompt){
  const gk=localStorage.getItem(GK);if(!gk)return null;
  console.log('[OCR] Gemini API í˜¸ì¶œ...');
  const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+gk,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts:[{inline_data:{mime_type:mt,data:b64}},{text:prompt}]}]})});
  if(!r.ok){const e=await r.json().catch(()=>({}));console.error('[OCR] Gemini ì—ëŸ¬:',e);throw new Error(e.error?.message||'Gemini ì˜¤ë¥˜ '+r.status)}
  const data=await r.json();const txt=data.candidates?.[0]?.content?.parts?.[0]?.text||'';
  console.log('[OCR] Gemini ì‘ë‹µ:',txt.substring(0,200));return txt;
}
function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

// â•â•â• Google Drive ì—°ë™ â•â•â•
const GD_CLIENT_ID='YOUR_GOOGLE_CLIENT_ID'; // ì•„ë˜ì—ì„œ ì„¤ëª…
const GD_SCOPE='https://www.googleapis.com/auth/drive.file';
const GD_FILENAME='sinchon_settlement_backup.json';
let gToken=null;

// Google OAuth í† í° ê°€ì ¸ì˜¤ê¸°
function gAuth(){
  return new Promise((resolve,reject)=>{
    // ì´ë¯¸ í† í°ì´ ìˆìœ¼ë©´
    if(gToken){resolve(gToken);return}
    const stored=localStorage.getItem('gd_token');
    const exp=localStorage.getItem('gd_token_exp');
    if(stored && exp && Date.now()<parseInt(exp)){
      gToken=stored;resolve(gToken);return
    }
    // Google Identity Services ì‚¬ìš©
    if(!window.google?.accounts?.oauth2){
      toast('âš ï¸ Google API ë¡œë”© ì¤‘...');
      reject(new Error('Google API not loaded'));return
    }
    const client=google.accounts.oauth2.initTokenClient({
      client_id:GD_CLIENT_ID,
      scope:GD_SCOPE,
      callback:(resp)=>{
        if(resp.error){reject(new Error(resp.error));return}
        gToken=resp.access_token;
        localStorage.setItem('gd_token',gToken);
        localStorage.setItem('gd_token_exp',String(Date.now()+resp.expires_in*1000));
        resolve(gToken)
      }
    });
    client.requestAccessToken()
  })
}

// ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì°¾ê¸°
async function gFindFile(token){
  const r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${GD_FILENAME}'+and+trashed=false&spaces=drive&fields=files(id,name,modifiedTime)`,{
    headers:{'Authorization':'Bearer '+token}
  });
  const data=await r.json();
  return data.files?.[0]||null
}

// êµ¬ê¸€ë“œë¼ì´ë¸Œ ì €ì¥
async function gDriveSave(){
  if(GD_CLIENT_ID==='YOUR_GOOGLE_CLIENT_ID'){
    toast('ğŸ’¡ Google ë¯¸ì„¤ì • â†’ JSON ë°±ì—…');expJSON();return
  }
  toast('â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ì €ì¥ ì¤‘...');
  try{
    const token=await gAuth();
    const backup=JSON.stringify({data:D,bank:BNK,savedAt:new Date().toISOString()},null,2);
    const existing=await gFindFile(token);
    
    if(existing){
      // ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸
      const r=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${existing.id}?uploadType=media`,{
        method:'PATCH',
        headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
        body:backup
      });
      if(!r.ok)throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
    }else{
      // ìƒˆ íŒŒì¼ ìƒì„±
      const meta={name:GD_FILENAME,mimeType:'application/json'};
      const form=new FormData();
      form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
      form.append('file',new Blob([backup],{type:'application/json'}));
      const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
        method:'POST',
        headers:{'Authorization':'Bearer '+token},
        body:form
      });
      if(!r.ok)throw new Error('ìƒì„± ì‹¤íŒ¨');
    }
    const now=new Date().toLocaleString('ko-KR');
    $('#gdStatus').textContent='âœ… '+now+' ì €ì¥';
    localStorage.setItem('gd_last_save',now);
    toast('â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ì €ì¥ ì™„ë£Œ!')
  }catch(err){
    console.error(err);
    toast('âš ï¸ '+err.message);
    // Google API ë¯¸ì„¤ì •ì‹œ ë¡œì»¬ JSON ë°±ì—…ìœ¼ë¡œ ëŒ€ì²´
    if(err.message.includes('Google API')||GD_CLIENT_ID==='YOUR_GOOGLE_CLIENT_ID'){
      toast('ğŸ’¡ Google ë¯¸ì„¤ì • â†’ JSON ë°±ì—…');expJSON()
    }
  }
}

// êµ¬ê¸€ë“œë¼ì´ë¸Œ ë³µì›
async function gDriveLoad(){
  if(GD_CLIENT_ID==='YOUR_GOOGLE_CLIENT_ID'){
    toast('ğŸ’¡ Google ë¯¸ì„¤ì • â†’ JSON ë³µì›');document.getElementById('impF').click();return
  }
  toast('â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ë³µì› ì¤‘...');
  try{
    const token=await gAuth();
    const file=await gFindFile(token);
    if(!file){toast('âš ï¸ ë°±ì—… íŒŒì¼ ì—†ìŒ');return}
    const r=await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,{
      headers:{'Authorization':'Bearer '+token}
    });
    const j=await r.json();
    if(j.data)D=j.data;else D=j;
    if(j.bank)BNK=j.bank;
    sv();svB();rM();rV();
    const saved=j.savedAt?new Date(j.savedAt).toLocaleString('ko-KR'):'';
    $('#gdStatus').textContent='ğŸ“‚ ë³µì› ì™„ë£Œ'+(saved?' ('+saved+')':'');
    toast('â˜ï¸ êµ¬ê¸€ë“œë¼ì´ë¸Œ ë³µì› ì™„ë£Œ!')
  }catch(err){
    console.error(err);
    toast('âš ï¸ '+err.message);
    if(err.message.includes('Google API')||GD_CLIENT_ID==='YOUR_GOOGLE_CLIENT_ID'){
      toast('ğŸ’¡ Google ë¯¸ì„¤ì • â†’ JSON ë³µì›');
      document.getElementById('impF').click()
    }
  }
}

// ìë™ ë°±ì—… (5ë¶„ë§ˆë‹¤ localStorage + ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„ í‘œì‹œ)
let autoSaveInterval=setInterval(()=>{
  sv();svB();
  const ls=localStorage.getItem('gd_last_save');
  if(ls)$('#gdStatus').textContent='ë§ˆì§€ë§‰ í´ë¼ìš°ë“œ: '+ls;
},300000);

// í˜ì´ì§€ ì¢…ë£Œ ì‹œ ìë™ ë¡œì»¬ ì €ì¥
window.addEventListener('beforeunload',()=>{sv();svB()});

// Google Identity Services ë¡œë“œ
(function(){
  const s=document.createElement('script');
  s.src='https://accounts.google.com/gsi/client';
  s.async=true;s.defer=true;
  document.head.appendChild(s);
})();

init();
// ì‹œì‘ ì‹œ ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„ í‘œì‹œ
setTimeout(()=>{
  const ls=localStorage.getItem('gd_last_save');
  if(ls&&$('#gdStatus'))$('#gdStatus').textContent='ë§ˆì§€ë§‰ í´ë¼ìš°ë“œ: '+ls;
},500);
</script>
</body>
</html>
